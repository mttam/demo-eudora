<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Cliente | Eudora</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Link to original styles -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Custom JavaScript Modules -->
    <script src="js/utils.js" defer></script>
    <script src="js/database.js" defer></script>
    <script src="js/sample-data.js" defer></script>
    <script src="js/test-data.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/notifications.js" defer></script>
    <script src="js/customer.js" defer></script>
    <script src="js/dashboard.js" defer></script>
    <script src="js/main.js" defer></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .customer-tab {
            position: relative;
            overflow: visible !important;
        }
        
        .map-container {
            height: 300px;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .status-preparing { 
            background-color: #fef3c7; 
            color: #92400e; 
            border-color: #fde68a; 
        }
        .status-out-for-delivery { 
            background-color: #dbeafe; 
            color: #1e40af; 
            border-color: #93c5fd; 
        }
        .status-delivered { 
            background-color: #dcfce7; 
            color: #166534; 
            border-color: #86efac; 
        }
        .status-active { 
            background-color: #dcfce7; 
            color: #166534; 
            border-color: #86efac; 
        }
        .status-offline { 
            background-color: #f3f4f6; 
            color: #374151; 
            border-color: #d1d5db; 
        }
        
        /* Order Status Borders */
        .order-card-pending {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(to right, #fef3c7 0%, #ffffff 10%);
        }
        
        .order-card-accepted {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(to right, #dbeafe 0%, #ffffff 10%);
        }
        
        .order-card-preparing {
            border-left: 4px solid #f97316;
            background: linear-gradient(to right, #fed7aa 0%, #ffffff 10%);
        }
        
        .order-card-ready {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(to right, #e9d5ff 0%, #ffffff 10%);
        }
        
        .order-card-picked_up {
            border-left: 4px solid #6366f1;
            background: linear-gradient(to right, #e0e7ff 0%, #ffffff 10%);
        }
        
        .order-card-delivered {
            border-left: 4px solid #10b981;
            background: linear-gradient(to right, #dcfce7 0%, #ffffff 10%);
        }
        
        .order-card-cancelled {
            border-left: 4px solid #ef4444;
            background: linear-gradient(to right, #fee2e2 0%, #ffffff 10%);
        }
        
        /* Map Modal Styles */
        .map-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .map-modal-content {
            background: white;
            border-radius: 0.75rem;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .map-container-modal {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            background: #f3f4f6;
        }
        
        @media (max-width: 768px) {
            .map-modal {
                padding: 0.5rem;
            }
            
            .map-container-modal {
                height: 300px;
            }
            
            .map-modal-content {
                max-height: 95vh;
            }
        }
        
        /* Custom Leaflet Icon Styles */
        .custom-div-icon {
            background: white;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .custom-div-icon i {
            margin: 0 !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .benefit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .how-to-card {
            transition: all 0.3s ease;
        }
        
        .how-to-card:hover {
            background-color: #f8fafc;
            transform: scale(1.03);
        }
        
        /* Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        
        .notification {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
            overflow: hidden;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left: 4px solid #10b981;
        }
        
        .notification.error {
            border-left: 4px solid #ef4444;
        }
        
        .notification.warning {
            border-left: 4px solid #f59e0b;
        }
        
        .notification.info {
            border-left: 4px solid #3b82f6;
        }
        
        .notification-content {
            padding: 16px;
            display: flex;
            align-items: flex-start;
        }
        
        .notification-icon {
            margin-right: 12px;
            margin-top: 2px;
        }
        
        .notification-text {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1f2937;
        }
        
        .notification-message {
            color: #6b7280;
            font-size: 14px;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .notification-close:hover {
            color: #6b7280;
            background: #f3f4f6;
        }
        
        .notification-progress {
            height: 3px;
            background: rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .notification-progress-bar {
            height: 100%;
            background: currentColor;
            width: 100%;
            transform: translateX(-100%);
            transition: transform linear;
        }
        
        .notification.success .notification-progress-bar {
            background: #10b981;
        }
        
        .notification.error .notification-progress-bar {
            background: #ef4444;
        }
        
        .notification.warning .notification-progress-bar {
            background: #f59e0b;
        }
        
        .notification.info .notification-progress-bar {
            background: #3b82f6;
        }
        
        /* Mobile Improvements for Orders */
        @media (max-width: 768px) {
            .order-card-mobile {
                margin-bottom: 1rem;
                padding: 1rem;
            }
            
            .order-filter {
                min-height: 48px; /* Touch target size */
                touch-action: manipulation;
            }
            
            .order-details-mobile {
                flex-direction: column;
                gap: 1rem;
            }
            
            .order-actions-mobile {
                width: 100%;
            }
            
            .order-actions-mobile button {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
        
        /* Touch-friendly buttons */
        .order-filter {
            transition: all 0.2s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .order-filter:active {
            transform: scale(0.98);
        }
        
        /* Cancel Order Modal Styles */
        .cancel-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001; /* Higher than map modal */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .cancel-modal-enter {
            animation: modalEnter 0.3s ease-out forwards;
        }
        
        .cancel-modal-exit {
            animation: modalExit 0.2s ease-in forwards;
        }
        
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes modalExit {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
        }
        
        /* Cancel modal content animations */
        .cancel-modal .bg-white {
            transform: scale(0.9);
            opacity: 0;
            animation: modalContentEnter 0.3s ease-out 0.1s forwards;
        }
        
        @keyframes modalContentEnter {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Focus styles for cancel modal form elements */
        .cancel-modal select:focus,
        .cancel-modal textarea:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        /* Error state for required fields */
        .cancel-modal .border-red-500 {
            animation: fieldError 0.3s ease-in-out;
        }
        
        @keyframes fieldError {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Loading Screen -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Caricamento Dashboard</div>
        <div class="loading-subtitle">Stiamo preparando i tuoi dati...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>
    
    <!-- Header -->
    <header class="bg-green-600 shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <img src="public/logo_eudora-noback.png" 
                     alt="Eudora Logo" 
                     class="h-16 md:h-20 object-contain">
            </div>
            
            <nav class="flex space-x-8 items-center px-4 py-2">
                <a href="index.html" class="hover:text-gray-200 transition text-white font-medium">Home</a>
                <a href="#" class="text-white font-medium">Dashboard</a>
            </nav>
            
            <div class="flex items-center space-x-4">
                
                <div class="hidden md:flex items-center space-x-2">
                    <span class="text-sm text-gray-200">Benvenuto,</span>
                    <span id="user-name" class="text-sm font-medium text-white"></span>
                    <span id="user-role-badge" class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Cliente</span>
                    <div id="test-data-indicator" class="hidden bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs">
                        <i class="fas fa-database mr-1"></i>
                        Dati di test caricati
                    </div>
                </div>
                
                <button onclick="logout()" 
                        class="text-gray-200 hover:text-white p-2 rounded-full hover:bg-green-700 transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4">
        <!-- User Dashboard -->
        <div id="user-dashboard" class="max-w-7xl mx-auto">
            <!-- Dashboard Navigation -->
            <div class="mb-6 md:mb-8 text-center">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-6">Dashboard Cliente</h2>
                
                <!-- Navigation Tabs -->
                <div class="flex flex-wrap justify-center gap-2 mb-4 md:mb-6">
                    <button onclick="showCustomerSection('profile')" id="tab-profile" class="customer-tab px-4 py-2 rounded-lg  transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2  text-gray-700" aria-pressed="false" role="button">
                        <i class="fas fa-user mr-2" aria-hidden="true"></i>
                        <span>Profilo</span>
                    </button>
                    <button onclick="handleShopTabClick()" id="tab-shop" class="customer-tab px-4 py-2 rounded-lg  transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-gray-700" aria-pressed="false" role="button">
                        <i class="fas fa-store mr-2" aria-hidden="true"></i>
                        <span>Negozio</span>
                    </button>
                    <button onclick="showCustomerSection('orders')" id="tab-orders" class="customer-tab px-4 py-2 rounded-lg  transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2  text-gray-700" aria-pressed="false" role="button">
                        <i class="fas fa-list-alt mr-2" aria-hidden="true"></i>
                        <span>I Miei Ordini</span>
                    </button>
                    <button onclick="showCustomerSection('cart')" id="tab-cart" class="customer-tab relative px-4 py-2 rounded-lg  transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2  text-gray-700" aria-pressed="false" role="button" style="overflow: visible !important;">
                        <i class="fas fa-shopping-cart mr-2" aria-hidden="true"></i>
                        <span>Carrello</span>
                        <span id="cart-tab-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden z-50 border border-white shadow-md">0</span>
                    </button>
                </div>
            </div>

        <!-- Profile Section -->
        <div id="customer-profile" class="customer-section">
            <!-- Content will be loaded dynamically by loadUserProfile() -->
        </div>

        <!-- Shop Section -->
        <div id="customer-shop" class="customer-section hidden">
            <!-- Search Bar and Navigation -->
            <div class="mb-6">
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="relative flex-1">
                        <input id="product-search" type="text" 
                               placeholder="Cerca farmaci, prodotti..." 
                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showPrescriptionUpload()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-camera mr-2"></i>Carica Ricetta
                        </button>
                    </div>
                </div>
                
                <!-- Advanced Filters -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-semibold text-gray-700">
                            <i class="fas fa-filter mr-2 text-blue-600"></i>Filtri Avanzati
                        </h4>
                        <button 
                            id="toggle-shop-filters"
                            onclick="toggleShopFilters()" 
                            class="text-blue-600 hover:text-blue-800 text-xs font-medium transition-colors">
                            <i class="fas fa-chevron-down mr-1"></i>Mostra Filtri
                        </button>
                    </div>
                    
                    <!-- Basic Filters (always visible) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Farmacia</label>
                            <select id="shop-pharmacy-filter" onchange="applyShopFilters()" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">Tutte le farmacie</option>
                                <option value="farmacia-centrale">Farmacia Centrale Milano</option>
                                <option value="farmacia-europa">Farmacia Europa</option>
                                <option value="farmacia-moderna">Farmacia Moderna</option>
                                <option value="farmacia-salute">Farmacia Salute</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Ordina per</label>
                            <select id="shop-sort-filter" onchange="applyShopFilters()" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="name_asc">Nome (A-Z)</option>
                                <option value="name_desc">Nome (Z-A)</option>
                                <option value="price_asc">Prezzo (più basso)</option>
                                <option value="price_desc">Prezzo (più alto)</option>
                                <option value="category">Categoria</option>
                            </select>
                        </div>
                        
                        <div class="flex items-end">
                            <button onclick="resetShopFilters()" 
                                    class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                                <i class="fas fa-undo mr-2"></i>Reset Filtri
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced Filters (collapsible) -->
                    <div id="shop-advanced-filters" class="hidden mt-4 pt-4 border-t">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Price Range Filter -->
                            <div class="space-y-3">
                                <h5 class="font-medium text-gray-700 text-sm">
                                    <i class="fas fa-euro-sign mr-2 text-green-600"></i>Range Prezzo
                                </h5>
                                <div class="space-y-2">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Prezzo Minimo (€)</label>
                                        <input type="number" id="shop-min-price" min="0" step="0.01" placeholder="0.00"
                                               onchange="applyShopFilters()"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Prezzo Massimo (€)</label>
                                        <input type="number" id="shop-max-price" min="0" step="0.01" placeholder="100.00"
                                               onchange="applyShopFilters()"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Availability Filter -->
                            <div class="space-y-3">
                                <h5 class="font-medium text-gray-700 text-sm">
                                    <i class="fas fa-check-circle mr-2 text-green-600"></i>Disponibilità
                                </h5>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="shop-in-stock" onchange="applyShopFilters()" checked
                                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-700">Solo prodotti disponibili</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="shop-prescription-required" onchange="applyShopFilters()"
                                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-700">Solo con ricetta</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="shop-on-sale" onchange="applyShopFilters()"
                                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-700">In offerta</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Filter Statistics -->
                            <div class="space-y-3">
                                <h5 class="font-medium text-gray-700 text-sm">
                                    <i class="fas fa-chart-bar mr-2 text-purple-600"></i>Risultati
                                </h5>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Prodotti trovati:</span>
                                        <span id="shop-filtered-count" class="font-semibold text-blue-600">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Prezzo medio:</span>
                                        <span id="shop-avg-price" class="font-semibold text-green-600">€0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Disponibili:</span>
                                        <span id="shop-available-count" class="font-semibold text-purple-600">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Filter Buttons -->
                        <div class="mt-4 pt-4 border-t">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm font-medium text-gray-700">Filtri Rapidi:</span>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    I filtri si applicano automaticamente
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="applyQuickFilter('low-price')" 
                                        class="quick-filter-btn px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs hover:bg-green-200 transition">
                                    <i class="fas fa-euro-sign mr-1"></i>Sotto €10
                                </button>
                                <button onclick="applyQuickFilter('mid-price')" 
                                        class="quick-filter-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs hover:bg-blue-200 transition">
                                    <i class="fas fa-euro-sign mr-1"></i>€10-50
                                </button>
                                <button onclick="applyQuickFilter('high-price')" 
                                        class="quick-filter-btn px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs hover:bg-purple-200 transition">
                                    <i class="fas fa-euro-sign mr-1"></i>Sopra €50
                                </button>
                                <button onclick="applyQuickFilter('popular')" 
                                        class="quick-filter-btn px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs hover:bg-orange-200 transition">
                                    <i class="fas fa-star mr-1"></i>Più Popolari
                                </button>
                                <button onclick="applyQuickFilter('new')" 
                                        class="quick-filter-btn px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs hover:bg-red-200 transition">
                                    <i class="fas fa-sparkles mr-1"></i>Novità
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Category Filters -->
                <div class="mt-4 flex flex-wrap gap-2">
                    <button onclick="filterProducts('all')" class="category-filter active px-4 py-2 rounded-full bg-blue-100 text-blue-700 text-sm hover:bg-blue-200 transition">
                        Tutti
                    </button>
                    <button onclick="filterProducts('farmaci')" class="category-filter px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm hover:bg-gray-200 transition">
                        Farmaci
                    </button>
                    <button onclick="filterProducts('salute')" class="category-filter px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm hover:bg-gray-200 transition">
                        Salute
                    </button>
                    <button onclick="filterProducts('bambini')" class="category-filter px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm hover:bg-gray-200 transition">
                        Bambini
                    </button>
                    <button onclick="filterProducts('bellezza')" class="category-filter px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm hover:bg-gray-200 transition">
                        Bellezza
                    </button>
                </div>
            </div>

            <!-- Product Catalog -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Prodotti Disponibili</h3>
                <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="customer-orders" class="customer-section">
            <!-- Header with Filter Buttons and Statistics -->
            <div class="mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <!-- Filter Buttons -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">I Miei Ordini</h3>
                        <div class="flex flex-wrap gap-2">
                            <button 
                                onclick="Customer.filterOrders('all')" 
                                class="order-filter active px-4 py-2 rounded-lg bg-blue-600 text-white  transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                aria-pressed="true"
                                role="button">
                                <i class="fas fa-list mr-2" aria-hidden="true"></i>
                                <span>Tutti</span>
                            </button>
                            <button 
                                onclick="Customer.filterOrders('active')" 
                                class="order-filter px-4 py-2 rounded-lg bg-gray-100 text-gray-700  transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                aria-pressed="false"
                                role="button">
                                <i class="fas fa-clock mr-2" aria-hidden="true"></i>
                                <span>Attivi</span>
                            </button>
                            <button 
                                onclick="Customer.filterOrders('delivered')" 
                                class="order-filter px-4 py-2 rounded-lg bg-gray-100 text-gray-700  transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                aria-pressed="false"
                                role="button">
                                <i class="fas fa-check-circle mr-2" aria-hidden="true"></i>
                                <span>Consegnati</span>
                            </button>
                            <button 
                                onclick="Customer.filterOrders('cancelled')" 
                                class="order-filter px-4 py-2 rounded-lg bg-gray-100 text-gray-700  transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                aria-pressed="false"
                                role="button">
                                <i class="fas fa-times-circle mr-2" aria-hidden="true"></i>
                                <span>Annullati</span>
                            </button>
                        </div>
                    </div>

                    <!-- Quick Statistics -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800" id="stats-total">0</div>
                            <div class="text-sm text-gray-600">Totali</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="stats-active">0</div>
                            <div class="text-sm text-gray-600">In corso</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="stats-delivered">0</div>
                            <div class="text-sm text-gray-600">Consegnati</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600" id="stats-cancelled">0</div>
                            <div class="text-sm text-gray-600">Annullati</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders List -->
            <div id="orders-list" class="space-y-4">
                <!-- Orders will be loaded here -->
            </div>
        </div>

        <!-- Shopping Cart Section -->
        <div id="customer-cart" class="customer-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Cart Items -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-800">Il Mio Carrello</h3>
                            <button onclick="clearCart()" class="text-red-600 hover:text-red-800 text-sm">
                                <i class="fas fa-trash mr-1"></i>Svuota Carrello
                            </button>
                        </div>
                        
                        <div id="cart-items" class="space-y-4">
                            <!-- Cart items will be loaded here -->
                        </div>

                        <div id="empty-cart" class="text-center py-12 hidden">
                            <i class="fas fa-shopping-cart text-gray-300 text-6xl mb-4"></i>
                            <h4 class="text-lg font-medium text-gray-600 mb-2">Il tuo carrello è vuoto</h4>
                            <p class="text-gray-500 mb-6">Aggiungi prodotti dal nostro catalogo per iniziare</p>
                            <button onclick="showCustomerSection('shop')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                                Inizia a fare Shopping
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Cart Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Riepilogo Ordine</h3>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Subtotale:</span>
                                <span id="cart-subtotal">€0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Consegna:</span>
                                <span id="cart-delivery">€2.50</span>
                            </div>
                            <div class="border-t pt-3">
                                <div class="flex justify-between font-semibold text-lg">
                                    <span>Totale:</span>
                                    <span id="cart-total">€2.50</span>
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Address -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-map-marker-alt mr-1"></i>Indirizzo di Consegna
                            </label>
                            <div id="cart-delivery-address-container">
                                <!-- Addresses will be loaded dynamically -->
                                <div class="text-center py-3 bg-gray-50 border border-gray-200 rounded-lg">
                                    <p class="text-sm text-gray-600 mb-2">Caricamento indirizzi...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-credit-card mr-1"></i>Metodo di Pagamento
                            </label>
                            <div id="cart-payment-method-container">
                                <!-- Payment methods will be loaded dynamically -->
                                <div class="text-center py-3 bg-gray-50 border border-gray-200 rounded-lg">
                                    <p class="text-sm text-gray-600 mb-2">Caricamento metodi di pagamento...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Special Instructions -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Note Speciali</label>
                            <textarea id="cart-special-instructions" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                      rows="3" placeholder="Istruzioni per la consegna..."></textarea>
                        </div>

                        <button onclick="proceedToCheckout()" id="checkout-button" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-medium disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-credit-card mr-2"></i>Procedi al Pagamento
                        </button>

                        <div class="mt-4 text-center">
                            <button onclick="alert('BUTTON WORKS!'); console.warn('🚨🚨🚨 BUTTON ACTUALLY CLICKED!!! 🚨🚨🚨'); console.log('🎯 IMMEDIATE: Before handleContinueShoppingClick'); handleContinueShoppingClick(); console.log('🎯 IMMEDIATE: After handleContinueShoppingClick');" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-arrow-left mr-1"></i>Continua Shopping
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Tracking Section -->
        <div id="order-tracking" class="customer-section hidden">
            <div class="max-w-4xl mx-auto">
                <!-- Tracking content will be loaded here -->
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer id="footer" class="bg-green-600 text-gray-100 py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12">
                <div>
                    <img src="public/logo_eudora-noback.png" 
                         alt="Eudora Logo" 
                         class="h-16 object-contain mb-4">
                    <p class="mb-4">
                        Consegna di farmaci a domicilio semplice e sicura.
                    </p>
                    <div class="flex space-x-4">
                        <a href="https://www.facebook.com/people/Eudora-Pharma/61553006976233/" target="_blank" rel="noopener noreferrer" class="text-white hover:text-blue-400 text-xl">
                            <i class="fab fa-facebook"></i>
                        </a>
                        <a href="https://www.instagram.com/eudora_pharma?igsh=d2w4NzhqaWJtb3g=" target="_blank" rel="noopener noreferrer" class="text-white hover:text-blue-400 text-xl">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="https://www.linkedin.com/company/eudora-pharma/" target="_blank" rel="noopener noreferrer" class="text-white hover:text-blue-400 text-xl">
                            <i class="fab fa-linkedin"></i>
                        </a>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-bold text-white mb-2">Sede legale</h4>
                        <p class="text-gray-200 text-sm">Via Roma 10 , 87100 - Cosenza (CS)</p>
                    </div>
                </div>

                <div>
                    <h3 class="text-white font-bold text-lg mb-4">Contatti</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-phone-alt mt-1 mr-2 text-sm"></i>
                            <a href="tel:3500378569" class="hover:text-white transition">350 0378569</a>
                        </li>
                        <li class="flex items-start">
                            <i class="fab fa-whatsapp mt-1 mr-2 text-sm"></i>
                            <a href="whatsapp://send?phone=393500378569" onclick="this.href = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'whatsapp://send?phone=393500378569' : 'https://wa.me/393500378569'" target="_blank" rel="noopener noreferrer" class="hover:text-white transition">WhatsApp</a>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-envelope mt-1 mr-2 text-sm"></i>
                            <a href="mailto:Eudorabenessere@gmail.com" class="hover:text-white transition">Eudorabenessere@gmail.com</a>
                        </li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-white font-bold text-lg mb-4">Azienda</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start">
                            <a href="#hero" class="hover:text-white transition">Chi siamo?</a>
                        </li>
                        <li class="flex items-start">
                            <a href="#work-with-us" class="hover:text-white transition">Lavora con noi</a>
                        </li>
                        <li class="flex items-start">
                            <a href="#work-with-us" class="hover:text-white transition">Diventa Partner</a>
                        </li>
                        <li>
                            <a href="#" class="hover:text-white transition">Città attive</a>
                        </li>
                        <li>
                            <a href="#" class="hover:text-white transition">Missiona Futura</a>
                        </li>
                        <li>
                            <a href="#" class="hover:text-white transition">Progetto Calabria</a>
                        </li>
                    </ul>
                </div>

                

                <div>
                    <h3 class="text-white font-bold text-lg mb-4">Newsletter</h3>
                    <p class="text-gray-200 text-sm mb-4">
                        Iscriviti alla newsletter di Eudora per ricevere aggiornamenti e promozioni sul nostro servizio.
                    </p>
                    <form class="space-y-3" onsubmit="subscribeNewsletter(event)">
                        <div>
                            <input type="email" 
                                   id="newsletter-email"
                                   placeholder="La tua email" 
                                   required
                                   class="w-full px-3 py-2 bg-white text-gray-800 border border-gray-300 rounded-lg focus:outline-none focus:border-green-400 text-sm">
                        </div>
                        <div class="flex items-start space-x-2">
                            <input type="checkbox" 
                                   id="newsletter-consent"
                                   required
                                   class="mt-1 w-4 h-4 text-green-600 bg-white border-gray-300 rounded focus:ring-green-500">
                            <label for="newsletter-consent" class="text-xs text-gray-200 leading-tight">
                                *Presto il consenso al trattamento dei miei dati personali per la finalità di marketing così come riportato nell'informativa ex art. 13 GDPR
                            </label>
                        </div>
                        <button type="submit" 
                                class="w-full bg-white text-green-600 py-2 px-4 rounded-lg hover:bg-gray-100 transition duration-300 text-sm font-medium">
                            <i class="fas fa-envelope mr-2"></i>
                            Iscriviti
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="border-t border-green-500 mt-12 pt-8 text-center text-sm">
                <!-- Policy Links -->
                <div class="flex flex-wrap justify-center items-center gap-4 md:gap-6 mb-4">
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Termini e condizioni</a>
                    <span class="text-gray-400">•</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Privacy policy</a>
                    <span class="text-gray-400">•</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Cookie policy</a>
                    <span class="text-gray-400">•</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Aggiorna le tue preferenze di tracciamento</a>
                    <span class="text-gray-400">•</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Preferenze pubblicitarie</a>
                </div>
                <p>&copy; 2025 Eudora. Tutti i diritti riservati.</p>
            </div>
        </div>
    </footer>

    <!-- Floating WhatsApp Button -->
    <a href="whatsapp://send?phone=393500378569" onclick="this.href = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'whatsapp://send?phone=393500378569' : 'https://wa.me/393500378569'" target="_blank" rel="noopener noreferrer"
       class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white w-16 h-16 rounded-full flex flex-col items-center justify-center shadow-lg z-50 transition transform hover:scale-110">
        <span class="text-xs font-semibold leading-none">Info</span>
        <i class="fab fa-whatsapp text-2xl mt-1"></i>
    </a>

    <!-- Modals and dynamic content containers -->
    <div id="modal-container"></div>

    <script>
        // Sistema di notifiche personalizzato
        class DashboardNotificationManager {
            constructor() {
                this.container = document.getElementById('notification-container');
                this.notificationId = 0;
            }
            
            show(type, title, message, duration = 5000) {
                const notification = this.createNotification(type, title, message, duration);
                this.container.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                if (duration > 0) {
                    const progressBar = notification.querySelector('.notification-progress-bar');
                    if (progressBar) {
                        progressBar.style.transitionDuration = duration + 'ms';
                        setTimeout(() => {
                            progressBar.style.transform = 'translateX(0)';
                        }, 100);
                    }
                    
                    setTimeout(() => {
                        this.dismiss(notification);
                    }, duration);
                }
                
                return notification;
            }
            
            createNotification(type, title, message, duration) {
                const id = ++this.notificationId;
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.setAttribute('data-id', id);
                
                notification.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-icon">
                            <i class="${icons[type]} text-lg"></i>
                        </div>
                        <div class="notification-text">
                            <div class="notification-title">${title}</div>
                            <div class="notification-message">${message}</div>
                        </div>
                        <button class="notification-close" onclick="dashboardNotificationManager.dismiss(this.closest('.notification'))">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${duration > 0 ? '<div class="notification-progress"><div class="notification-progress-bar"></div></div>' : ''}
                `;
                
                return notification;
            }
            
            dismiss(notification) {
                if (!notification) return;
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
            
            success(title, message, duration = 5000) {
                return this.show('success', title, message, duration);
            }
            
            error(title, message, duration = 7000) {
                return this.show('error', title, message, duration);
            }
            
            warning(title, message, duration = 6000) {
                return this.show('warning', title, message, duration);
            }
            
            info(title, message, duration = 5000) {
                return this.show('info', title, message, duration);
            }
        }
        
        // Inizializza il manager delle notifiche per la dashboard
        const dashboardNotificationManager = new DashboardNotificationManager();
        
        // Rendi disponibile globalmente per compatibilità
        window.notificationManager = dashboardNotificationManager;
        
        // Loading Screen Manager
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('loading-overlay');
                this.loadingText = this.overlay.querySelector('.loading-text');
                this.loadingSubtitle = this.overlay.querySelector('.loading-subtitle');
                this.isVisible = true;
            }
            
            show(text = 'Caricamento...', subtitle = 'Attendere prego...') {
                if (this.loadingText) this.loadingText.textContent = text;
                if (this.loadingSubtitle) this.loadingSubtitle.textContent = subtitle;
                this.overlay.classList.remove('hidden');
                this.isVisible = true;
            }
            
            hide() {
                this.overlay.classList.add('hidden');
                this.isVisible = false;
            }
            
            updateText(text, subtitle) {
                if (this.loadingText) this.loadingText.textContent = text;
                if (this.loadingSubtitle) this.loadingSubtitle.textContent = subtitle;
            }
        }
        
        // Inizializza il loading manager
        const loadingManager = new LoadingManager();
        window.loadingManager = loadingManager;
        
        // Initialize customer dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Inizializza EudoraApp se non è già definito
            if (typeof window.EudoraApp === 'undefined') {
                window.EudoraApp = {
                    currentUser: null,
                    version: '2.0.0',
                    debug: true
                };
            }
            
            // Check for existing user authentication first
            console.log('🔐 Checking authentication state...');
            if (!window.EudoraApp.currentUser) {
                // Try to restore user from localStorage
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const userData = JSON.parse(savedUser);
                        window.EudoraApp.currentUser = userData;
                        console.log('✅ Restored user from localStorage:', userData.email);
                    } catch (error) {
                        console.error('❌ Error parsing saved user:', error);
                        localStorage.removeItem('currentUser');
                    }
                }
            }
            
            console.log('🚀 Initializing Customer Dashboard...');
            
            // Aspetta che tutti i moduli siano caricati
            let initializationAttempts = 0;
            const maxAttempts = 50; // 5 secondi
            
            const waitForModules = () => {
                initializationAttempts++;
                
                // Aggiorna il messaggio di loading
                loadingManager.updateText(
                    'Caricamento Moduli...', 
                    `Tentativo ${initializationAttempts}/${maxAttempts} - Caricamento componenti necessari`
                );
                
                // Controlla se tutti i moduli necessari sono caricati
                const modulesReady = typeof Database !== 'undefined' && 
                                   typeof TestData !== 'undefined' && 
                                   typeof Auth !== 'undefined' && 
                                   typeof Customer !== 'undefined' && 
                                   typeof Dashboard !== 'undefined';
                
                if (modulesReady) {
                    console.log('✅ All modules loaded, proceeding with initialization...');
                    loadingManager.updateText('Inizializzazione...', 'Configurazione dell\'applicazione in corso');
                    setTimeout(() => initializeApp(), 500);
                } else if (initializationAttempts < maxAttempts) {
                    console.log(`⏳ Waiting for modules... (${initializationAttempts}/${maxAttempts})`);
                    setTimeout(waitForModules, 100);
                } else {
                    console.error('❌ Failed to load all modules within timeout');
                    loadingManager.hide();
                    dashboardNotificationManager.error(
                        'Errore di Caricamento', 
                        'Alcuni moduli non sono stati caricati correttamente. Ricarica la pagina.'
                    );
                }
            };
            
            const initializeApp = () => {
                try {
                    // Inizializza il database
                    console.log('💾 Initializing Database...');
                    loadingManager.updateText('Inizializzazione Database...', 'Configurazione del sistema di dati');
                    Database.init();
                    
                    // Verifica che i metodi necessari esistano (solo warning, non bloccare)
                    const requiredMethods = ['getAllProducts', 'getAllUsers', 'getAllOrders', 'getCart', 'getUserAddresses', 'getUserPaymentMethods', 'getOrdersByUser'];
                    const missingMethods = requiredMethods.filter(method => typeof Database[method] !== 'function');
                    
                    if (missingMethods.length > 0) {
                        console.warn('⚠️ Missing Database methods (continuing anyway):', missingMethods);
                        dashboardNotificationManager.warning(
                            'Avviso Database', 
                            `Alcuni metodi potrebbero non essere disponibili: ${missingMethods.join(', ')}`
                        );
                        // Non fare return, continua comunque
                    }
                    
                    // Carica i dati di test
                    console.log('📊 Loading test data...');
                    loadingManager.updateText('Caricamento Dati...', 'Preparazione dei dati di test e prodotti');
                    TestData.init();
                    
                    // Check if user is logged in and is a customer
                    loadingManager.updateText('Verifica Autenticazione...', 'Controllo delle credenziali utente');
                    let currentUser = Auth.getCurrentUser();
                    if (!currentUser || (currentUser.role !== 'customer' && currentUser.userType !== 'customer')) {
                        console.log('❌ No valid customer user found, creating/loading demo user...');
                        
                        // Try to create demo user if not exists
                        let demoUser = Database.getUserByEmail('mario.rossi@email.com');
                        if (!demoUser) {
                            console.log('🎭 Creating demo customer user...');
                            try {
                                const userId = Database.createUser({
                                    email: 'mario.rossi@email.com',
                                    password: 'password123',
                                    role: 'customer',
                                    userType: 'customer',
                                    firstName: 'Mario',
                                    lastName: 'Rossi',
                                    phone: '+39 333 1234567',
                                    isActive: true
                                });
                                demoUser = Database.getUserById(userId);
                            } catch (error) {
                                console.error('❌ Error creating demo user:', error);
                            }
                        }
                        
                        if (demoUser && (demoUser.role === 'customer' || demoUser.userType === 'customer')) {
                            console.log('✅ Using demo customer user');
                            currentUser = demoUser;
                            EudoraApp.currentUser = demoUser;
                            localStorage.setItem('currentUser', JSON.stringify(demoUser));
                            dashboardNotificationManager.success(
                                'Demo Mode', 
                                'Accesso automatico come utente demo: Mario Rossi'
                            );
                        } else {
                            dashboardNotificationManager.error(
                                'Accesso Negato', 
                                'Devi essere loggato come cliente per accedere a questa pagina'
                            );
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 2000);
                            return;
                        }
                    }

                    // Set the current user in EudoraApp if not already set
                    if (!EudoraApp.currentUser) {
                        EudoraApp.currentUser = currentUser;
                        console.log('✅ Set EudoraApp.currentUser from Auth.getCurrentUser()');
                    }

                    console.log('👤 Current user:', currentUser);
                    console.log('🌍 EudoraApp.currentUser:', EudoraApp.currentUser);

                    // Update user name in header
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                    }
                    
                    // Show test data indicator if using test data
                    if (currentUser.email === 'mario.rossi@email.com') {
                        const testIndicator = document.getElementById('test-data-indicator');
                        if (testIndicator) {
                            testIndicator.classList.remove('hidden');
                        }
                    }
                    
                    // Initialize customer module
                    console.log('🛍️ Initializing Customer module...');
                    loadingManager.updateText('Inizializzazione Moduli...', 'Caricamento funzionalità cliente');
                    Customer.init();
                    
                    // Force update cart badge after customer initialization
                    setTimeout(() => {
                        if (window.updateCartBadge) {
                            updateCartBadge();
                            console.log('🛒 Cart badge updated after customer initialization');
                        }
                    }, 500);
                    
                    // Initialize dashboard
                    console.log('📊 Initializing Dashboard...');
                    loadingManager.updateText('Configurazione Dashboard...', 'Preparazione dell\'interfaccia utente');
                    Dashboard.init();
                    
                    // Carica il profilo utente di default
                    setTimeout(() => {
                        console.log('👤 Preparing dashboard initialization...');
                        
                        // Verifica che l'elemento customer-profile esista
                        const profileSection = document.getElementById('customer-profile');
                        if (!profileSection) {
                            console.error('❌ Profile section not found!');
                            dashboardNotificationManager.error(
                                'Errore Profilo', 
                                'Sezione profilo non trovata nel DOM'
                            );
                            return;
                        }
                        
                        console.log('✅ Profile section found:', profileSection);
                        
                        // Controlla se ci sono prodotti nel database
                        const products = Database.getAllProducts();
                        console.log(`📦 Found ${products.length} products in database`);
                        
                        if (products.length === 0) {
                            dashboardNotificationManager.warning(
                                'Nessun Prodotto', 
                                'Il database non contiene prodotti. Assicurati che i dati di test siano caricati correttamente.'
                            );
                        }
                        
                        // Mostra notifica di benvenuto
                        dashboardNotificationManager.success(
                            'Benvenuto!', 
                            `Ciao ${currentUser.firstName}, benvenuto nella tua dashboard!`
                        );
                        
                        // Debug: mostra informazioni sul database
                        if (EudoraApp.debug) {
                            console.log('🔍 Database debug info:');
                            console.log('- Products:', Database.getAllProducts().length);
                            console.log('- Users:', Database.getAllUsers().length);
                            console.log('- Orders:', Database.getAllOrders().length);
                            console.log('- Current user cart:', Database.getCart(currentUser.id));
                        }
                        
                        // Carica automaticamente il profilo utente e mostra la sezione profilo di default
                        console.log('🏠 Loading default profile section...');
                        
                        // DEBUG: Controlla se Customer è disponibile
                        console.log('🔍 Customer module available:', typeof Customer !== 'undefined');
                        console.log('� Customer.loadProfile available:', typeof Customer !== 'undefined' && typeof Customer.loadProfile === 'function');
                        
                        // Forza l'attivazione del tab profilo PRIMA di caricare i dati
                        console.log('🖱️ Forcing profile tab activation...');
                        
                        // Nascondi tutte le sezioni eccetto profilo
                        const profileSectionElement = document.getElementById('customer-profile');
                        const shopSectionElement = document.getElementById('customer-shop');
                        const ordersSectionElement = document.getElementById('customer-orders');
                        const cartSectionElement = document.getElementById('customer-cart');
                        
                        [shopSectionElement, ordersSectionElement, cartSectionElement].forEach(section => {
                            if (section) {
                                section.classList.add('hidden');
                            }
                        });
                        
                        // Mostra la sezione profilo
                        if (profileSectionElement) {
                            profileSectionElement.classList.remove('hidden');
                            console.log('✅ Profile section made visible');
                        } else {
                            console.error('❌ Profile section element not found!');
                        }
                        
                        // DOPO aver mostrato la sezione, carica i dati del profilo
                        if (typeof Customer !== 'undefined' && typeof Customer.loadProfile === 'function') {
                            console.log('👤 Loading user profile data...');
                            try {
                                showCustomerSection('profile')
                                Customer.loadProfile();
                                console.log('✅ Customer.loadProfile() called successfully');
                                
                                // Test pharmacy data after profile loads
                                setTimeout(() => {
                                    console.log('🧪 Running automatic pharmacy data test...');
                                    if (typeof testProductPharmacyData === 'function') {
                                        testProductPharmacyData();
                                    }
                                }, 1000);
                                
                                // Also test pharmacy filter functionality after a delay
                                setTimeout(() => {
                                    console.log('🧪 Running automatic pharmacy filter test...');
                                    if (typeof testPharmacyFilter === 'function') {
                                        testPharmacyFilter();
                                    }
                                }, 2000);
                                
                            } catch (error) {
                                console.error('❌ Error calling Customer.loadProfile():', error);
                                // Fallback: mostra un messaggio nella sezione profilo
                                if (profileSectionElement) {
                                    profileSectionElement.innerHTML = `
                                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                                            <i class="fas fa-exclamation-triangle text-yellow-500 text-3xl mb-3"></i>
                                            <h3 class="text-lg font-semibold text-yellow-800 mb-2">Profilo in Caricamento</h3>
                                            <p class="text-yellow-700 mb-4">
                                                Il profilo sta ancora caricando. Se il problema persiste, ricarica la pagina.
                                            </p>
                                            <button onclick="location.reload()" 
                                                    class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition">
                                                Ricarica Pagina
                                            </button>
                                        </div>
                                    `;
                                }
                            }
                        } else {
                            console.error('❌ Customer module or loadProfile method not available');
                            // Fallback: mostra un messaggio di errore nella sezione profilo
                            if (profileSectionElement) {
                                profileSectionElement.innerHTML = `
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                                        <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-3"></i>
                                        <h3 class="text-lg font-semibold text-red-800 mb-2">Errore Modulo Customer</h3>
                                        <p class="text-red-700 mb-4">
                                            Il modulo Customer non è stato caricato correttamente.
                                        </p>
                                        <button onclick="location.reload()" 
                                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                                            Ricarica Pagina
                                        </button>
                                    </div>
                                `;
                            }
                        }
                        
                        console.log('✅ Profile section setup completed');
                        
                        // Nascondi il loading screen con un piccolo delay per mostrare il completamento
                        setTimeout(() => {
                            loadingManager.updateText('Completamento...', 'Dashboard pronta all\'uso');
                            setTimeout(() => {
                                loadingManager.hide();
                                console.log('✅ Loading screen hidden - Dashboard ready!');
                                
                                // Initialize and hide notification badges
                                setTimeout(() => {
                                    console.log('🔔 Initializing notification badges...');
                                    
                                    // Hide main notification badge
                                    const notificationBadge = document.getElementById('notification-badge');
                                    if (notificationBadge) {
                                        notificationBadge.classList.add('hidden');
                                        notificationBadge.textContent = '0';
                                        console.log('✅ Main notification badge hidden');
                                    }
                                    
                                    // Hide cart tab notification badge initially, but update based on actual cart
                                    const cartTabCount = document.getElementById('cart-tab-count');
                                    if (cartTabCount) {
                                        // Check if there are items in cart and update badge accordingly
                                        if (window.updateCartBadge) {
                                            updateCartBadge();
                                            console.log('✅ Cart badge updated based on cart contents');
                                        } else {
                                            cartTabCount.classList.add('hidden');
                                            cartTabCount.textContent = '0';
                                            console.log('✅ Cart tab notification badge hidden (fallback)');
                                        }
                                    }
                                    
                                    console.log('🔔 All notification badges initialized and hidden');
                                }, 100);
                            }, 800);
                        }, 200);
                        
                    }, 1000); // Aumentato il delay per dare più tempo al DOM
                    
                } catch (error) {
                    console.error('❌ Error during initialization:', error);
                    loadingManager.hide();
                    dashboardNotificationManager.error(
                        'Errore di Inizializzazione', 
                        'Si è verificato un errore durante il caricamento. Ricarica la pagina.'
                    );
                }
            };
            
            // Avvia il processo di attesa e inizializzazione
            waitForModules();
        });

        function logout() {
            dashboardNotificationManager.info('Logout', 'Disconnessione in corso...');
            setTimeout(() => {
                Auth.logout();
                window.location.href = 'login.html';
            }, 1000);
        }

        // Funzioni globali per i pulsanti del template
        window.filterOrders = function(status) {
            if (typeof Customer !== 'undefined' && Customer.filterOrders) {
                Customer.filterOrders(status);
            } else {
                dashboardNotificationManager.info('Filtro Ordini', `Filtrando per stato: ${status}`);
            }
        };

        window.clearCart = function() {
            if (typeof Customer !== 'undefined' && Customer.clearCart) {
                Customer.clearCart();
            } else {
                dashboardNotificationManager.info('Carrello', 'Funzione svuota carrello non disponibile');
            }
        };

        // Funzione per cambiare sezione del dashboard - OVERRIDE Dashboard.js version
        window.showCustomerSection = function(section) {
            console.log('📋 === STARTING showCustomerSection ===');
            console.log('📋 Showing customer section:', section);
            console.log('📋 Function called at:', new Date().toISOString());
            console.log('📋 Stack trace:', new Error().stack);
            
            // DEBUG: Log current screen size and viewport
            console.log('🖥️ Screen width:', window.innerWidth);
            console.log('📱 Is mobile view:', window.innerWidth < 768);
            
            // Nascondi tutte le sezioni
            const sections = document.querySelectorAll('.customer-section');
            console.log('🔍 Found sections:', sections.length);
            sections.forEach((sec, index) => {
                console.log(`  Section ${index}: ${sec.id}, current classes:`, sec.className);
                sec.classList.add('hidden');
            });
            
            // DEBUG: Check target section before showing
            const targetSection = document.getElementById(`customer-${section}`);
            console.log('🎯 Target section:', targetSection ? targetSection.id : 'NOT FOUND');
            if (targetSection) {
                console.log('📝 Target section classes before show:', targetSection.className);
            }
            
          
            // Show target section
            if (targetSection) {
                targetSection.classList.remove('hidden');
                console.log('📝 Target section classes after show:', targetSection.className);
                console.log('✅ Section visibility changed successfully');
            } else {
                console.error('❌ Target section not found:', `customer-${section}`);
            }
           
            
            // Carica il contenuto specifico per la sezione
            console.log('🔄 Entering switch statement for section:', section);
            switch(section) {
                case 'profile':
                    console.log('👤 Processing profile case...');
                    // Refresh customer data to ensure addresses and payment methods are loaded
                    if (typeof Customer !== 'undefined' && Customer.loadData) {
                        Customer.loadData();
                    }
                    // Verifica se il profilo è già caricato per evitare ricaricamenti inutili
                    const profileSection = document.getElementById('customer-profile');
                    const isProfileEmpty = !profileSection || profileSection.innerHTML.trim() === '' || 
                                          profileSection.innerHTML.includes('Caricamento profilo...');
                    
                    if (isProfileEmpty && typeof Customer !== 'undefined' && Customer.loadProfile) {
                        console.log('🔄 Loading profile section...');
                        Customer.loadProfile();
                    } else {
                        console.log('✅ Profile already loaded, skipping reload');
                    }
                    break;
                case 'shop':
                    console.log('🛍️ Processing shop case - Loading shop section...');
                    
                    // Check if we have the required modules
                    console.log('🔍 Module availability check:');
                    console.log('  - filterProducts function:', typeof window.filterProducts);
                    console.log('  - Dashboard module:', typeof Dashboard);
                    console.log('  - Dashboard.loadProducts:', typeof Dashboard !== 'undefined' && typeof Dashboard.loadProducts);
                    
                    // Initialize filter buttons first
                    const initializeFilters = () => {
                        console.log('🔧 Initializing filter buttons...');
                        
                        // Reset all filter buttons to inactive state
                        const filterButtons = document.querySelectorAll('.category-filter');
                        console.log(`🔍 Found ${filterButtons.length} filter buttons`);
                        
                        filterButtons.forEach(btn => {
                            btn.classList.remove('active', 'bg-blue-100', 'text-blue-700');
                            btn.classList.add('bg-gray-100', 'text-gray-700');
                        });
                        
                        // Activate the "All" button
                        const allButton = document.querySelector('.category-filter[onclick*="filterProducts(\'all\')"]');
                        if (allButton) {
                            allButton.classList.add('active', 'bg-blue-100', 'text-blue-700');
                            allButton.classList.remove('bg-gray-100', 'text-gray-700');
                            console.log('✅ Activated "All" filter button:', allButton.textContent?.trim());
                        } else {
                            console.warn('⚠️ Could not find "All" filter button');
                        }
                    };
                    
                    // Load products function
                    const loadShopProducts = () => {
                        console.log('📦 Loading shop products...');
                        
                        if (typeof Dashboard !== 'undefined' && Dashboard.loadProducts) {
                            console.log('� Using Dashboard.loadProducts...');
                            try {
                                Dashboard.loadProducts('all', '');
                                console.log('✅ Dashboard.loadProducts called successfully');
                            } catch (error) {
                                console.error('❌ Error calling Dashboard.loadProducts:', error);
                                dashboardNotificationManager.error(
                                    'Errore Caricamento', 
                                    'Errore durante il caricamento dei prodotti.'
                                );
                            }
                        } else if (typeof window.filterProducts === 'function') {
                            console.log('🔄 Using window.filterProducts as fallback...');
                            try {
                                window.filterProducts('all');
                                console.log('✅ filterProducts called successfully');
                            } catch (error) {
                                console.error('❌ Error calling filterProducts:', error);
                            }
                        } else {
                            console.error('❌ No product loading function available');
                            dashboardNotificationManager.warning(
                                'Prodotti Non Disponibili', 
                                'I moduli necessari non sono caricati. Ricarica la pagina.'
                            );
                        }
                    };
                    
                    // Execute with proper timing
                    setTimeout(() => {
                        initializeFilters();
                        
                        // Update pharmacy dropdown with database data
                        if (typeof updatePharmacyDropdown === 'function') {
                            updatePharmacyDropdown();
                        }
                        
                        setTimeout(() => {
                            loadShopProducts();
                        }, 100);
                    }, 50);
                    
                    break;
                case 'orders':
                    console.log('📋 Loading orders section...');
                    console.log('🔍 DEBUG: Orders section element check:');
                    const ordersSection = document.getElementById('customer-orders');
                    if (ordersSection) {
                        console.log('  ✅ Orders section found');
                        console.log('  📝 Current classes:', ordersSection.className);
                        console.log('  📏 Current display style:', window.getComputedStyle(ordersSection).display);
                        console.log('  👁️ Current visibility:', window.getComputedStyle(ordersSection).visibility);
                        console.log('  📐 Current dimensions:', {
                            width: ordersSection.offsetWidth,
                            height: ordersSection.offsetHeight,
                            clientWidth: ordersSection.clientWidth,
                            clientHeight: ordersSection.clientHeight
                        });
                    } else {
                        console.error('  ❌ Orders section NOT found!');
                    }
                    
                    if (typeof Customer !== 'undefined' && Customer.loadOrders) {
                        Customer.loadOrders();
                    } else {
                        console.warn('⚠️ Customer.loadOrders not available');
                    }
                    break;
                case 'cart':
                    console.log('🛒 Loading cart section...');
                    // Refresh customer data to ensure addresses and payment methods are loaded
                    if (typeof Customer !== 'undefined' && Customer.loadData) {
                        Customer.loadData();
                    }
                    if (typeof Customer !== 'undefined' && Customer.updateCartDisplay) {
                        Customer.updateCartDisplay();
                    }
                    // Also ensure checkout section is updated with user's addresses and payment methods
                    setTimeout(() => {
                        if (typeof Customer !== 'undefined' && Customer.updateCartCheckoutSection) {
                            Customer.updateCartCheckoutSection();
                        }
                    }, 100);
                    break;
            }
            
            console.log('🏁 Switch statement completed for section:', section);
            
            // DEBUG: Final check after section change
            setTimeout(() => {
                console.log('🔍 FINAL CHECK - Section visibility after change:');
                const allSections = document.querySelectorAll('.customer-section');
                allSections.forEach((sec, index) => {
                    const isVisible = !sec.classList.contains('hidden');
                    const computedDisplay = window.getComputedStyle(sec).display;
                    console.log(`  Section ${sec.id}: visible=${isVisible}, display=${computedDisplay}`);
                });
                console.log('📋 === END showCustomerSection ===');
            }, 100);
        };

        window.proceedToCheckout = function() {
            if (typeof Customer !== 'undefined' && Customer.proceedToCheckout) {
                Customer.proceedToCheckout();
            } else {
                dashboardNotificationManager.info('Checkout', 'Funzione checkout non disponibile');
            }
        };

        window.showPrescriptionUpload = function() {
            dashboardNotificationManager.info('Carica Ricetta', 'Funzionalità in sviluppo - sarà disponibile nella prossima versione');
        };

        // Funzioni di supporto per il customer
        window.addToCart = function(productId, name, price, quantity = 1) {
            if (typeof Customer !== 'undefined' && Customer.addToCart) {
                Customer.addToCart(productId, name, price, quantity);
            } else {
                dashboardNotificationManager.error('Errore', 'Modulo Customer non disponibile');
            }
        };

        // Global filterProducts function to work with Dashboard module
        window.filterProducts = function(category) {
            console.log('🔍 === FILTER PRODUCTS CALLED ===');
            console.log('🎯 Filter products called with category:', category);
            console.log('📅 Timestamp:', new Date().toISOString());
            
            if (typeof Dashboard !== 'undefined' && Dashboard.loadProducts) {
                console.log('🎯 Using Dashboard.loadProducts for filtering...');
                Dashboard.loadProducts(category, '');
            } else {
                console.error('❌ Dashboard module not available for product filtering');
                dashboardNotificationManager.error('Errore', 'Modulo Dashboard non disponibile per il filtraggio');
                return;
            }
            
            // Update filter button states with detailed logging
            console.log('🎨 === UPDATING FILTER BUTTON COLORS ===');
            const filterButtons = document.querySelectorAll('.category-filter');
            console.log(`🔍 Found ${filterButtons.length} filter buttons to update`);
            
            // Reset all buttons first
            filterButtons.forEach((btn, index) => {
                console.log(`  Button ${index} BEFORE reset: "${btn.textContent?.trim()}" - classes: ${btn.className}`);
                btn.classList.remove('active', 'bg-blue-100', 'text-blue-700');
                btn.classList.add('bg-gray-100', 'text-gray-700');
                console.log(`  Button ${index} AFTER reset: classes: ${btn.className}`);
            });
            
            // Activate the clicked filter button
            const activeButton = document.querySelector(`.category-filter[onclick*="filterProducts('${category}')"]`);
            if (activeButton) {
                console.log('🎯 === ACTIVATING SELECTED BUTTON ===');
                console.log(`🎯 Found button for category "${category}": "${activeButton.textContent?.trim()}"`);
                console.log('  Button BEFORE activation - classes:', activeButton.className);
                
                activeButton.classList.add('active', 'bg-blue-100', 'text-blue-700');
                activeButton.classList.remove('bg-gray-100', 'text-gray-700');
                
                console.log('  Button AFTER activation - classes:', activeButton.className);
                console.log('✅ Button successfully activated for category:', category);
            } else {
                console.warn(`⚠️ Could not find button for category: ${category}`);
                console.log('🔍 Available filter buttons:');
                filterButtons.forEach((btn, index) => {
                    console.log(`  Button ${index}: onclick="${btn.getAttribute('onclick')}", text="${btn.textContent?.trim()}"`);
                });
            }
            
            console.log('🔍 === END FILTER PRODUCTS ===');
        };

        // ====== SHOP ADVANCED FILTERS ======
        
        // Toggle shop advanced filters visibility
        window.toggleShopFilters = function() {
            const advancedFilters = document.getElementById('shop-advanced-filters');
            const toggleButton = document.getElementById('toggle-shop-filters');
            
            if (advancedFilters && toggleButton) {
                const isHidden = advancedFilters.classList.contains('hidden');
                
                if (isHidden) {
                    advancedFilters.classList.remove('hidden');
                    toggleButton.innerHTML = '<i class="fas fa-chevron-up mr-1"></i>Nascondi Filtri';
                } else {
                    advancedFilters.classList.add('hidden');
                    toggleButton.innerHTML = '<i class="fas fa-chevron-down mr-1"></i>Mostra Filtri';
                }
            }
        };

        // Apply shop filters
        window.applyShopFilters = function() {
            console.log('🔍 Applying shop filters...');
            
            const filters = getShopFilterValues();
            console.log('📋 Current shop filters:', filters);
            
            // Get all products from database
            if (typeof Database === 'undefined' || typeof Database.getAllProducts !== 'function') {
                console.error('❌ Database not available for filtering');
                return;
            }
            
            let allProducts = Database.getAllProducts();
            console.log('📦 Total products before filtering:', allProducts.length);
            
            // Debug: Show sample products and their pharmacy info
            if (allProducts.length > 0) {
                console.log('📋 Sample products with pharmacy info:');
                allProducts.slice(0, 3).forEach((product, index) => {
                    console.log(`  ${index + 1}. "${product.name}" - Pharmacy: "${product.pharmacyName}" (ID: ${product.pharmacyId})`);
                });
            }
            
            // Apply filters
            let filteredProducts = applyProductFilters(allProducts, filters);
            console.log('📦 Products after filtering:', filteredProducts.length);
            
            // Update statistics
            updateShopStatistics(filteredProducts);
            
            // Display filtered products
            displayFilteredProducts(filteredProducts);
            
            // Show notification
            dashboardNotificationManager.info(
                'Filtri Applicati', 
                `${filteredProducts.length} prodotti trovati`
            );
        };

        // Get current shop filter values
        function getShopFilterValues() {
            const filters = {};
            
            // Pharmacy filter
            const pharmacySelect = document.getElementById('shop-pharmacy-filter');
            if (pharmacySelect && pharmacySelect.value !== 'all') {
                filters.pharmacy = pharmacySelect.value;
            }
            
            // Price range
            const minPriceInput = document.getElementById('shop-min-price');
            const maxPriceInput = document.getElementById('shop-max-price');
            if ((minPriceInput && minPriceInput.value) || (maxPriceInput && maxPriceInput.value)) {
                filters.priceRange = {
                    min: minPriceInput?.value ? parseFloat(minPriceInput.value) : 0,
                    max: maxPriceInput?.value ? parseFloat(maxPriceInput.value) : Infinity
                };
            }
            
            // Availability filters
            const inStockCheckbox = document.getElementById('shop-in-stock');
            const prescriptionCheckbox = document.getElementById('shop-prescription-required');
            const onSaleCheckbox = document.getElementById('shop-on-sale');
            
            filters.availability = {
                inStock: inStockCheckbox?.checked || false,
                prescriptionRequired: prescriptionCheckbox?.checked || false,
                onSale: onSaleCheckbox?.checked || false
            };
            
            // Sort option
            const sortSelect = document.getElementById('shop-sort-filter');
            if (sortSelect && sortSelect.value) {
                filters.sortBy = sortSelect.value;
            }
            
            // Current category from active category filter button
            const activeCategoryButton = document.querySelector('.category-filter.active');
            if (activeCategoryButton) {
                const onclick = activeCategoryButton.getAttribute('onclick');
                const match = onclick?.match(/filterProducts\('([^']+)'\)/);
                if (match && match[1] !== 'all') {
                    filters.category = match[1];
                }
            }
            
            return filters;
        }

        // Apply filters to product array
        function applyProductFilters(products, filters) {
            let filtered = [...products];
            
            // Category filter
            if (filters.category) {
                filtered = filtered.filter(product => 
                    product.category?.toLowerCase() === filters.category.toLowerCase()
                );
            }
            
            // Pharmacy filter
            if (filters.pharmacy) {
                console.log('🏥 Applying pharmacy filter:', filters.pharmacy);
                const beforeCount = filtered.length;
                
                filtered = filtered.filter(product => {
                    // Multiple matching strategies to handle different pharmacy name formats
                    const pharmacyName = product.pharmacyName || '';
                    const pharmacyField = product.pharmacy || '';
                    const pharmacyId = product.pharmacyId;
                    const filterValue = filters.pharmacy.toLowerCase();
                    
                    // Strategy 1: Exact match
                    const exactMatch = pharmacyName.toLowerCase() === filterValue || 
                                      pharmacyField.toLowerCase() === filterValue;
                    
                    // Strategy 2: Contains match
                    const containsMatch = pharmacyName.toLowerCase().includes(filterValue) ||
                                         pharmacyField.toLowerCase().includes(filterValue);
                    
                    // Strategy 3: Partial name match (for cases like "Farmacia Centrale" vs "Farmacia Centrale Milano")
                    const partialMatch = filterValue.includes(pharmacyName.toLowerCase()) ||
                                        pharmacyName.toLowerCase().includes(filterValue.replace(/\s+(milano|roma|napoli|torino)/i, ''));
                    
                    // Strategy 4: ID match
                    const idMatch = pharmacyId === filters.pharmacy || pharmacyId?.toString() === filters.pharmacy;
                    
                    // Strategy 5: Handle kebab-case values (farmacia-centrale -> Farmacia Centrale)
                    const kebabToName = filters.pharmacy.replace(/-/g, ' ')
                        .replace(/\b\w/g, l => l.toUpperCase()); // Convert to Title Case
                    const kebabMatch = pharmacyName.toLowerCase().includes(kebabToName.toLowerCase()) ||
                                      kebabToName.toLowerCase().includes(pharmacyName.toLowerCase());
                    
                    const matches = exactMatch || containsMatch || partialMatch || idMatch || kebabMatch;
                    
                    // Enhanced debug logging for first few products
                    if (beforeCount <= 10) {
                        console.log(`  Product "${product.name}":`, {
                            pharmacyName: pharmacyName,
                            pharmacy: pharmacyField,
                            pharmacyId: pharmacyId,
                            filterValue: filters.pharmacy,
                            kebabToName: kebabToName,
                            strategies: {
                                exact: exactMatch,
                                contains: containsMatch,
                                partial: partialMatch,
                                id: idMatch,
                                kebab: kebabMatch
                            },
                            finalMatch: matches
                        });
                    }
                    
                    return matches;
                });
                
                console.log(`🏥 Pharmacy filter: ${beforeCount} → ${filtered.length} products`);
            }
            
            // Price range filter
            if (filters.priceRange) {
                const { min, max } = filters.priceRange;
                filtered = filtered.filter(product => {
                    const price = parseFloat(product.price) || 0;
                    return price >= min && price <= max;
                });
            }
            
            // Availability filters
            if (filters.availability) {
                const { inStock, prescriptionRequired, onSale } = filters.availability;
                
                if (inStock) {
                    filtered = filtered.filter(product => 
                        product.stock > 0 || product.available === true
                    );
                }
                
                if (prescriptionRequired) {
                    filtered = filtered.filter(product => 
                        product.requiresPrescription === true
                    );
                }
                
                if (onSale) {
                    filtered = filtered.filter(product => 
                        product.discount > 0 || product.onSale === true
                    );
                }
            }
            
            // Sorting
            if (filters.sortBy) {
                filtered.sort((a, b) => {
                    switch (filters.sortBy) {
                        case 'name_asc':
                            return a.name.localeCompare(b.name);
                        case 'name_desc':
                            return b.name.localeCompare(a.name);
                        case 'price_asc':
                            return (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0);
                        case 'price_desc':
                            return (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0);
                        case 'category':
                            return (a.category || '').localeCompare(b.category || '');
                        default:
                            return 0;
                    }
                });
            }
            
            return filtered;
        }

        // Update shop statistics
        function updateShopStatistics(products) {
            const countElement = document.getElementById('shop-filtered-count');
            const avgPriceElement = document.getElementById('shop-avg-price');
            const availableCountElement = document.getElementById('shop-available-count');
            
            if (countElement) {
                countElement.textContent = products.length.toString();
            }
            
            if (products.length > 0) {
                const totalPrice = products.reduce((sum, product) => sum + (parseFloat(product.price) || 0), 0);
                const avgPrice = totalPrice / products.length;
                
                if (avgPriceElement) {
                    avgPriceElement.textContent = `€${avgPrice.toFixed(2)}`;
                }
                
                const availableProducts = products.filter(product => 
                    product.stock > 0 || product.available === true
                ).length;
                
                if (availableCountElement) {
                    availableCountElement.textContent = availableProducts.toString();
                }
            } else {
                if (avgPriceElement) avgPriceElement.textContent = '€0.00';
                if (availableCountElement) availableCountElement.textContent = '0';
            }
        }

        // Display filtered products
        function displayFilteredProducts(products) {
            const productGrid = document.getElementById('product-grid');
            if (!productGrid) {
                console.error('❌ Product grid not found');
                return;
            }
            
            if (products.length === 0) {
                productGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-search text-gray-300 text-6xl mb-4"></i>
                        <h4 class="text-lg font-medium text-gray-600 mb-2">Nessun prodotto trovato</h4>
                        <p class="text-gray-500 mb-6">Prova a modificare i filtri di ricerca</p>
                        <button onclick="resetShopFilters()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-undo mr-2"></i>Reset Filtri
                        </button>
                    </div>
                `;
                return;
            }
            
            // Use Dashboard module to display products if available
            if (typeof Dashboard !== 'undefined' && Dashboard.renderProducts) {
                console.log('📦 Using Dashboard.renderProducts to display filtered products');
                Dashboard.renderProducts(products);
            } else {
                console.log('📦 Using fallback product display');
                // Fallback: simple product display
                productGrid.innerHTML = products.map(product => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <div class="aspect-w-1 aspect-h-1 mb-4">
                            <img src="${product.image || 'public/base.png'}" alt="${product.name}" 
                                 class="w-full h-32 object-cover rounded-lg">
                        </div>
                        <h3 class="font-semibold text-gray-800 mb-2">${product.name}</h3>
                        <p class="text-sm text-gray-600 mb-2">${product.description || 'Prodotto farmaceutico'}</p>
                        ${product.pharmacyName ? `
                            <div class="mb-2 flex items-center text-xs text-gray-600">
                                <i class="fas fa-clinic-medical mr-1 text-blue-500"></i>
                                <span>${product.pharmacyName}</span>
                            </div>
                        ` : ''}
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold text-blue-600">€${parseFloat(product.price).toFixed(2)}</span>
                            <button onclick="addToCart('${product.id}', '${product.name}', ${product.price})" 
                                    class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition text-sm">
                                <i class="fas fa-cart-plus mr-1"></i>Aggiungi
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Quick filter applications
        window.applyQuickFilter = function(filterType) {
            console.log('⚡ Applying quick filter:', filterType);
            
            // Reset current filters first
            resetShopFilters(false); // Don't show notification
            
            switch (filterType) {
                case 'low-price':
                    document.getElementById('shop-max-price').value = '10.00';
                    break;
                case 'mid-price':
                    document.getElementById('shop-min-price').value = '10.00';
                    document.getElementById('shop-max-price').value = '50.00';
                    break;
                case 'high-price':
                    document.getElementById('shop-min-price').value = '50.00';
                    break;
                case 'popular':
                    document.getElementById('shop-sort-filter').value = 'name_asc';
                    break;
                case 'new':
                    document.getElementById('shop-sort-filter').value = 'name_desc';
                    break;
            }
            
            // Apply the filters
            applyShopFilters();
            
            // Update button states
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-500');
            });
            
            event.target.classList.add('ring-2', 'ring-blue-500');
        };

        // Reset shop filters
        window.resetShopFilters = function(showNotification = true) {
            console.log('🔄 Resetting shop filters...');
            
            // Reset pharmacy filter
            const pharmacySelect = document.getElementById('shop-pharmacy-filter');
            if (pharmacySelect) pharmacySelect.value = 'all';
            
            // Reset price filters
            const minPriceInput = document.getElementById('shop-min-price');
            const maxPriceInput = document.getElementById('shop-max-price');
            if (minPriceInput) minPriceInput.value = '';
            if (maxPriceInput) maxPriceInput.value = '';
            
            // Reset sort filter
            const sortSelect = document.getElementById('shop-sort-filter');
            if (sortSelect) sortSelect.value = 'name_asc';
            
            // Reset availability filters
            const inStockCheckbox = document.getElementById('shop-in-stock');
            const prescriptionCheckbox = document.getElementById('shop-prescription-required');
            const onSaleCheckbox = document.getElementById('shop-on-sale');
            
            if (inStockCheckbox) inStockCheckbox.checked = true;
            if (prescriptionCheckbox) prescriptionCheckbox.checked = false;
            if (onSaleCheckbox) onSaleCheckbox.checked = false;
            
            // Reset quick filter buttons
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-500');
            });
            
            // Reset category to 'all' and apply
            filterProducts('all');
            
            // Update pharmacy dropdown with fresh data
            updatePharmacyDropdown();
            
            if (showNotification) {
                dashboardNotificationManager.info('Filtri Reset', 'Tutti i filtri sono stati rimossi');
            }
        };

        // Update pharmacy dropdown with pharmacies from database
        window.updatePharmacyDropdown = function() {
            console.log('🏥 Updating pharmacy dropdown with database pharmacies...');
            
            const pharmacySelect = document.getElementById('shop-pharmacy-filter');
            if (!pharmacySelect) {
                console.warn('⚠️ Pharmacy select element not found');
                return;
            }
            
            // Get pharmacies from database
            if (typeof Database === 'undefined' || typeof Database.getUsersByRole !== 'function') {
                console.warn('⚠️ Database not available or getUsersByRole function missing');
                return;
            }
            
            try {
                const pharmacies = Database.getUsersByRole('pharmacy');
                console.log(`📋 Found ${pharmacies.length} pharmacies in database:`, pharmacies.map(p => p.businessName));
                
                // Save current selection
                const currentValue = pharmacySelect.value;
                console.log('💾 Current pharmacy filter value:', currentValue);
                
                // Clear existing options except 'all'
                pharmacySelect.innerHTML = '<option value="all">Tutte le farmacie</option>';
                
                // Add pharmacy options using actual business names as both value and text
                pharmacies.forEach(pharmacy => {
                    const option = document.createElement('option');
                    option.value = pharmacy.businessName; // Use actual business name as value
                    option.textContent = pharmacy.businessName;
                    pharmacySelect.appendChild(option);
                    console.log(`➕ Added option: value="${pharmacy.businessName}", text="${pharmacy.businessName}"`);
                });
                
                // Try to restore selection or find closest match
                let selectionRestored = false;
                if (currentValue && currentValue !== 'all') {
                    // First try exact match
                    if ([...pharmacySelect.options].some(opt => opt.value === currentValue)) {
                        pharmacySelect.value = currentValue;
                        selectionRestored = true;
                        console.log('✅ Restored exact selection:', currentValue);
                    } else {
                        // Try to find partial match
                        const partialMatch = [...pharmacySelect.options].find(opt => 
                            opt.value.toLowerCase().includes(currentValue.toLowerCase()) ||
                            currentValue.toLowerCase().includes(opt.value.toLowerCase())
                        );
                        if (partialMatch) {
                            pharmacySelect.value = partialMatch.value;
                            selectionRestored = true;
                            console.log('✅ Found partial match:', currentValue, '->', partialMatch.value);
                        }
                    }
                }
                
                if (!selectionRestored && currentValue !== 'all') {
                    console.warn('⚠️ Could not restore selection:', currentValue);
                    pharmacySelect.value = 'all';
                }
                
                console.log(`✅ Updated pharmacy dropdown with ${pharmacies.length} pharmacies`);
                console.log('🔽 Final dropdown state:', pharmacySelect.value);
                
            } catch (error) {
                console.error('❌ Error updating pharmacy dropdown:', error);
            }
        };

        // Debug function to analyze pharmacy and product relationships
        window.debugPharmacyMismatch = function() {
            console.log('🧪 === DEBUGGING PHARMACY MISMATCH ===');
            
            if (typeof Database === 'undefined') {
                console.error('❌ Database not available');
                return;
            }
            
            // Get all pharmacies
            const pharmacies = Database.getUsersByRole('pharmacy');
            console.log('🏥 Pharmacies in database:');
            pharmacies.forEach((pharmacy, index) => {
                console.log(`  ${index + 1}. ID: ${pharmacy.id}, Name: "${pharmacy.businessName}"`);
            });
            
            // Get all products and their pharmacy assignments
            const products = Database.getAllProducts();
            const pharmacyGroups = {};
            
            products.forEach(product => {
                const key = product.pharmacyName || product.pharmacy || `ID:${product.pharmacyId}` || 'UNKNOWN';
                if (!pharmacyGroups[key]) {
                    pharmacyGroups[key] = [];
                }
                pharmacyGroups[key].push(product);
            });
            
            console.log('📦 Products grouped by pharmacy:');
            Object.entries(pharmacyGroups).forEach(([pharmacyKey, productList]) => {
                console.log(`  "${pharmacyKey}": ${productList.length} products`);
                // Show sample products
                if (productList.length > 0) {
                    console.log(`    Sample: "${productList[0].name}" (ID: ${productList[0].pharmacyId})`);
                }
            });
            
            // Check current filter dropdown values
            const pharmacySelect = document.getElementById('shop-pharmacy-filter');
            if (pharmacySelect) {
                console.log('🔽 Current dropdown options:');
                [...pharmacySelect.options].forEach((option, index) => {
                    console.log(`  ${index}. value="${option.value}", text="${option.textContent}"`);
                });
                console.log(`🎯 Currently selected: "${pharmacySelect.value}"`);
            }
            
            console.log('🧪 === END DEBUGGING ===');
        };

        // Test function to check if products have pharmacy information
        window.testProductPharmacyData = function() {
            console.log('🧪 === TESTING PRODUCT PHARMACY DATA ===');
            
            if (typeof Database === 'undefined') {
                console.error('❌ Database not available');
                return;
            }
            
            const products = Database.getAllProducts();
            console.log(`📦 Found ${products.length} total products`);
            
            if (products.length === 0) {
                console.warn('⚠️ No products found - initializing sample data...');
                if (typeof SampleData !== 'undefined') {
                    SampleData.init();
                    const newProducts = Database.getAllProducts();
                    console.log(`📦 After sample data init: ${newProducts.length} products`);
                    return newProducts;
                }
                return [];
            }
            
            // Check pharmacy information
            let productsWithPharmacy = 0;
            let productsWithoutPharmacy = 0;
            const pharmacyNames = new Set();
            
            products.forEach((product, index) => {
                if (product.pharmacyName || product.pharmacyId) {
                    productsWithPharmacy++;
                    if (product.pharmacyName) {
                        pharmacyNames.add(product.pharmacyName);
                    }
                } else {
                    productsWithoutPharmacy++;
                    if (index < 3) { // Show first 3 products without pharmacy data
                        console.log(`❌ Product without pharmacy data:`, {
                            id: product.id,
                            name: product.name,
                            category: product.category
                        });
                    }
                }
            });
            
            console.log(`✅ Products with pharmacy data: ${productsWithPharmacy}`);
            console.log(`❌ Products without pharmacy data: ${productsWithoutPharmacy}`);
            console.log(`🏥 Unique pharmacies found: ${pharmacyNames.size}`);
            console.log(`📋 Pharmacy names:`, Array.from(pharmacyNames));
            
            // Sample product data
            if (products.length > 0) {
                console.log('📋 Sample product:', {
                    name: products[0].name,
                    pharmacyName: products[0].pharmacyName,
                    pharmacyId: products[0].pharmacyId,
                    category: products[0].category,
                    price: products[0].price
                });
            }
            
            console.log('🧪 === END PHARMACY DATA TEST ===');
            return products;
        };

        // Force reload products from database
        window.forceReloadProducts = function() {
            console.log('🔄 Force reloading products from database...');
            
            if (typeof Database === 'undefined') {
                console.error('❌ Database not available');
                dashboardNotificationManager.error('Errore', 'Database non disponibile');
                return;
            }
            
            // Test pharmacy data first
            const products = testProductPharmacyData();
            
            // Update pharmacy dropdown
            if (typeof updatePharmacyDropdown === 'function') {
                updatePharmacyDropdown();
            }
            
            // Reload products in current view
            if (typeof Dashboard !== 'undefined' && Dashboard.loadProducts) {
                console.log('📦 Reloading products with Dashboard.loadProducts...');
                Dashboard.loadProducts('all', '');
                dashboardNotificationManager.success('Prodotti Ricaricati', `${products.length} prodotti caricati dal database`);
            } else {
                console.warn('⚠️ Dashboard.loadProducts not available');
                dashboardNotificationManager.warning('Ricaricamento Parziale', 'Modulo Dashboard non disponibile');
            }
            
            console.log('✅ Product reload completed');
        };

        // Quick fix function for pharmacy filter issues
        window.fixPharmacyFilter = function() {
            console.log('🔧 === FIXING PHARMACY FILTER ===');
            
            // Step 1: Debug current state
            debugPharmacyMismatch();
            
            // Step 2: Update dropdown with correct values
            updatePharmacyDropdown();
            
            // Step 3: Reset to "all" and apply
            const pharmacySelect = document.getElementById('shop-pharmacy-filter');
            if (pharmacySelect) {
                pharmacySelect.value = 'all';
                console.log('🔄 Reset pharmacy filter to "all"');
            }
            
            // Step 4: Apply filters to refresh the view
            if (typeof applyShopFilters === 'function') {
                applyShopFilters();
                console.log('✅ Applied shop filters after fix');
            }
            
            console.log('🔧 === PHARMACY FILTER FIX COMPLETED ===');
        };

        // Test pharmacy filter specifically
        window.testPharmacyFilter = function(pharmacyName = null) {
            console.log('🧪 === TESTING PHARMACY FILTER ===');
            
            if (typeof Database === 'undefined') {
                console.error('❌ Database not available');
                return;
            }
            
            const products = Database.getAllProducts();
            console.log(`📦 Total products: ${products.length}`);
            
            // Show all unique pharmacy names
            const pharmacyNames = [...new Set(products.map(p => p.pharmacyName).filter(Boolean))];
            console.log('🏥 Available pharmacies:', pharmacyNames);
            
            // Test with a specific pharmacy or the first one
            const testPharmacy = pharmacyName || pharmacyNames[0];
            if (!testPharmacy) {
                console.warn('⚠️ No pharmacy names found in products');
                return;
            }
            
            console.log(`🔍 Testing filter with pharmacy: "${testPharmacy}"`);
            
            // Test the filter logic
            const filtered = products.filter(product => {
                const matches = product.pharmacyName?.toLowerCase().includes(testPharmacy.toLowerCase()) ||
                               product.pharmacy?.toLowerCase().includes(testPharmacy.toLowerCase()) ||
                               product.pharmacyId === testPharmacy ||
                               product.pharmacyName === testPharmacy;
                
                console.log(`  "${product.name}": pharmacyName="${product.pharmacyName}", matches=${matches}`);
                return matches;
            });
            
            console.log(`✅ Filter result: ${filtered.length} products match "${testPharmacy}"`);
            
            // Update the dropdown and apply the filter
            if (typeof updatePharmacyDropdown === 'function') {
                updatePharmacyDropdown();
            }
            
            // Set the dropdown value and apply filter
            const pharmacySelect = document.getElementById('shop-pharmacy-filter');
            if (pharmacySelect) {
                pharmacySelect.value = testPharmacy;
                console.log('🔧 Set dropdown to:', testPharmacy);
                applyShopFilters();
            }
            
            console.log('🧪 === END PHARMACY FILTER TEST ===');
            return filtered;
        };

        // Funzione di debug per forzare il caricamento del profilo
        window.forceLoadProfile = function() {
            console.log('🔧 Force loading profile...');
            if (typeof Customer !== 'undefined' && Customer.loadProfile) {
                Customer.loadProfile();
                dashboardNotificationManager.info('Debug', 'Profilo ricaricato manualmente');
            } else {
                dashboardNotificationManager.error('Errore', 'Funzione loadProfile non disponibile');
            }
        };

        // DEBUG: Force show orders section
        window.forceShowOrders = function() {
            console.log('🔧 FORCE SHOWING ORDERS SECTION...');
            debugOrdersSection();
            
            console.log('📋 Attempting to show orders section manually...');
            showCustomerSection('orders');
            
            setTimeout(() => {
                console.log('🔍 After manual show - checking state:');
                debugOrdersSection();
            }, 500);
        };

        // DEBUG: Test all tabs
        window.testAllTabs = function() {
            const tabs = ['profile', 'shop', 'orders', 'cart'];
            let index = 0;
            
            function testNextTab() {
                if (index < tabs.length) {
                    const tab = tabs[index];
                    console.log(`🧪 Testing tab: ${tab}`);
                    showCustomerSection(tab);
                    
                    setTimeout(() => {
                        const section = document.getElementById(`customer-${tab}`);
                        const isVisible = section && !section.classList.contains('hidden');
                        console.log(`  Result: ${tab} visible = ${isVisible}`);
                        
                        index++;
                        setTimeout(testNextTab, 1000);
                    }, 500);
                }
            }
            
            testNextTab();
        };

        // Aggiungi controllo periodico per verificare se il profilo è caricato
        window.checkProfileLoaded = function() {
            const profileSection = document.getElementById('customer-profile');
            if (profileSection && profileSection.innerHTML.trim() === '') {
                console.log('⚠️ Profile section is empty, attempting to reload...');
                if (typeof Customer !== 'undefined' && Customer.loadProfile) {
                    Customer.loadProfile();
                }
            }
        };

        // DEBUG: Function to check CSS and responsive issues
        window.debugOrdersSection = function() {
            console.log('🔍 DEBUGGING ORDERS SECTION:');
            console.log('📱 Current viewport:', {
                width: window.innerWidth,
                height: window.innerHeight,
                isMobile: window.innerWidth < 768
            });
            
            // Check all elements related to orders
            const ordersSection = document.getElementById('customer-orders');
            const ordersTab = document.getElementById('tab-orders');
            const mobileFilters = document.querySelector('.md\\:hidden .order-filter');
            const desktopFilters = document.querySelector('.hidden.md\\:block .order-filter');
            
            console.log('📋 Orders section analysis:');
            if (ordersSection) {
                const computedStyle = window.getComputedStyle(ordersSection);
                console.log('  Element found:', true);
                console.log('  Classes:', ordersSection.className);
                console.log('  Computed display:', computedStyle.display);
                console.log('  Computed visibility:', computedStyle.visibility);
                console.log('  Has hidden class:', ordersSection.classList.contains('hidden'));
                console.log('  Dimensions:', {
                    width: ordersSection.offsetWidth,
                    height: ordersSection.offsetHeight
                });
            } else {
                console.log('  ❌ Orders section NOT found');
            }
            
            console.log('🏷️ Orders tab analysis:');
            if (ordersTab) {
                const computedStyle = window.getComputedStyle(ordersTab);
                console.log('  Element found:', true);
                console.log('  Classes:', ordersTab.className);
                console.log('  Computed display:', computedStyle.display);
                console.log('  Is active:', ordersTab.classList.contains('active'));
            } else {
                console.log('  ❌ Orders tab NOT found');
            }
            
            // Check all customer sections
            console.log('📂 All customer sections:');
            const sections = document.querySelectorAll('.customer-section');
            sections.forEach((section, index) => {
                const computedStyle = window.getComputedStyle(section);
                console.log(`  ${section.id}:`, {
                    hasHidden: section.classList.contains('hidden'),
                    display: computedStyle.display,
                    visibility: computedStyle.visibility
                });
            });
        };

        // Run debug on window resize to check responsive behavior
        window.addEventListener('resize', () => {
            console.log('📏 Window resized to:', window.innerWidth + 'x' + window.innerHeight);
            setTimeout(debugOrdersSection, 100);
        });

        // Controlla ogni 3 secondi se il profilo è caricato
        setInterval(checkProfileLoaded, 3000);

        // DEBUG: Test shop functionality
        window.testShop = function() {
            console.log('🧪 === TESTING SHOP FUNCTIONALITY ===');
            
            // Check database and products
            console.log('🔍 Database check:');
            console.log('  - Database available:', typeof Database !== 'undefined');
            if (typeof Database !== 'undefined') {
                console.log('  - getAllProducts available:', typeof Database.getAllProducts === 'function');
                if (typeof Database.getAllProducts === 'function') {
                    const products = Database.getAllProducts();
                    console.log(`  - Products found: ${products.length}`);
                    if (products.length > 0) {
                        console.log('  - Sample product:', products[0]);
                    }
                }
            }
            
            // Check dashboard module
            console.log('🔍 Dashboard module check:');
            console.log('  - Dashboard available:', typeof Dashboard !== 'undefined');
            if (typeof Dashboard !== 'undefined') {
                console.log('  - loadProducts available:', typeof Dashboard.loadProducts === 'function');
            }
            
            // Check DOM elements
            console.log('🔍 DOM elements check:');
            const productGrid = document.getElementById('product-grid');
            console.log('  - Product grid found:', !!productGrid);
            const shopSection = document.getElementById('customer-shop');
            console.log('  - Shop section found:', !!shopSection);
            console.log('  - Shop section visible:', shopSection && !shopSection.classList.contains('hidden'));
            
            // Test loading products
            if (typeof Dashboard !== 'undefined' && Dashboard.loadProducts) {
                console.log('🧪 Testing Dashboard.loadProducts...');
                Dashboard.loadProducts('all', '');
            }
            
            console.log('🧪 === END SHOP TEST ===');
        };

        // DEBUG: Force load shop
        window.forceLoadShop = function() {
            console.log('🔧 Force loading shop...');
            showCustomerSection('shop');
            setTimeout(() => {
                testShop();
            }, 1000);
        };

        // Force shop loading function with comprehensive error handling
        window.forceShopLoad = function() {
            console.log('🚀 FORCE SHOP LOAD - Starting comprehensive shop initialization...');
            
            // Check if function is being called
            try {
                console.log('✅ forceShopLoad function is executing');
                
                // Check immediately available modules
                console.log('📋 Checking module availability:');
                console.log('  - Database:', typeof Database !== 'undefined' ? '✅ Available' : '❌ Not available');
                console.log('  - Dashboard:', typeof Dashboard !== 'undefined' ? '✅ Available' : '❌ Not available');
                console.log('  - Customer:', typeof Customer !== 'undefined' ? '✅ Available' : '❌ Not available');
                
                // Use a longer timeout to ensure showCustomerSection has completed
                setTimeout(() => {
                    try {
                        // Step 1: Ensure modules are available with retry mechanism
                        console.log('📋 Step 1: Checking modules after timeout...');
                        
                        let retryCount = 0;
                        const maxRetries = 5;
                        
                        const checkModulesAndProceed = () => {
                            retryCount++;
                            console.log(`🔄 Module check attempt ${retryCount}/${maxRetries}`);
                            
                            if (typeof Database === 'undefined') {
                                console.error(`❌ Database module not loaded! (attempt ${retryCount})`);
                                if (retryCount < maxRetries) {
                                    setTimeout(checkModulesAndProceed, 200);
                                    return;
                                } else {
                                    console.error('❌ Max retries reached for Database module');
                                    return;
                                }
                            }
                            
                            if (typeof Dashboard === 'undefined') {
                                console.error(`❌ Dashboard module not loaded! (attempt ${retryCount})`);
                                if (retryCount < maxRetries) {
                                    setTimeout(checkModulesAndProceed, 200);
                                    return;
                                } else {
                                    console.error('❌ Max retries reached for Dashboard module');
                                    return;
                                }
                            }
                            
                            console.log('✅ All required modules are available, proceeding...');
                            proceedWithShopLoad();
                        };
                        
                        const proceedWithShopLoad = () => {
                            // Step 2: Verify shop section is visible
                            console.log('📋 Step 2: Ensuring shop section visibility...');
                            const shopSection = document.getElementById('customer-shop');
                            if (!shopSection) {
                                console.error('❌ Shop section not found!');
                                return;
                            }
                            
                            if (shopSection.classList.contains('hidden')) {
                                console.log('⚠️ Shop section still hidden, forcing visibility...');
                                shopSection.classList.remove('hidden');
                            }
                            
                            console.log('✅ Shop section is visible');
                            
                            // Step 3: Reset and activate filter buttons
                            console.log('📋 Step 3: Setting up filter buttons...');
                            const filterButtons = document.querySelectorAll('.category-filter');
                            console.log(`Found ${filterButtons.length} filter buttons`);
                            
                            filterButtons.forEach(btn => {
                                btn.classList.remove('active', 'bg-blue-100', 'text-blue-700');
                                btn.classList.add('bg-gray-100', 'text-gray-700');
                            });
                            
                            // Activate "All" filter button
                            const allButton = document.querySelector('.category-filter[onclick*="filterProducts(\'all\')"]');
                            if (allButton) {
                                allButton.classList.add('active', 'bg-blue-100', 'text-blue-700');
                                allButton.classList.remove('bg-gray-100', 'text-gray-700');
                                console.log('✅ Activated "All" filter button');
                            } else {
                                console.warn('⚠️ "All" filter button not found');
                            }
                            
                            // Step 4: Clear search input
                            const searchInput = document.getElementById('product-search');
                            if (searchInput) {
                                searchInput.value = '';
                                console.log('✅ Cleared search input');
                            }
                            
                            // Step 5: Force load products
                            console.log('📋 Step 5: Force loading products...');
                            
                            if (Dashboard.loadProducts && typeof Dashboard.loadProducts === 'function') {
                                console.log('🔄 Calling Dashboard.loadProducts...');
                                Dashboard.loadProducts('all', '');
                                console.log('✅ Dashboard.loadProducts called successfully');
                                
                                // Multiple verification attempts
                                let verificationAttempts = 0;
                                const maxAttempts = 3;
                                
                                const verifyProducts = () => {
                                    verificationAttempts++;
                                    const productGrid = document.getElementById('product-grid');
                                    
                                    if (!productGrid) {
                                        console.error('❌ Product grid not found!');
                                        return;
                                    }
                                    
                                    const hasContent = productGrid.innerHTML.trim().length > 0 && 
                                                     !productGrid.innerHTML.includes('Caricamento') && 
                                                     !productGrid.innerHTML.includes('loading');
                                    
                                    console.log(`📋 Verification attempt ${verificationAttempts}: Product grid has content: ${hasContent}`);
                                    console.log(`📋 Product grid innerHTML length: ${productGrid.innerHTML.trim().length}`);
                                    
                                    if (!hasContent && verificationAttempts < maxAttempts) {
                                        console.log(`⏳ Waiting for products to load (attempt ${verificationAttempts}/${maxAttempts})...`);
                                        setTimeout(verifyProducts, 400);
                                        return;
                                    }
                                    
                                    if (!hasContent) {
                                        console.log('⚠️ Product grid still empty after all attempts, trying direct database approach...');
                                        
                                        // Fallback: try to render products directly
                                        const products = Database.getAllProducts();
                                        if (products && products.length > 0) {
                                            console.log(`🔄 Found ${products.length} products, attempting direct render...`);
                                            
                                            // Use Dashboard.renderProducts if available
                                            if (Dashboard.renderProducts && typeof Dashboard.renderProducts === 'function') {
                                                Dashboard.renderProducts(products);
                                                console.log('✅ Direct render with Dashboard.renderProducts completed');
                                            } else {
                                                console.log('⚠️ Dashboard.renderProducts not available, using manual fallback');
                                                // Manual fallback rendering with safer string escaping
                                                productGrid.innerHTML = products.slice(0, 12).map(product => {
                                                    // Safely escape product data
                                                    const safeName = (product.name || 'Prodotto').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                                                    const safeDescription = (product.description || 'Descrizione non disponibile').substring(0, 100);
                                                    const price = product.price || 0;
                                                    
                                                    return `
                                                        <div class="bg-white rounded-lg shadow-md p-4 transition hover:shadow-lg">
                                                            <div class="aspect-w-1 aspect-h-1 mb-4">
                                                                <div class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center">
                                                                    <i class="fas fa-pills text-blue-600 text-2xl"></i>
                                                                </div>
                                                            </div>
                                                            <h4 class="font-semibold text-gray-800 mb-2">${safeName}</h4>
                                                            <p class="text-gray-600 text-sm mb-3">${safeDescription}${safeDescription.length === 100 ? '...' : ''}</p>
                                                            <div class="flex justify-between items-center">
                                                                <span class="text-lg font-bold text-blue-600">€${price.toFixed(2)}</span>
                                                                <button onclick="addToCart(${product.id}, '${safeName}', ${price})" 
                                                                        class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                                                                    Aggiungi
                                                                </button>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('');
                                                console.log('✅ Manual fallback rendering completed');
                                            }
                                            
                                            console.log(`✅ Successfully loaded ${products.length} products`);
                                        } else {
                                            console.error('❌ No products found in database!');
                                            productGrid.innerHTML = `
                                                <div class="col-span-full text-center py-8">
                                                    <i class="fas fa-exclamation-triangle text-yellow-500 text-3xl mb-3"></i>
                                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Nessun Prodotto Disponibile</h3>
                                                    <p class="text-gray-600 mb-4">I prodotti non sono stati caricati correttamente.</p>
                                                    <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                                        Ricarica Pagina
                                                    </button>
                                                </div>
                                            `;
                                        }
                                    } else {
                                        console.log('✅ Products loaded successfully!');
                                    }
                                };
                                
                                // Start verification after a short delay
                                setTimeout(verifyProducts, 300);
                                
                            } else {
                                console.error('❌ Dashboard.loadProducts not available or not a function');
                                console.log('Dashboard object:', Dashboard);
                                console.log('Dashboard.loadProducts type:', typeof Dashboard !== 'undefined' ? typeof Dashboard.loadProducts : 'Dashboard not defined');
                                
                                // Fallback: try direct rendering
                                console.log('🔄 Attempting fallback product loading...');
                                const productGrid = document.getElementById('product-grid');
                                if (productGrid) {
                                    productGrid.innerHTML = `
                                        <div class="col-span-full text-center py-8">
                                            <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-3"></i>
                                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Errore Caricamento Prodotti</h3>
                                            <p class="text-gray-600 mb-4">Dashboard.loadProducts non disponibile.</p>
                                            <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                                Ricarica Pagina
                                            </button>
                                        </div>
                                    `;
                                }
                            }
                        };
                        
                        // Start the module checking process
                        checkModulesAndProceed();
                        
                    } catch (error) {
                        console.error('❌ Error in forceShopLoad timeout callback:', error);
                        console.error('Error stack:', error.stack);
                    }
                    
                }, 500); // Increased delay to ensure DOM is ready after section change
                
            } catch (error) {
                console.error('❌ Critical error in forceShopLoad main function:', error);
                console.error('Error stack:', error.stack);
            }
        };

        // Dedicated click handlers for better debugging
        window.handleShopTabClick = function() {
            console.log('🖱️ === SHOP TAB CLICKED ===');
            console.log('📅 Timestamp:', new Date().toISOString());
            console.log('🔧 Function availability check:');
            console.log('  - showCustomerSection:', typeof showCustomerSection);
            console.log('  - forceShopLoad:', typeof forceShopLoad);
            
            try {
                // First show the section
                console.log('📋 Step 1: Calling showCustomerSection...');
                showCustomerSection('shop');
                console.log('✅ showCustomerSection completed');
                
                // Then force load after a delay
                setTimeout(() => {
                    console.log('📋 Step 2: Calling forceShopLoad after delay...');
                    if (typeof forceShopLoad === 'function') {
                        forceShopLoad();
                        console.log('✅ forceShopLoad called successfully');
                    } else {
                        console.error('❌ forceShopLoad function not available');
                        console.log('🔍 Current window functions:', Object.keys(window).filter(key => key.includes('force') || key.includes('shop')));
                    }
                }, 200);
                
            } catch (error) {
                console.error('❌ Error in handleShopTabClick:', error);
                console.error('Error stack:', error.stack);
            }
            
            console.log('🖱️ === END SHOP TAB CLICK ===');
        };

        window.handleContinueShoppingClick = function() {
            console.log('🖱️ === CONTINUE SHOPPING CLICKED ===');
            console.log('📅 Timestamp:', new Date().toISOString());
            console.log('🔧 Function availability check:');
            console.log('  - showCustomerSection:', typeof showCustomerSection);
            console.log('  - forceShopLoad:', typeof forceShopLoad);
            
            try {
                // First show the section
                console.log('📋 Step 1: Calling showCustomerSection...');
                showCustomerSection('shop');
                console.log('✅ showCustomerSection completed');
                
                // Then force load after a delay
                setTimeout(() => {
                    console.log('📋 Step 2: Calling forceShopLoad after delay...');
                    if (typeof forceShopLoad === 'function') {
                        forceShopLoad();
                        console.log('✅ forceShopLoad called successfully');
                    } else {
                        console.error('❌ forceShopLoad function not available');
                        console.log('🔍 Current window functions:', Object.keys(window).filter(key => key.includes('force') || key.includes('shop')));
                    }
                }, 200);
                
            } catch (error) {
                console.error('❌ Error in handleContinueShoppingClick:', error);
                console.error('Error stack:', error.stack);
            }
            
            console.log('🖱️ === END CONTINUE SHOPPING CLICK ===');
        };

        // Test function availability immediately after definition
        console.log('✅ handleContinueShoppingClick defined:', typeof window.handleContinueShoppingClick === 'function');
        
        // Make sure the function is available when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 DOMContentLoaded - Function check:', typeof handleContinueShoppingClick);
        });

        // Test function to debug forceShopLoad issues
        window.testForceShopLoad = function() {
            console.log('🧪 === TESTING FORCE SHOP LOAD ===');
            console.log('Function availability:');
            console.log('  - forceShopLoad:', typeof forceShopLoad);
            console.log('  - showCustomerSection:', typeof showCustomerSection);
            console.log('  - Database:', typeof Database);
            console.log('  - Dashboard:', typeof Dashboard);
            console.log('  - Customer:', typeof Customer);
            
            if (typeof Database !== 'undefined') {
                console.log('  - Database.getAllProducts:', typeof Database.getAllProducts);
                try {
                    const products = Database.getAllProducts();
                    console.log(`  - Products in database: ${products.length}`);
                } catch (e) {
                    console.log('  - Error getting products:', e.message);
                }
            }
            
            if (typeof Dashboard !== 'undefined') {
                console.log('  - Dashboard.loadProducts:', typeof Dashboard.loadProducts);
                console.log('  - Dashboard.renderProducts:', typeof Dashboard.renderProducts);
            }
            
            console.log('DOM elements:');
            console.log('  - customer-shop:', !!document.getElementById('customer-shop'));
            console.log('  - product-grid:', !!document.getElementById('product-grid'));
            console.log('  - product-search:', !!document.getElementById('product-search'));
            
            const shopSection = document.getElementById('customer-shop');
            if (shopSection) {
                console.log('  - shop section hidden:', shopSection.classList.contains('hidden'));
            }
            
            console.log('🧪 Testing direct forceShopLoad call...');
            if (typeof forceShopLoad === 'function') {
                forceShopLoad();
            } else {
                console.error('❌ forceShopLoad is not a function!');
            }
            console.log('🧪 === END TEST ===');
        };

        // Quick diagnostic test for button issues
        window.diagnoseButtonIssue = function() {
            console.log('🔍 === DIAGNOSING BUTTON ISSUE ===');
            
            // Check 1: Function availability
            console.log('1️⃣ Function Availability Check:');
            console.log('  - handleContinueShoppingClick:', typeof handleContinueShoppingClick);
            console.log('  - handleShopTabClick:', typeof handleShopTabClick);
            console.log('  - showCustomerSection:', typeof showCustomerSection);
            
            // Check 2: Button element and event handler
            console.log('2️⃣ Button Element Check:');
            const continueButton = document.querySelector('button[onclick*="handleContinueShoppingClick"]');
            const shopTabButton = document.querySelector('button[onclick*="handleShopTabClick"]');
            
            console.log('  - Continue Shopping button found:', !!continueButton);
            console.log('  - Shop Tab button found:', !!shopTabButton);
            
            if (continueButton) {
                console.log('  - Continue button onclick attr:', continueButton.getAttribute('onclick'));
                console.log('  - Continue button onclick prop:', continueButton.onclick);
            }
            }
            
            if (shopTabButton) {
                console.log('  - Shop tab onclick attr:', shopTabButton.getAttribute('onclick'));
                console.log('  - Shop tab onclick prop:', shopTabButton.onclick);
            }
            
            // Check 3: JavaScript errors
            console.log('3️⃣ Error Check:');
            try {
                if (typeof handleContinueShoppingClick === 'function') {
                    console.log('  - Function exists, testing call...');
                    // Don't actually call it, just verify it can be accessed
                    console.log('  - Function can be accessed: ✅');
                } else {
                    console.log('  - Function does not exist: ❌');
                }
            } catch (error) {
                console.log('  - Error accessing function:', error);
            }
            
            // Check 4: Manual button click test
            console.log('4️⃣ Manual Click Test:');
            if (continueButton) {
                console.log('  - Manually triggering click event...');
                try {
                    continueButton.click();
                    console.log('  - Click triggered successfully');
                } catch (error) {
                    console.log('  - Error during click:', error);
                }
            }
            
            console.log('🔍 === END DIAGNOSIS ===');
        

        // Quick test function to verify forceShopLoad is working
        window.testShopLoad = function() {
            console.log('🧪 === TESTING SHOP LOAD FUNCTIONALITY ===');
            console.log('📅 Test started at:', new Date().toISOString());
            
            // Test function availability
            console.log('🔧 Function availability:');
            console.log('  - showCustomerSection:', typeof showCustomerSection, showCustomerSection ? '✅' : '❌');
            console.log('  - forceShopLoad:', typeof forceShopLoad, forceShopLoad ? '✅' : '❌');
            console.log('  - Database:', typeof Database, Database ? '✅' : '❌');
            console.log('  - Dashboard:', typeof Dashboard, Dashboard ? '✅' : '❌');
            
            if (typeof Database !== 'undefined') {
                try {
                    const products = Database.getAllProducts();
                    console.log(`📦 Database products: ${products.length}`);
                } catch (e) {
                    console.log('❌ Error getting products:', e.message);
                }
            }
            
            if (typeof Dashboard !== 'undefined') {
                console.log('  - Dashboard.loadProducts:', typeof Dashboard.loadProducts, Dashboard.loadProducts ? '✅' : '❌');
            }
            
            // Test DOM elements
            console.log('🖼️ DOM elements:');
            const shopSection = document.getElementById('customer-shop');
            const productGrid = document.getElementById('product-grid');
            console.log('  - customer-shop:', shopSection ? '✅' : '❌');
            console.log('  - product-grid:', productGrid ? '✅' : '❌');
            
            if (shopSection) {
                console.log('  - shop section hidden:', shopSection.classList.contains('hidden'));
            }
            
            // Test the complete flow
            console.log('🧪 Testing complete flow...');
            try {
                handleShopTabClick();
                console.log('✅ handleShopTabClick executed without errors');
            } catch (error) {
                console.error('❌ Error in handleShopTabClick:', error);
            }
            
            console.log('🧪 === END TEST ===');
        };

        // Global functions for product management
        window.filterProducts = function(category) {
            console.log('🔍 Filtering products by category:', category);
            
            // Update active category button
            document.querySelectorAll('.category-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-100', 'text-blue-700');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            // Set active state for the appropriate button
            let targetButton = null;
            
            // If event exists and has target, use it
            if (typeof event !== 'undefined' && event && event.target) {
                targetButton = event.target;
            } else {
                // Find the button that corresponds to this category
                const categoryButtonMap = {
                    'all': 'filterProducts(\'all\')',
                    'farmaci': 'filterProducts(\'farmaci\')',
                    'salute': 'filterProducts(\'salute\')',
                    'bambini': 'filterProducts(\'bambini\')',
                    'bellezza': 'filterProducts(\'bellezza\')'
                };
                
                if (categoryButtonMap[category]) {
                    targetButton = document.querySelector(`.category-filter[onclick*="${categoryButtonMap[category]}"]`);
                }
            }
            
            if (targetButton) {
                targetButton.classList.add('active', 'bg-blue-100', 'text-blue-700');
                targetButton.classList.remove('bg-gray-100', 'text-gray-700');
                console.log('✅ Filter button activated:', targetButton.textContent?.trim());
            } else {
                console.warn('⚠️ Could not find target button for category:', category);
                // Fallback: activate button by text content for 'all' category
                if (category === 'all') {
                    const allButtons = document.querySelectorAll('.category-filter');
                    for (let btn of allButtons) {
                        const text = btn.textContent?.trim().toLowerCase();
                        if (text === 'tutti' || text === 'all') {
                            btn.classList.add('active', 'bg-blue-100', 'text-blue-700');
                            btn.classList.remove('bg-gray-100', 'text-gray-700');
                            console.log('✅ Fallback: activated "All" button by text content');
                            break;
                        }
                    }
                }
            }
            
            // Map frontend categories to database categories
            const categoryMap = {
                'all': 'all',
                'farmaci': ['analgesici', 'antibiotici'],
                'salute': ['vitamine', 'medicazioni'],
                'bambini': ['bambini'],
                'bellezza': ['cosmetica']
            };
            
            // Load filtered products
            if (typeof Dashboard !== 'undefined' && Dashboard.loadProducts) {
                const searchTerm = document.getElementById('product-search')?.value || '';
                console.log('📦 Loading products with Dashboard.loadProducts...');
                Dashboard.loadProducts(category, searchTerm);
                console.log('✅ Products loaded for category:', category);
            } else {
                console.error('❌ Dashboard.loadProducts not available');
                dashboardNotificationManager.warning(
                    'Filtro Prodotti', 
                    'Modulo Dashboard non disponibile. Ricarica la pagina.'
                );
            }
        };

        window.searchProducts = function() {
            const searchTerm = document.getElementById('product-search')?.value || '';
            console.log('🔍 Searching products with term:', searchTerm);
            
            // Get current active category
            const activeCategory = document.querySelector('.category-filter.active');
            const category = activeCategory ? activeCategory.textContent.toLowerCase() : 'all';
            const categoryMap = {
                'tutti': 'all',
                'farmaci': 'farmaci',
                'salute': 'salute',
                'bambini': 'bambini',
                'bellezza': 'bellezza'
            };
            
            if (typeof Dashboard !== 'undefined' && Dashboard.loadProducts) {
                Dashboard.loadProducts(categoryMap[category] || 'all', searchTerm);
            }
        };

        // Add search event listener
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('product-search');
            if (searchInput) {
                // Add real-time search with debounce
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchProducts();
                    }, 500); // Wait 500ms after user stops typing
                });
                
                // Add search on Enter key
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchProducts();
                    }
                });
            }
        });

        // ====== NOTIFICATION BADGE MANAGEMENT ======
        
        // Function to set notification badge count
        window.setNotificationBadge = function(count = 0, show = false) {
            console.log(`🔔 Setting notification badge: count=${count}, show=${show}`);
            
            const notificationBadge = document.getElementById('notification-badge');
            if (notificationBadge) {
                notificationBadge.textContent = count.toString();
                
                if (show && count > 0) {
                    notificationBadge.classList.remove('hidden');
                    console.log(`✅ Notification badge shown with count: ${count}`);
                } else {
                    notificationBadge.classList.add('hidden');
                    console.log('✅ Notification badge hidden');
                }
            }
        };

        // Function to set cart tab badge count
        window.setCartBadge = function(count = 0, show = false) {
            console.log(`🛒 Setting cart badge: count=${count}, show=${show}`);
            
            const cartTabCount = document.getElementById('cart-tab-count');
            if (cartTabCount) {
                cartTabCount.textContent = count.toString();
                
                // Always show badge when count > 0, regardless of show parameter
                if (count > 0) {
                    cartTabCount.classList.remove('hidden');
                    console.log(`✅ Cart badge shown with count: ${count}`);
                } else {
                    cartTabCount.classList.add('hidden');
                    console.log('✅ Cart badge hidden (count is 0)');
                }
            }
            
            // Also trigger notification system update
            if (window.updateCartBadge) {
                setTimeout(() => updateCartBadge(), 100);
            }
        };

        // Function to hide all notification badges
        window.hideAllNotificationBadges = function() {
            console.log('🔔 Hiding all notification badges...');
            setNotificationBadge(0, false);
            setCartBadge(0, false);
            console.log('✅ All notification badges hidden');
        };

        // Function to debug notification badges
        window.debugNotificationBadges = function() {
            console.log('🔍 === DEBUGGING ALL NOTIFICATION BADGES ===');
            
            const notificationBadge = document.getElementById('notification-badge');
            const cartTabCount = document.getElementById('cart-tab-count');
            
            if (notificationBadge) {
                console.log('🔔 Main notification badge:');
                console.log('  - Classes:', notificationBadge.className);
                console.log('  - Text:', notificationBadge.textContent);
                console.log('  - Hidden:', notificationBadge.classList.contains('hidden'));
                console.log('  - Display:', window.getComputedStyle(notificationBadge).display);
            }
            
            if (cartTabCount) {
                console.log('🛒 Cart tab badge:');
                console.log('  - Classes:', cartTabCount.className);
                console.log('  - Text:', cartTabCount.textContent);
                console.log('  - Hidden:', cartTabCount.classList.contains('hidden'));
                console.log('  - Display:', window.getComputedStyle(cartTabCount).display);
            }
            
            console.log('🔍 === END DEBUGGING NOTIFICATION BADGES ===');
        };

        // Test function to show notification badges
        window.testNotificationBadges = function() {
            console.log('🔔 Testing notification badge visibility...');
            
            // Show notification badge with count
            const notificationBadge = document.getElementById('notification-badge');
            if (notificationBadge) {
                notificationBadge.classList.remove('hidden');
                notificationBadge.textContent = '5';
                console.log('✅ Notification badge shown with count: 5');
            }
            
            // Show cart badge with count
            const cartTabCount = document.getElementById('cart-tab-count');
            if (cartTabCount) {
                cartTabCount.classList.remove('hidden');
                cartTabCount.textContent = '3';
                console.log('✅ Cart badge shown with count: 3');
            }
            
            console.log('🔔 Both badges should now be visible. Check if they are cut off.');
            console.log('💡 To hide them again, run: hideAllNotificationBadges()');
        };
    </script>
</body>
</html>
