<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Rider | Eudora</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Link to original styles -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Custom JavaScript Modules -->
    <script src="js/utils.js" defer></script>
    <script src="js/database.js" defer></script>
    <script src="js/sample-data.js" defer></script>
    <script src="js/test-data.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/notifications.js" defer></script>
    <script src="js/rider.js" defer></script>
    <script src="js/dashboard.js" defer></script>
    <script src="js/main.js" defer></script>
    <script src="js/rider-tests.js" defer></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .rider-tab {
            position: relative;
            overflow: visible !important;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .rider-tab:hover {
            color: #3b82f6 !important;
        }

        /* Tab attivo: blu con testo bianco */
        .rider-tab.active-tab {
            background-color: #2563eb !important; /* blue-600 */
            color: #fff !important;
            border-bottom: 2px solid #2563eb !important;
            box-shadow: 0 2px 8px rgba(37,99,235,0.08);
            z-index: 1;
        }

        /* Ensure notification badges are never clipped */
        .rider-tab.relative {
            overflow: visible !important;
            position: relative;
            z-index: 10;
        }

        /* Navigation tabs container anti-clipping rules */
        .rider-tab .absolute {
            z-index: 999 !important;
            transform: translateZ(0);
            will-change: transform;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* Dashboard and notification styles */
        .hidden {
            display: none !important;
        }
        
        .map-container {
            height: 300px;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        /* Order Status Styles */
        .status-ready { 
            background-color: #dbeafe; 
            color: #1e40af; 
            border-color: #93c5fd; 
        }
        .status-picked_up { 
            background-color: #fef3c7; 
            color: #92400e; 
            border-color: #fde68a; 
        }
        .status-out_for_delivery { 
            background-color: #e0e7ff; 
            color: #3730a3; 
            border-color: #c7d2fe; 
        }
        .status-delivered { 
            background-color: #dcfce7; 
            color: #166534; 
            border-color: #86efac; 
        }
        .status-cancelled { 
            background-color: #fee2e2; 
            color: #991b1b; 
            border-color: #fca5a5; 
        }
        
        /* Order Card Borders */
        .order-card-ready {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(to right, #dbeafe 0%, #ffffff 10%);
        }
        
        .order-card-picked_up {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(to right, #fef3c7 0%, #ffffff 10%);
        }
        
        .order-card-out_for_delivery {
            border-left: 4px solid #6366f1;
            background: linear-gradient(to right, #e0e7ff 0%, #ffffff 10%);
        }
        
        .order-card-delivered {
            border-left: 4px solid #10b981;
            background: linear-gradient(to right, #dcfce7 0%, #ffffff 10%);
        }
        
        .order-card-cancelled {
            border-left: 4px solid #ef4444;
            background: linear-gradient(to right, #fee2e2 0%, #ffffff 10%);
        }
        
        /* Modal Styles */
        .order-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .order-modal-content {
            background: white;
            border-radius: 0.75rem;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .map-container-modal {
            height: 350px;
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            background: #f3f4f6;
        }
        
        @media (max-width: 768px) {
            .order-modal {
                padding: 0.5rem;
            }
            
            .map-container-modal {
                height: 250px;
            }
            
            .order-modal-content {
                max-height: 95vh;
                border-radius: 0.5rem;
            }
        }
        
        /* Custom Leaflet Icon Styles */
        .custom-div-icon {
            background: white;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .custom-div-icon i {
            margin: 0 !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .benefit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .how-to-card {
            transition: all 0.3s ease;
        }
        
        .how-to-card:hover {
            background-color: #f8fafc;
            transform: scale(1.03);
        }
        
        /* Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        
        .notification {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
            overflow: hidden;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left: 4px solid #10b981;
        }
        
        .notification.error {
            border-left: 4px solid #ef4444;
        }
        
        .notification.warning {
            border-left: 4px solid #f59e0b;
        }
        
        .notification.info {
            border-left: 4px solid #3b82f6;
        }
        
        .notification-content {
            padding: 16px;
            display: flex;
            align-items: flex-start;
        }
        
        .notification-icon {
            margin-right: 12px;
            margin-top: 2px;
        }
        
        .notification-text {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1f2937;
        }
        
        .notification-message {
            color: #6b7280;
            font-size: 14px;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .notification-close:hover {
            color: #6b7280;
            background: #f3f4f6;
        }
        
        .notification-progress {
            height: 3px;
            background: rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .notification-progress-bar {
            height: 100%;
            background: currentColor;
            width: 100%;
            transform: translateX(-100%);
            transition: transform linear;
        }
        
        .notification.success .notification-progress-bar {
            background: #10b981;
        }
        
        .notification.error .notification-progress-bar {
            background: #ef4444;
        }
        
        .notification.warning .notification-progress-bar {
            background: #f59e0b;
        }
        
        .notification.info .notification-progress-bar {
            background: #3b82f6;
        }
        
        /* Rider Stats Cards */
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Priority Order Badges */
        .priority-urgent {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Search and Filter Styles */
        .search-container {
            position: relative;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }
        
        .search-result-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .search-result-item:hover {
            background: #f9fafb;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* Mobile Improvements for Orders */
        @media (max-width: 768px) {
            .order-card-mobile {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            .order-filter {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            .order-details-mobile {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .order-actions-mobile {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .order-actions-mobile button {
                width: 100%;
                padding: 0.75rem;
                font-size: 0.875rem;
            }
            
            /* Fix order card header for mobile */
            .flex.justify-between.items-start {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 1rem;
            }
            
            /* Order header section on mobile */
            .flex.justify-between.items-start .flex-1 {
                width: 100% !important;
                margin-bottom: 1rem;
            }
            
            /* Badge section with title and status - make responsive */
            .flex.items-center.space-x-3.mb-2 {
                flex-wrap: wrap !important;
                align-items: flex-start !important;
                gap: 0.5rem !important;
                margin-bottom: 1rem !important;
            }
            
            /* Order title on mobile - take full width */
            .flex.items-center.space-x-3.mb-2 h3 {
                font-size: 1rem !important;
                line-height: 1.25 !important;
                width: 100% !important;
                margin-bottom: 0.5rem !important;
                word-break: break-word !important;
                flex: 1 1 100% !important;
            }
            
            /* Status and priority badges - allow wrapping */
            .flex.items-center.space-x-3.mb-2 > span {
                font-size: 0.75rem !important;
                padding: 0.25rem 0.75rem !important;
                white-space: nowrap;
                flex-shrink: 0;
                margin: 0 !important;
            }
            
            /* Ensure badges don't overflow */
            .priority-urgent,
            .status-badge,
            .px-3.py-1.rounded-full {
                max-width: calc(50% - 0.25rem) !important;
                text-overflow: ellipsis;
                overflow: hidden;
            }
            
            /* Price section on mobile */
            .flex.justify-between.items-start .text-right {
                text-align: left !important;
                margin-left: 0 !important;
                width: 100%;
                padding-top: 1rem;
                border-top: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            /* Grid layout for order details on mobile */
            .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
            }
            
            /* Order card content wrapper */
            .order-card > div {
                overflow-x: hidden;
            }
            
            /* Ensure text doesn't overflow */
            .order-card p, .order-card span {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
        }
        
        /* Touch-friendly buttons */
        .order-filter {
            transition: all 0.2s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .order-filter:active {
            transform: scale(0.98);
        }
        
        /* Global mobile viewport fixes */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }
            
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            /* Ensure all content stays within viewport */
            * {
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* Header mobile fixes */
            header .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* Header flex container */
            header .flex.justify-between {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            /* Logo section */
            header .flex.items-center img {
                height: 2.5rem !important; /* Smaller logo on mobile */
            }
            
            /* Navigation - hide on mobile or make more compact */
            nav.flex.space-x-8 {
                display: none !important;
            }
            
            /* Right side header items */
            header .flex.items-center.space-x-4 {
                flex-wrap: wrap;
                gap: 0.25rem;
                justify-content: flex-end;
                align-items: center;
            }
            
            /* Status toggle button mobile */
            #rider-status-toggle {
                font-size: 0.75rem !important;
                padding: 0.375rem 0.75rem !important;
                white-space: nowrap;
            }
            
            /* Status toggle container */
            .flex.items-center.space-x-2 {
                margin-right: 0 !important;
            }
            
            /* Hide desktop-only elements more aggressively */
            .hidden.md\\:flex,
            .hidden.md\\:block {
                display: none !important;
            }
            
            /* Logout button - keep visible but smaller */
            button[onclick="logout()"] {
                padding: 0.5rem !important;
                font-size: 0.875rem;
            }
            
            /* Order cards container */
            #orders-container {
                padding: 1rem;
            }
            
            /* Order cards themselves */
            .bg-white.rounded-lg.shadow-md.p-6.mb-4,
            .order-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
                overflow: hidden;
            }
        }
        
        /* Loading spinner for map */
        .map-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f3f4f6;
        }
        
        .map-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Status button styles */
        .status-active {
            background-color: #10b981;
            color: white;
        }
        
        .status-offline {
            background-color: #6b7280;
            color: white;
        }
        
        #rider-status-toggle {
            min-width: fit-content;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #rider-status-toggle i {
            flex-shrink: 0;
        }
        
        #rider-status-toggle span {
            flex-shrink: 0;
        }
        
        @media (max-width: 480px) {
            /* Extra small mobile devices */
            #rider-status-toggle {
                font-size: 0.625rem !important;
                padding: 0.25rem 0.5rem !important;
            }
            
            #rider-status-toggle i {
                margin-right: 0.25rem !important;
            }
            
            /* Make header even more compact on very small screens */
            header .container {
                padding: 0.25rem;
            }
            
            header .py-3 {
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
        }
        
     
        
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Loading Screen -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Caricamento Dashboard Rider</div>
        <div class="loading-subtitle">Stiamo preparando le tue consegne...</div>
        <div class="loading-progress"></div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>
    
    <!-- Header -->
    <header class="bg-green-600 shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <img src="public/logo_eudora-noback.png" 
                     alt="Eudora Logo" 
                     class="h-16 md:h-20 object-contain">
            </div>
            
            <nav class="flex space-x-8 items-center px-4 py-2">
                <a href="index.html" class="hover:text-gray-200 transition text-white font-medium">Home</a>
            </nav>
            
            <div class="flex items-center space-x-4">
                
                <div class="hidden md:flex items-center space-x-2">
                    <span class="text-sm text-gray-200">Benvenuto,</span>
                    <span id="user-name" class="text-sm font-medium text-white"></span>
                    <span id="user-role-badge" class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Rider</span>
                    <div id="test-data-indicator" class="hidden bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs">
                        <i class="fas fa-database mr-1"></i>
                        Dati di test caricati
                    </div>
                </div>
                
                <button onclick="logout()" 
                        class="text-gray-200 hover:text-white p-2 rounded-full hover:bg-green-700 transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4">
        <!-- User Dashboard -->
        <div id="user-dashboard" class="max-w-7xl mx-auto">
            <!-- Dashboard Navigation -->
            <div class="mb-6 md:mb-8 text-center">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-6">Dashboard Rider</h2>
                
                <!-- Rider Navigation Tabs -->
                <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
                    <button onclick="showRiderSection('dashboard')" 
                            class="rider-tab active-tab relative px-4 py-2 md:px-6 md:py-3 rounded-lg font-medium transition-all duration-200 text-sm md:text-base">
                        <i class="fas fa-chart-pie mr-2"></i>
                        Riepilogo
                    </button>
                    <button onclick="showRiderSection('orders')" 
                            class="rider-tab relative px-4 py-2 md:px-6 md:py-3 rounded-lg font-medium transition-all duration-200 text-sm md:text-base text-gray-600 hover:text-blue-600">
                        <i class="fas fa-list-ul mr-2"></i>
                        Ordini
                        <span id="orders-notification-badge" class="notification-badge hidden">0</span>
                    </button>
                    <button onclick="showRiderSection('profile')" 
                            class="rider-tab relative px-4 py-2 md:px-6 md:py-3 rounded-lg font-medium transition-all duration-200 text-sm md:text-base text-gray-600 hover:text-blue-600">
                        <i class="fas fa-user mr-2"></i>
                        Profilo
                    </button>
                </div>
            </div>

            <!-- Riepilogo Section -->
            <div id="rider-dashboard-section" class="rider-section">
                <!-- Header Section -->
               

                <!-- Main Stats Grid - Glovo Style -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- Today's Deliveries -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                        <div class="flex items-center">
                            <div class="bg-green-100 rounded-full p-3 mr-4">
                                <i class="fas fa-check-circle text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Consegne oggi</p>
                                <p id="summary-today-deliveries" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Active Orders -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                        <div class="flex items-center">
                            <div class="bg-orange-100 rounded-full p-3 mr-4">
                                <i class="fas fa-clock text-orange-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Ordini attivi</p>
                                <p id="summary-active-orders" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Earnings -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                        <div class="flex items-center">
                            <div class="bg-blue-100 rounded-full p-3 mr-4">
                                <i class="fas fa-euro-sign text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Guadagni oggi</p>
                                <p id="summary-today-earnings" class="text-2xl font-bold text-gray-900">€0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Rating -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200">
                        <div class="flex items-center">
                            <div class="bg-purple-100 rounded-full p-3 mr-4">
                                <i class="fas fa-star text-purple-600 text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Valutazione</p>
                                <p id="summary-rating" class="text-2xl font-bold text-gray-900">5.0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Weekly Performance -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Performance Settimana</h3>
                            <button onclick="refreshSummaryData()" class="text-orange-500 hover:text-orange-600 transition">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-calendar-day text-gray-500 mr-3"></i>
                                    <span class="text-sm font-medium text-gray-700">Ordini totali</span>
                                </div>
                                <span id="weekly-total-orders" class="font-semibold text-gray-900">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-money-bill-wave text-gray-500 mr-3"></i>
                                    <span class="text-sm font-medium text-gray-700">Guadagni settimana</span>
                                </div>
                                <span id="weekly-earnings" class="font-semibold text-gray-900">€0.00</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-percentage text-gray-500 mr-3"></i>
                                    <span class="text-sm font-medium text-gray-700">Tasso successo</span>
                                </div>
                                <span id="success-rate" class="font-semibold text-green-600">100%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Attività Recente</h3>
                        <div id="recent-activity" class="space-y-4">
                            <!-- This will be populated by JavaScript -->
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-clock text-2xl mb-2"></i>
                                <p>Carica dati per vedere l'attività recente</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions - Glovo Style -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Azioni Rapide</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="showRiderSection('orders')" class="flex flex-col items-center p-4 rounded-xl bg-orange-50 hover:bg-orange-100 transition-all duration-200 text-center">
                            <div class="bg-orange-500 rounded-full p-3 mb-3">
                                <i class="fas fa-list text-white text-lg"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Visualizza Ordini</span>
                        </button>
                        
                        <button onclick="refreshOrdersManually()" class="flex flex-col items-center p-4 rounded-xl bg-blue-50 hover:bg-blue-100 transition-all duration-200 text-center">
                            <div class="bg-blue-500 rounded-full p-3 mb-3">
                                <i class="fas fa-sync-alt text-white text-lg"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Aggiorna Ordini</span>
                        </button>
                        
                        <button onclick="window.Rider && window.Rider.showRiderInfo()" class="flex flex-col items-center p-4 rounded-xl bg-purple-50 hover:bg-purple-100 transition-all duration-200 text-center">
                            <div class="bg-purple-500 rounded-full p-3 mb-3">
                                <i class="fas fa-user-edit text-white text-lg"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Modifica Profilo</span>
                        </button>
                    </div>
                </div>

                <!-- Status Card -->

            </div>
          

            </div>

            <!-- Orders Section -->
            <div id="rider-orders" class="rider-section hidden">
                <!-- Search and Filters Section -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex flex-col md:flex-row gap-4 items-center">
                        <!-- Search Bar -->
                        <div class="search-container flex-1">
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="order-search" 
                                    placeholder="Cerca per nome cliente o indirizzo..."
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <div id="search-results" class="search-results"></div>
                        </div>
                        
                        <!-- Status Filters -->
                        <div class="flex flex-wrap gap-2">
                            <button onclick="filterOrdersByStatus('all')" class="order-filter bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                                Tutti
                            </button>
                            <button onclick="filterOrdersByStatus('ready')" class="order-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                                Pronti
                            </button>
                            <button onclick="filterOrdersByStatus('picked_up')" class="order-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                                Ritirati
                            </button>
                            <button onclick="filterOrdersByStatus('out_for_delivery')" class="order-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                                In Consegna
                            </button>
                            <button onclick="filterOrdersByStatus('delivered')" class="order-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                                Consegnato
                            </button>
                        </div>
                        
                        <!-- Date Filter -->
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Data:</label>
                            <input 
                                type="date" 
                                id="date-filter" 
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                        </div>
                    </div>
                </div>

                <!-- Orders List Section -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-800">
                                    <i class="fas fa-list-ul mr-2"></i>
                                    I Tuoi Ordini
                                </h2>
                                <p class="text-gray-600 text-sm mt-1">Gestisci le tue consegne e aggiorna lo stato degli ordini</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="refreshOrdersManually()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition flex items-center">
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Aggiorna Ordini
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="orders-container" class="p-6">
                        <div class="text-center py-12">
                            <i class="fas fa-sync-alt text-gray-300 text-6xl mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-600 mb-2">Pronto per caricare gli ordini</h3>
                            <p class="text-gray-500 mb-4">Clicca sul pulsante "Aggiorna Ordini" per caricare i tuoi ordini da eudora_orders.</p>
                            <button onclick="refreshOrdersManually()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition inline-flex items-center">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Carica Ordini Ora
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="rider-profile" class="rider-section hidden">
                <!-- This will be populated by JavaScript -->
            </div>
        </div>
    </main>
    
   <!-- Footer -->
    <footer id="footer" class="bg-green-600 text-gray-100 py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12">
                <div>
                    <img src="public/logo_eudora-noback.png" 
                         alt="Eudora Logo" 
                         class="h-16 object-contain mb-4">
                    <p class="mb-4">
                        Consegna di farmaci a domicilio semplice e sicura.
                    </p>
                    <div class="flex space-x-4">
                        <a href="https://www.facebook.com/people/Eudora-Pharma/61553006976233/" target="_blank" rel="noopener noreferrer" class="text-white hover:text-blue-400 text-xl">
                            <i class="fab fa-facebook"></i>
                        </a>
                        <a href="https://www.instagram.com/eudora_pharma?igsh=d2w4NzhqaWJtb3g=" target="_blank" rel="noopener noreferrer" class="text-white hover:text-blue-400 text-xl">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="https://www.linkedin.com/company/eudora-pharma/" target="_blank" rel="noopener noreferrer" class="text-white hover:text-blue-400 text-xl">
                            <i class="fab fa-linkedin"></i>
                        </a>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-bold text-white mb-2">Sede legale</h4>
                        <p class="text-gray-200 text-sm">Via Roma 10 , 87100 - Cosenza (CS)</p>
                    </div>
                </div>

                <div>
                    <h3 class="text-white font-bold text-lg mb-4">Contatti</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-phone-alt mt-1 mr-2 text-sm"></i>
                            <a href="tel:3500378569" class="hover:text-white transition">350 0378569</a>
                        </li>
                        <li class="flex items-start">
                            <i class="fab fa-whatsapp mt-1 mr-2 text-sm"></i>
                            <a href="whatsapp://send?phone=393500378569" onclick="this.href = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'whatsapp://send?phone=393500378569' : 'https://wa.me/393500378569'" target="_blank" rel="noopener noreferrer" class="hover:text-white transition">WhatsApp</a>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-envelope mt-1 mr-2 text-sm"></i>
                            <a href="mailto:Eudorabenessere@gmail.com" class="hover:text-white transition">Eudorabenessere@gmail.com</a>
                        </li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-white font-bold text-lg mb-4">Azienda</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start">
                            <a href="#hero" class="hover:text-white transition">Chi siamo?</a>
                        </li>
                        <li class="flex items-start">
                            <a href="#work-with-us" class="hover:text-white transition">Lavora con noi</a>
                        </li>
                        <li class="flex items-start">
                            <a href="#work-with-us" class="hover:text-white transition">Diventa Partner</a>
                        </li>
                        <li>
                            <a href="#" class="hover:text-white transition">Città attive</a>
                        </li>
                        <li>
                            <a href="#" class="hover:text-white transition">Missiona Futura</a>
                        </li>
                        <li>
                            <a href="#" class="hover:text-white transition">Progetto Calabria</a>
                        </li>
                    </ul>
                </div>

                

                <div>
                    <h3 class="text-white font-bold text-lg mb-4">Newsletter</h3>
                    <p class="text-gray-200 text-sm mb-4">
                        Iscriviti alla newsletter di Eudora per ricevere aggiornamenti e promozioni sul nostro servizio.
                    </p>
                    <form class="space-y-3" onsubmit="subscribeNewsletter(event)">
                        <div>
                            <input type="email" 
                                   id="newsletter-email"
                                   placeholder="La tua email" 
                                   required
                                   class="w-full px-3 py-2 bg-white text-gray-800 border border-gray-300 rounded-lg focus:outline-none focus:border-green-400 text-sm">
                        </div>
                        <div class="flex items-start space-x-2">
                            <input type="checkbox" 
                                   id="newsletter-consent"
                                   required
                                   class="mt-1 w-4 h-4 text-green-600 bg-white border-gray-300 rounded focus:ring-green-500">
                            <label for="newsletter-consent" class="text-xs text-gray-200 leading-tight">
                                *Presto il consenso al trattamento dei miei dati personali per la finalità di marketing così come riportato nell'informativa ex art. 13 GDPR
                            </label>
                        </div>
                        <button type="submit" 
                                class="w-full bg-white text-green-600 py-2 px-4 rounded-lg hover:bg-gray-100 transition duration-300 text-sm font-medium">
                            <i class="fas fa-envelope mr-2"></i>
                            Iscriviti
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="border-t border-green-500 mt-12 pt-8 text-center text-sm">
                <!-- Policy Links -->
                <div class="flex flex-wrap justify-center items-center gap-4 md:gap-6 mb-4">
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Termini e condizioni</a>
                    <span class="text-gray-400">•</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Privacy policy</a>
                    <span class="text-gray-400">•</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Cookie policy</a>
                    <span class="text-gray-400">•</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Aggiorna le tue preferenze di tracciamento</a>
                    <span class="text-gray-400">•</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Preferenze pubblicitarie</a>
                </div>
                <p>&copy; 2025 Eudora. Tutti i diritti riservati.</p>
            </div>
        </div>
    </footer>

    <!-- Floating WhatsApp Button -->
    <a href="whatsapp://send?phone=393500378569" onclick="this.href = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'whatsapp://send?phone=393500378569' : 'https://wa.me/393500378569'" target="_blank" rel="noopener noreferrer"
       class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white w-16 h-16 rounded-full flex flex-col items-center justify-center shadow-lg z-50 transition transform hover:scale-110">
        <span class="text-xs font-semibold leading-none">Info</span>
        <i class="fab fa-whatsapp text-2xl mt-1"></i>
    </a>

    <!-- Modals and dynamic content containers -->
    <div id="modal-container"></div>

    <script>
        // Sistema di notifiche personalizzato per rider
        class RiderNotificationManager {
            constructor() {
                this.container = document.getElementById('notification-container');
                this.activeNotifications = new Set();
            }

            show(type, title, message, duration = 5000) {
                const id = 'notif_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = id;
                
                const progressDuration = duration;
                
                notification.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-icon">
                            <i class="fas fa-${this.getIcon(type)}"></i>
                        </div>
                        <div class="notification-text">
                            <div class="notification-title">${title}</div>
                            <div class="notification-message">${message}</div>
                        </div>
                        <button class="notification-close" onclick="riderNotificationManager.hide('${id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="notification-progress">
                        <div class="notification-progress-bar" style="transition-duration: ${progressDuration}ms;"></div>
                    </div>
                `;
                
                this.container.appendChild(notification);
                this.activeNotifications.add(id);
                
                // Trigger animation
                setTimeout(() => {
                    notification.classList.add('show');
                    // Start progress bar
                    const progressBar = notification.querySelector('.notification-progress-bar');
                    if (progressBar) {
                        progressBar.style.transform = 'translateX(0)';
                    }
                }, 10);
                
                // Auto hide
                if (duration > 0) {
                    setTimeout(() => {
                        this.hide(id);
                    }, duration);
                }
                
                return id;
            }

            hide(id) {
                const notification = document.getElementById(id);
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                        this.activeNotifications.delete(id);
                    }, 300);
                }
            }

            getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                return icons[type] || 'bell';
            }

            success(title, message, duration) {
                return this.show('success', title, message, duration);
            }

            error(title, message, duration) {
                return this.show('error', title, message, duration);
            }

            warning(title, message, duration) {
                return this.show('warning', title, message, duration);
            }

            info(title, message, duration) {
                return this.show('info', title, message, duration);
            }
        }
        
        // Inizializza il manager delle notifiche per il rider
        const riderNotificationManager = new RiderNotificationManager();
        
        // Rendi disponibile globalmente per compatibilità
        window.notificationManager = riderNotificationManager;
        window.riderNotificationManager = riderNotificationManager;
        
        // Loading Screen Manager
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('loading-overlay');
                this.isShowing = true;
            }

            hide() {
                if (this.overlay && this.isShowing) {
                    this.overlay.style.opacity = '0';
                    setTimeout(() => {
                        this.overlay.style.display = 'none';
                        this.isShowing = false;
                    }, 500);
                }
            }

            show() {
                if (this.overlay) {
                    this.overlay.style.display = 'flex';
                    this.overlay.style.opacity = '1';
                    this.isShowing = true;
                }
            }
        }
        
        // Inizializza il loading manager
        const loadingManager = new LoadingManager();
        window.loadingManager = loadingManager;
        
        // Initialize rider dashboard
        document.addEventListener('DOMContentLoaded', function() {
            waitForModules();
        });

        function logout() {
            localStorage.removeItem('currentUser');
            EudoraApp.currentUser = null;
            Auth.showNotification('Logout Effettuato', 'Arrivederci!');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }

        // Global functions for rider dashboard
        window.filterOrdersByStatus = function(status) {
            console.log('🔍 Filtering orders by status:', status);
            
            // Update filter buttons
            const filterButtons = document.querySelectorAll('.order-filter');
            filterButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            // Highlight active filter
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-blue-500', 'text-white');
            
            if (window.Rider && typeof window.Rider.filterOrders === 'function') {
                window.Rider.filterOrders(status);
            }
        };

        // Function to change rider dashboard section - similar to customer dashboard
        window.showRiderSection = function(section) {
            console.log('🚴 Switching to rider section:', section);
            
            // Hide all sections
            const sections = document.querySelectorAll('.rider-section');
            sections.forEach(sec => sec.classList.add('hidden'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.rider-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active-tab');
                tab.classList.add('text-gray-600', 'hover:text-blue-600');
                tab.classList.remove('text-white');
            });
            
            // Show selected section
            const targetSection = document.getElementById(`rider-${section === 'dashboard' ? 'dashboard-section' : section}`);
            // If switching to orders, check if rider is active
            if (section === 'orders') {
                if (window.Rider && window.Rider.currentRider && window.Rider.currentRider.isActive === false) {
                    // Hide orders section and show notification
                    if (targetSection) {
                        targetSection.classList.add('hidden');
                    }
                    riderNotificationManager.info('Non attivo', 'Devi essere attivo per visualizzare gli ordini.');
                    return;
                }
            }
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }

            // Activate corresponding tab
            const activeTab = event ? event.target : document.querySelector(`[onclick="showRiderSection('${section}')"]`);
            if (activeTab) {
                activeTab.classList.add('active-tab');
                activeTab.classList.remove('text-gray-600', 'hover:text-blue-600');
                activeTab.classList.add('text-white');
            }

            // Load section specific content
            switch(section) {
                case 'dashboard':
                    // Dashboard is loaded by default
                    break;
                case 'orders':
                    // Orders section - manual refresh only via button
                    console.log('📦 Orders section activated - use refresh button to load orders');
                    break;
                case 'profile':
                    // Load rider profile
                    if (window.Rider && typeof window.Rider.showRiderInfo === 'function') {
                        // Create inline profile instead of modal
                        loadRiderProfile();
                    }
                    break;
            }
        };

        // Function to load rider profile inline
        function loadRiderProfile() {
            const profileSection = document.getElementById('rider-profile');
            if (!profileSection || !window.Rider || !window.Rider.currentRider) {
                console.warn('⚠️ Cannot load rider profile - missing data');
                return;
            }
            
            const rider = window.Rider.currentRider;
            profileSection.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-user-circle mr-2"></i>
                        Profilo Rider
                    </h2>
                    
                    <!-- Personal Info Section -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-id-card mr-2"></i>
                            Informazioni Personali
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                                <p class="px-3 py-2 bg-white border border-gray-300 rounded-md">${rider.firstName || ''}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cognome</label>
                                <p class="px-3 py-2 bg-white border border-gray-300 rounded-md">${rider.lastName || ''}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <p class="px-3 py-2 bg-white border border-gray-300 rounded-md">${rider.email || ''}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label>
                                <p class="px-3 py-2 bg-white border border-gray-300 rounded-md">${rider.phone || ''}</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Indirizzo</label>
                                <p class="px-3 py-2 bg-white border border-gray-300 rounded-md">${rider.address || ''}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Work Info Section -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-briefcase mr-2"></i>
                            Informazioni Lavorative
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Veicolo</label>
                                <p class="px-3 py-2 bg-white border border-gray-300 rounded-md">${rider.vehicleType|| ''}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Zona di Lavoro</label>
                                <p class="px-3 py-2 bg-white border border-gray-300 rounded-md">${rider.workingZones.join(', ') || ''}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <p class="px-3 py-2 bg-white border border-gray-300 rounded-md">${rider.isActive ? 'Attivo' : 'Inattivo'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div class="flex justify-end">
                        <button onclick="window.Rider && window.Rider.showRiderInfo()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition">
                            <i class="fas fa-edit mr-2"></i>
                            Modifica Profilo
                        </button>
                    </div>
                </div>
            `;
        }

        window.searchOrders = function() {
            const searchTerm = document.getElementById('order-search').value.toLowerCase();
            console.log('🔍 Searching orders for:', searchTerm);
            
            if (window.Rider && typeof window.Rider.searchOrders === 'function') {
                window.Rider.searchOrders(searchTerm);
            }
        };

        window.toggleRiderStatus = function() {
            const statusButton = document.getElementById('rider-status-toggle');
            const statusText = document.getElementById('status-text');
            const isActive = statusButton.classList.contains('status-active');
            
            if (isActive) {
                statusButton.classList.remove('status-active');
                statusButton.classList.add('status-offline');
                statusText.textContent = 'Offline';
                Auth.showNotification('Status Aggiornato', 'Sei ora offline', 'info');
                if (window.Rider && typeof window.Rider.toggleActiveStatus === 'function') {
                    window.Rider.toggleActiveStatus(false);
                }
            } else {
                statusButton.classList.remove('status-offline');
                statusButton.classList.add('status-active');
                statusText.textContent = 'Attivo';
                Auth.showNotification('Status Aggiornato', 'Sei ora attivo per le consegne');
                if (window.Rider && typeof window.Rider.toggleActiveStatus === 'function') {
                    window.Rider.toggleActiveStatus(true);
                }
            }
        };

        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Search functionality
            const searchInput = document.getElementById('order-search');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(searchOrders, 300));
            }
            
            // Date filter
            const dateFilter = document.getElementById('date-filter');
            if (dateFilter) {
                dateFilter.addEventListener('change', function() {
                    if (window.Rider && typeof window.Rider.filterByDate === 'function') {
                        window.Rider.filterByDate(this.value);
                    }
                });
            }
            
            // Status toggle
            const statusToggle = document.getElementById('rider-status-toggle');
            if (statusToggle) {
                statusToggle.addEventListener('click', toggleRiderStatus);
            }
        });

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Wait for modules to load
        function waitForModules() {
            if (typeof Database !== 'undefined' && 
                typeof Auth !== 'undefined') {
                
                console.log('✅ Core modules loaded for rider dashboard');
                
                // Initialize EudoraApp if not available
                if (typeof EudoraApp === 'undefined') {
                    console.log('🔧 Initializing EudoraApp...');
                    window.EudoraApp = {
                        currentUser: null,
                        version: '2.0.0',
                        debug: true
                    };
                }
                
                initializeRiderDashboard();
            } else {
                console.log('⏳ Waiting for modules to load...');
                setTimeout(waitForModules, 100);
            }
        }

        // ====== NOTIFICATION BADGE MANAGEMENT ======
        
        // Function to set notification badge count for orders
        window.setOrderNotificationBadge = function(count = 0, show = false) {
            const badge = document.getElementById('orders-notification-badge');
            if (badge) {
                if (show && count > 0) {
                    badge.textContent = count > 99 ? '99+' : count.toString();
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        };

        // Function to hide all notification badges
        window.hideAllNotificationBadges = function() {
            setOrderNotificationBadge(0, false);
        };

        // Function to debug notification badges
        window.debugNotificationBadges = function() {
            console.log('🔍 Debugging notification badges...');
            const badge = document.getElementById('orders-notification-badge');
            console.log('Orders badge element:', badge);
            console.log('Badge classes:', badge ? badge.className : 'Not found');
        };

        function initializeRiderDashboard() {
            console.log('🚴 Initializing rider dashboard...');
            
            // Initialize EudoraApp if not available
            if (typeof EudoraApp === 'undefined') {
                console.log('🔧 EudoraApp not found, initializing...');
                window.EudoraApp = {
                    currentUser: null,
                    version: '2.0.0',
                    debug: true
                };
            }
            
            // Initialize modules
            Database.init();
            
            // Initialize Auth to check for existing user
            Auth.init();
            
            // If no user is logged in, set up demo rider from database
            if (!EudoraApp.currentUser) {
                console.log('🚴 No user logged in, setting up demo rider from database...');
                
                // Get the first rider from the database
                const riders = Database.getUsersByRole('rider');
                if (riders && riders.length > 0) {
                    const demoRider = riders[0]; // Use first rider from database
                    EudoraApp.currentUser = demoRider;
                    localStorage.setItem('currentUser', JSON.stringify(demoRider));
                    console.log('✅ Demo rider from database set up:', demoRider.email);
                } else {
                    // Fallback demo rider if no riders in database
                    const demoRider = {
                        id: 'rider_demo_001',
                        firstName: 'Marco',
                        lastName: 'Rossi',
                        email: 'marco.rider@eudora.it',
                        role: 'rider',
                        phone: '+39 333 123 4567',
                        vehicle: 'Bicicletta',
                        zone: 'Centro Milano',
                        licenseNumber: 'ABC123',
                        isActive: true,
                        profilePicture: null,
                        workingHours: {
                            start: '09:00',
                            end: '18:00'
                        },
                        emergencyContact: {
                            name: 'Anna Rossi',
                            phone: '+39 333 987 6543'
                        },
                        address: 'Via Roma 123, Milano',
                        createdAt: new Date().toISOString()
                    };
                    
                    EudoraApp.currentUser = demoRider;
                    localStorage.setItem('currentUser', JSON.stringify(demoRider));
                    console.log('✅ Fallback demo rider set up:', demoRider.email);
                }
            } else if (EudoraApp.currentUser.role !== 'rider') {
                console.log('🚴 Current user is not a rider, this is demo mode');
                // Keep the current user but rider module will handle this
            }
            
            // Initialize rider module if available (after setting up the user)
            if (typeof Rider !== 'undefined') {
                console.log('🚴 Initializing Rider module...');
                Rider.init();
            } else {
                console.warn('⚠️ Rider module not available');
            }
            
            
            // Set current date in date filter
            const dateFilter = document.getElementById('date-filter');
            if (dateFilter) {
                dateFilter.value = new Date().toISOString().split('T')[0];
            }
            
            
            // Hide loading screen
            setTimeout(() => {
                loadingManager.hide();
            }, 1000);
            
            console.log('✅ Rider dashboard initialized');
        }

        // Manual refresh function for orders using getOrdersFromEudoraOrders
        window.refreshOrdersManually = function() {
            console.log('🔄 Manual refresh triggered...');
            
            if (!window.Rider) {
                riderNotificationManager.error('Errore', 'Modulo Rider non disponibile');
                return;
            }
            
            // Show loading state
            const ordersContainer = document.getElementById('orders-container');
            if (ordersContainer) {
                ordersContainer.innerHTML = `
                    <div class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">Caricamento ordini...</h3>
                        <p class="text-gray-500">Recupero dati da eudora_orders...</p>
                    </div>
                `;
            }
            
            try {
                // Use the new method to get orders from eudora_orders
                if (typeof window.Rider.getOrdersFromEudoraOrders === 'function') {
                    const allOrders = window.Rider.getOrdersFromEudoraOrders();
                    console.log(`📦 Retrieved ${allOrders.length} orders from eudora_orders manually`);
                    
                    // Update Rider's internal state
                    if (window.Rider.currentRider && window.Rider.currentRider.id) {
                        window.Rider.orders = allOrders.filter(order => {
                            return order.status === 'ready' || 
                                   order.status === 'picked_up' || 
                                   order.status === 'out_for_delivery' ||
                                   (order.riderId === window.Rider.currentRider.id);
                        });
                    } else {
                        window.Rider.orders = allOrders;
                    }
                    
                    window.Rider.filteredOrders = [...window.Rider.orders];
                    
                    // Update display and stats
                    if (typeof window.Rider.updateOrdersDisplay === 'function') {
                        window.Rider.updateOrdersDisplay();
                    }
                    if (typeof window.Rider.updateStats === 'function') {
                        window.Rider.updateStats();
                    }
                    
                    // Show success notification
                    riderNotificationManager.success(
                        'Ordini Aggiornati', 
                        `${window.Rider.orders.length} ordini disponibili da eudora_orders`
                    );
                    
                } else {
                    // Fallback to regular loadOrders if new method not available
                    console.log('📦 Fallback: using loadOrders method...');
                    if (typeof window.Rider.loadOrders === 'function') {
                        window.Rider.loadOrders();
                    }
                }
                
            } catch (error) {
                console.error('❌ Error during manual refresh:', error);
                riderNotificationManager.error('Errore', 'Impossibile aggiornare gli ordini');
                
                // Show error state
                if (ordersContainer) {
                    ordersContainer.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-exclamation-triangle text-red-400 text-6xl mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-600 mb-2">Errore nel caricamento</h3>
                            <p class="text-gray-500 mb-4">Si è verificato un errore durante il caricamento degli ordini.</p>
                            <button onclick="refreshOrdersManually()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition inline-flex items-center">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Riprova
                            </button>
                        </div>
                    `;
                }
            }
        };

        // Glovo-style Dashboard Functions
        function refreshSummaryData() {
            console.log('🔄 Refreshing dashboard summary data...');
            
            try {
                // Get all orders from eudora_orders
                const allOrders = window.Rider && window.Rider.getAllOrdersFromEudoraOrders ? 
                    window.Rider.getAllOrdersFromEudoraOrders() : 
                    JSON.parse(localStorage.getItem('eudora_orders') || '[]');
                
                // Get current rider ID (if available)
                const currentRiderId = window.Rider && window.Rider.currentRider ? 
                    window.Rider.currentRider.id : null;
                
                // Filter orders for this rider if logged in
                const riderOrders = currentRiderId ? 
                    allOrders.filter(order => order.riderId === currentRiderId) : 
                    allOrders;
                
                // Calculate today's stats
                const today = new Date().toDateString();
                const todayOrders = riderOrders.filter(order => {
                    const orderDate = new Date(order.createdAt || order.timestamp || Date.now());
                    return orderDate.toDateString() === today;
                });
                
                // Update dashboard stats
                updateDashboardStats(riderOrders, todayOrders);
                updateRecentActivity(riderOrders.slice(0, 5));
                
                console.log(`📊 Dashboard updated with ${riderOrders.length} total orders, ${todayOrders.length} today`);
                
            } catch (error) {
                console.error('❌ Error refreshing summary data:', error);
                riderNotificationManager.error('Errore', 'Impossibile aggiornare i dati del riepilogo');
            }
        }

        function updateDashboardStats(allOrders, todayOrders) {
            // Today's deliveries (completed orders)
            const todayDeliveries = todayOrders.filter(order => order.status === 'delivered').length;
            document.getElementById('summary-today-deliveries').textContent = todayDeliveries;
            
            // Active orders (orders in progress)
            const activeOrders = allOrders.filter(order => 
                ['ready', 'picked_up', 'out_for_delivery'].includes(order.status)
            ).length;
            document.getElementById('summary-active-orders').textContent = activeOrders;
            
            // Today's earnings
            const todayEarnings = todayOrders
                .filter(order => order.status === 'delivered')
                .reduce((total, order) => total + (parseFloat(order.deliveryFee) || 5.0), 0);
            document.getElementById('summary-today-earnings').textContent = `€${todayEarnings.toFixed(2)}`;
            
            // Weekly stats
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const weeklyOrders = allOrders.filter(order => {
                const orderDate = new Date(order.createdAt || order.timestamp || Date.now());
                return orderDate >= weekAgo;
            });
            
            const weeklyEarnings = weeklyOrders
                .filter(order => order.status === 'delivered')
                .reduce((total, order) => total + (parseFloat(order.deliveryFee) || 5.0), 0);
            
            const successRate = weeklyOrders.length > 0 ? 
                ((weeklyOrders.filter(order => order.status === 'delivered').length / weeklyOrders.length) * 100).toFixed(0) : 
                100;
            
            document.getElementById('weekly-total-orders').textContent = weeklyOrders.length;
            document.getElementById('weekly-earnings').textContent = `€${weeklyEarnings.toFixed(2)}`;
            document.getElementById('success-rate').textContent = `${successRate}%`;
        }

        function updateRecentActivity(recentOrders) {
            const activityContainer = document.getElementById('recent-activity');
            
            if (!recentOrders || recentOrders.length === 0) {
                activityContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-clock text-2xl mb-2"></i>
                        <p>Nessuna attività recente</p>
                    </div>
                `;
                return;
            }
            
            const activityHTML = recentOrders.map(order => {
                const timeAgo = getTimeAgo(new Date(order.createdAt || order.timestamp || Date.now()));
                const statusInfo = getStatusInfo(order.status);
                
                return `
                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                        <div class="bg-${statusInfo.color}-100 rounded-full p-2 mr-3">
                            <i class="fas fa-${statusInfo.icon} text-${statusInfo.color}-600 text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">Ordine #${order.id}</p>
                            <p class="text-xs text-gray-500">${statusInfo.label} • ${timeAgo}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold text-gray-900">€${(parseFloat(order.deliveryFee) || 5.0).toFixed(2)}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            activityContainer.innerHTML = activityHTML;
        }

        function getStatusInfo(status) {
            const statusMap = {
                'pending': { label: 'In Attesa', icon: 'clock', color: 'yellow' },
                'ready': { label: 'Pronto', icon: 'check-circle', color: 'blue' },
                'picked_up': { label: 'Ritirato', icon: 'hand-holding', color: 'purple' },
                'out_for_delivery': { label: 'In Consegna', icon: 'motorcycle', color: 'orange' },
                'delivered': { label: 'Consegnato', icon: 'check-double', color: 'green' },
                'cancelled': { label: 'Annullato', icon: 'times-circle', color: 'red' }
            };
            
            return statusMap[status] || { label: 'Sconosciuto', icon: 'question', color: 'gray' };
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Ora';
            if (diffInMinutes < 60) return `${diffInMinutes} min fa`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours} ore fa`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            return `${diffInDays} giorni fa`;
        }

        function showOrderStatistics() {
            try {
                const stats = window.Rider && window.Rider.getOrdersStatistics ? 
                    window.Rider.getOrdersStatistics() : 
                    { total: 0, completed: 0, pending: 0, earnings: 0 };
                
                riderNotificationManager.info(
                    'Statistiche Ordini',
                    `Totale: ${stats.total} | Completati: ${stats.completed} | In corso: ${stats.pending} | Guadagni: €${stats.earnings.toFixed(2)}`
                );
            } catch (error) {
                console.error('Error showing statistics:', error);
                riderNotificationManager.error('Errore', 'Impossibile mostrare le statistiche');
            }
        }

        function toggleRiderStatus() {
            // Simple status toggle - in a real app this would update the backend
            const statusBtn = document.getElementById('status-toggle-btn');
            const statusMessage = document.getElementById('rider-status-message');
            const statusIndicator = document.getElementById('status-indicator');
            
            if (statusBtn.textContent.trim() === 'Online') {
                statusBtn.textContent = 'Offline';
                statusBtn.className = 'bg-gray-200 text-gray-600 px-6 py-2 rounded-full font-semibold hover:bg-gray-300 transition';
                statusMessage.textContent = 'Sei offline - attiva per ricevere ordini';
                statusIndicator.className = 'w-3 h-3 bg-gray-400 rounded-full';
            } else {
                statusBtn.textContent = 'Online';
                statusBtn.className = 'bg-white text-green-600 px-6 py-2 rounded-full font-semibold hover:bg-gray-100 transition';
                statusMessage.textContent = 'Sei attivo e pronto per le consegne';
                statusIndicator.className = 'w-3 h-3 bg-white rounded-full animate-pulse';
            }
        }

        // Auto-refresh dashboard data when orders section is updated
        if (window.Rider && typeof window.Rider.updateStats === 'function') {
            const originalUpdateStats = window.Rider.updateStats;
            window.Rider.updateStats = function() {
                originalUpdateStats.call(this);
                refreshSummaryData(); // Also update our Glovo-style dashboard
            };
        }

        // Initialize dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                refreshSummaryData();
            }, 1000);
        });
    </script>
</body>
</html>
