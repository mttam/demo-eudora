<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Farmacia | Eudora</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Link to original styles -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Custom JavaScript Modules -->
    <script src="js/utils.js" defer></script>
    <script src="js/database.js" defer></script>
    <script src="js/inventory-manager.js" defer></script>
    <script src="js/inventory-api.js" defer></script>
    <script src="js/sample-data.js" defer></script>
    <script src="js/test-data.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/notifications.js" defer></script>
    <script src="js/pharmacy.js" defer></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .map-container {
            height: 300px;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .status-preparing { 
            background-color: #fef3c7; 
            color: #92400e; 
            border-color: #fde68a; 
        }
        .status-out-for-delivery { 
            background-color: #dbeafe; 
            color: #1e40af; 
            border-color: #93c5fd; 
        }
        .status-delivered { 
            background-color: #dcfce7; 
            color: #166534; 
            border-color: #86efac; 
        }
        .status-active { 
            background-color: #dcfce7; 
            color: #166534; 
            border-color: #86efac; 
        }
        .status-offline { 
            background-color: #f3f4f6; 
            color: #374151; 
            border-color: #d1d5db; 
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .benefit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .how-to-card {
            transition: all 0.3s ease;
        }
        
        .how-to-card:hover {
            background-color: #f8fafc;
            transform: scale(1.03);
        }

        /* Customer Tab Styles - Matching Customer Dashboard */
        .customer-tab {
            position: relative;
            overflow: visible !important;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .customer-tab:hover {
            color: #3b82f6 !important;
        }

        /* Tab attivo: blu con testo bianco */
        .customer-tab.active-tab {
            background-color: #2563eb !important; /* blue-600 */
            color: #fff !important;
            border-bottom: 2px solid #2563eb !important;
            box-shadow: 0 2px 8px rgba(37,99,235,0.08);
            z-index: 1;
        }

        /* Ensure notification badges are never clipped */
        .customer-tab.relative {
            overflow: visible !important;
            position: relative;
            z-index: 10;
        }

        /* Navigation tabs container anti-clipping rules */
        .customer-tab .absolute {
            z-index: 999 !important;
            transform: translateZ(0);
            will-change: transform;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .notification-button {
            position: relative;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .notification-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Pharmacy Tab Styles - Same as Customer Dashboard */
        .pharmacy-tab {
            position: relative;
            overflow: visible !important;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }

        .pharmacy-tab:hover {
            color: #3b82f6 !important;
            background-color: #f8fafc;
        }

        /* Navigation tabs container anti-clipping rules */
        .pharmacy-tab .absolute {
            z-index: 999 !important;
            transform: translateZ(0);
            will-change: transform;
        }

        /* Notification System - Matching Customer Dashboard */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        
        .notification {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
            overflow: hidden;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left: 4px solid #10b981;
        }
        
        .notification.error {
            border-left: 4px solid #ef4444;
        }
        
        .notification.warning {
            border-left: 4px solid #f59e0b;
        }
        
        .notification.info {
            border-left: 4px solid #3b82f6;
        }
        
        .notification-content {
            padding: 16px;
            display: flex;
            align-items: flex-start;
        }
        
        .notification-icon {
            margin-right: 12px;
            margin-top: 2px;
        }
        
        .notification-text {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1f2937;
        }
        
        .notification-message {
            color: #6b7280;
            font-size: 14px;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .notification-close:hover {
            color: #6b7280;
            background: #f3f4f6;
        }
        
        .notification-progress {
            height: 3px;
            background: rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .notification-progress-bar {
            height: 100%;
            background: currentColor;
            width: 100%;
            transform: translateX(-100%);
            transition: transform linear;
        }
        
        .notification.success .notification-progress-bar {
            background: #10b981;
        }
        
        .notification.error .notification-progress-bar {
            background: #ef4444;
        }
        
        .notification.warning .notification-progress-bar {
            background: #f59e0b;
        }
        
        .notification.info .notification-progress-bar {
            background: #3b82f6;
        }

        /* Admin Dashboard Styles */
        .admin-tab {
            transition: all 0.3s ease;
        }
        
        .admin-tab:hover {
            color: #3b82f6;
        }
        
        .admin-section {
            animation: fadeIn 0.3s ease-in;
        }
        
        .product-item {
            transition: all 0.3s ease;
        }
        
        .product-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        /* Form Enhancement */
        #add-product-form input:focus,
        #add-product-form select:focus,
        #add-product-form textarea:focus {
            border-color: #3b82f6;
            outline: 2px solid #3b82f6;
            outline-offset: -2px;
        }
        
        /* Notification Styles */
        .notification-slide-in {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* CSV Import Modal Styles */
        #csv-import-modal {
            backdrop-filter: blur(4px);
        }
        
        #csv-preview-table {
            font-size: 0.875rem;
        }
        
        #csv-preview-table th,
        #csv-preview-table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        .csv-upload-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        
        .csv-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        
        .csv-upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* Loading Screen Styles - Matching customer dashboard */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f4f6;
            border-top: 6px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            text-align: center;
        }

        .loading-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 24px;
            text-align: center;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 2px;
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes progress {
            0% {
                width: 0%;
                margin-left: 0%;
            }
            50% {
                width: 75%;
                margin-left: 0%;
            }
            100% {
                width: 0%;
                margin-left: 100%;
            }
        }

        /* Notification System - Matching customer dashboard */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
            overflow: hidden;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        .notification.warning {
            border-left: 4px solid #f59e0b;
        }

        .notification.info {
            border-left: 4px solid #3b82f6;
        }

        .notification-content {
            padding: 16px;
            display: flex;
            align-items: flex-start;
        }

        .notification-icon {
            margin-right: 12px;
            margin-top: 2px;
        }

        .notification-text {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1f2937;
        }

        .notification-message {
            color: #6b7280;
            font-size: 14px;
        }

        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .notification-close:hover {
            color: #6b7280;
            background: #f3f4f6;
        }

        .notification-progress {
            height: 3px;
            background: rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .notification-progress-bar {
            height: 100%;
            background: currentColor;
            width: 100%;
            transform: translateX(-100%);
            transition: transform linear;
        }

        .notification.success .notification-progress-bar {
            background: #10b981;
        }

        .notification.error .notification-progress-bar {
            background: #ef4444;
        }

        .notification.warning .notification-progress-bar {
            background: #f59e0b;
        }

        .notification.info .notification-progress-bar {
            background: #3b82f6;
        }

        /* Map Modal Styles - Matching Customer Dashboard */
        .map-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .map-modal-content {
            background: white;
            border-radius: 0.75rem;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .map-container-modal {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            background: #f3f4f6;
        }
        
        @media (max-width: 768px) {
            .map-modal {
                padding: 0.5rem;
            }
            
            .map-container-modal {
                height: 300px;
            }
            
            .map-modal-content {
                max-height: 95vh;
            }
        }
        
        /* Custom Leaflet Icon Styles - Matching Customer Dashboard */
        .custom-div-icon {
            background: white;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .custom-div-icon i {
            margin: 0 !important;
        }

        /* Cancel Order Modal Styles - Matching Customer Dashboard */
        .cancel-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001; /* Higher than map modal */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .cancel-modal-enter {
            animation: modalEnter 0.3s ease-out forwards;
        }
        
        .cancel-modal-exit {
            animation: modalExit 0.2s ease-in forwards;
        }
        
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes modalExit {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
        }
        
        /* Cancel modal content animations */
        .cancel-modal .bg-white {
            transform: scale(0.9);
            opacity: 0;
            animation: modalContentEnter 0.3s ease-out 0.1s forwards;
        }
        
        @keyframes modalContentEnter {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Focus styles for cancel modal form elements */
        .cancel-modal select:focus,
        .cancel-modal textarea:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        /* Error state for required fields */
        .cancel-modal .border-red-500 {
            animation: fieldError 0.3s ease-in-out;
        }
        
        @keyframes fieldError {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Filter section styles */
        .filter-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .filter-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .filter-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-input-group label {
            font-size: 11px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .filter-input:hover {
            border-color: #9ca3af;
        }

        .filter-button {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .filter-button.primary {
            background: #3b82f6;
            color: white;
        }

        .filter-button.primary:hover {
            background: #2563eb;
        }

        .filter-button.secondary {
            background: #6b7280;
            color: white;
        }

        .filter-button.secondary:hover {
            background: #4b5563;
        }

        .filter-count-badge {
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
            font-weight: 600;
        }

        /* Responsive filter layout */
        @media (max-width: 768px) {
            .filter-section .flex {
                flex-direction: column;
                gap: 16px;
            }
            
            .filter-input-group {
                width: 100%;
            }
        }

        /* Enhanced product and order cards */
        .product-card, .order-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .product-card:hover, .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #d1d5db;
        }

        .filter-status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #eff6ff;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 8px;
        }

                        .filter-status-indicator.restored {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }

        .filter-status-indicator.restored::before {
            content: 'ðŸ”„ ';
            margin-right: 4px;
        }

        /* Order Status Card Styles - Matching Customer Dashboard */
        .order-card-pending {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(to right, #fef3c7 0%, #ffffff 10%);
        }
        
        .order-card-accepted {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(to right, #dbeafe 0%, #ffffff 10%);
        }
        
        .order-card-preparing {
            border-left: 4px solid #f97316;
            background: linear-gradient(to right, #fed7aa 0%, #ffffff 10%);
        }
        
        .order-card-ready {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(to right, #e9d5ff 0%, #ffffff 10%);
        }
        
        .order-card-picked_up {
            border-left: 4px solid #6366f1;
            background: linear-gradient(to right, #e0e7ff 0%, #ffffff 10%);
        }
        
        .order-card-delivered {
            border-left: 4px solid #10b981;
            background: linear-gradient(to right, #dcfce7 0%, #ffffff 10%);
        }
        
        .order-card-cancelled {
            border-left: 4px solid #ef4444;
            background: linear-gradient(to right, #fee2e2 0%, #ffffff 10%);
        }

        /* Mobile Improvements for Orders */
        @media (max-width: 768px) {
            .order-card-mobile {
                margin-bottom: 1rem;
                padding: 1rem;
            }
            
            .order-filter {
                min-height: 48px; /* Touch target size */
                touch-action: manipulation;
            }
            
            .order-details-mobile {
                flex-direction: column;
                gap: 1rem;
            }
            
            .order-actions-mobile {
                width: 100%;
            }
            
            .order-actions-mobile button {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
        
        /* Touch-friendly buttons */
        .order-filter {
            transition: all 0.2s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .order-filter:active {
            transform: scale(0.98);
        }
        
        /* Product Management Styles */
        .product-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #d1d5db;
        }
        
        .product-card-active {
            border-left: 4px solid #10b981;
            background: linear-gradient(to right, #d1fae5 0%, #ffffff 10%);
        }
        
        .product-card-inactive {
            border-left: 4px solid #ef4444;
            background: linear-gradient(to right, #fee2e2 0%, #ffffff 10%);
            opacity: 0.7;
        }
        
        .product-card-low-stock {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(to right, #fef3c7 0%, #ffffff 10%);
        }
        
        .product-form-container {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .product-form-container.editing {
            border-color: #3b82f6;
            background: linear-gradient(to right, #dbeafe 0%, #f8fafc 10%);
        }
        
        .product-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .product-tag-prescription {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .product-tag-no-prescription {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .product-tag-category {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .product-tag-stock-ok {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .product-tag-stock-low {
            background: #fef3c7;
            color: #d97706;
        }
        
        .product-tag-stock-out {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .product-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .product-action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .product-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .product-action-edit {
            background: #f3f4f6;
            color: #374151;
            border-color: #d1d5db;
        }
        
        .product-action-edit:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .product-action-delete {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fca5a5;
        }
        
        .product-action-delete:hover {
            background: #fecaca;
            border-color: #f87171;
        }
        
        .product-action-toggle {
            background: #dbeafe;
            color: #2563eb;
            border-color: #93c5fd;
        }
        
        .product-action-toggle:hover {
            background: #bfdbfe;
            border-color: #60a5fa;
        }
        
        .product-action-disable {
            background: #fed7d7;
            color: #c53030;
            border-color: #feb2b2;
        }
        
        .product-action-disable:hover {
            background: #fbb6ce;
            border-color: #f56565;
        }
        
        .product-action-enable {
            background: #c6f6d5;
            color: #22543d;
            border-color: #9ae6b4;
        }
        
        .product-action-enable:hover {
            background: #9ae6b4;
            border-color: #68d391;
        }
        
        .product-tag-inactive {
            background: #fecaca !important;
            color: #dc2626 !important;
            font-weight: 600;
            border: 1px solid #f87171;
        }
        
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        
        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #374151;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        
        .pagination-btn:hover:not(.disabled) {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .pagination-btn.active {
            background: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }
        
        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            color: #6b7280;
            font-size: 0.875rem;
            margin: 0 1rem;
        }
        
        /* CSV Modal Styles */
        .csv-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .csv-modal-content {
            background: #ffffff;
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .csv-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .csv-upload-area:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        
        .csv-upload-area.dragover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .csv-preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        
        .csv-preview-table th,
        .csv-preview-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .csv-preview-table th {
            background: #f3f4f6;
            font-weight: 600;
        }
        
        /* Multi-select styles */
        select[multiple] {
            height: auto !important;
            min-height: 100px;
        }
        
        select[multiple] option {
            padding: 0.25rem 0.5rem;
        }
        
        select[multiple] option:checked {
            background: #3b82f6;
            color: #ffffff;
        }
        
        /* Form validation styles */
        .form-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Loading Screen - Matching customer dashboard -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Caricamento Dashboard Farmacia</div>
        <div class="loading-subtitle">Stiamo preparando i tuoi dati...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Notification Container - Matching customer dashboard -->
    <div id="notification-container" class="notification-container"></div>
    
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <img src="public/logo_eudora-noback.png" 
                     alt="Eudora Logo" 
                     class="h-16 md:h-20 object-contain">
            </div>
            
            <nav class="hidden md:flex space-x-8">
                <a href="index.html" class="hover:text-blue-600 transition">Home</a>
                <a href="#" class="text-blue-600 font-medium">Dashboard</a>
            </nav>
            
            <div class="flex items-center space-x-4">
                
                <div class="hidden md:flex items-center space-x-2">
                    <span class="text-sm text-gray-600">Benvenuto,</span>
                    <span id="user-name" class="text-sm font-medium text-gray-800"></span>
                    <span id="user-role-badge" class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">Farmacia</span>
                    <div id="test-data-indicator" class="hidden bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs">
                        <i class="fas fa-database mr-1"></i>
                        Dati di test caricati
                    </div>
                </div>
                
                <button onclick="logout()" 
                        class="text-gray-600 hover:text-gray-800 p-2 rounded-full hover:bg-gray-100 transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4">
        <!-- Pharmacy Dashboard -->
        <div id="pharmacy-dashboard">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Dashboard Farmacia</h2>
                
                <!-- Pharmacy Navigation Tabs -->
                <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-200">
                    <button onclick="showPharmacySection('orders')" id="pharmacy-tab-orders" class="pharmacy-tab px-6 py-3 font-medium text-gray-600 border-b-2 border-transparent relative">
                        <i class="fas fa-clipboard-list mr-2"></i>Ordini
                        <span id="pharmacy-orders-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <button onclick="showPharmacySection('products')" id="pharmacy-tab-products" class="pharmacy-tab px-6 py-3 font-medium text-blue-600 border-b-2 border-blue-600 relative">
                        <i class="fas fa-pills mr-2"></i>Gestione Prodotti
                        <span id="pharmacy-products-count" class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </div>
        
        <!-- Orders Section -->
        <div id="pharmacy-orders" class="pharmacy-section hidden">
            <!-- Main Orders List Container (used by Pharmacy.updateOrdersDisplay()) -->
            <div class="mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Tutti gli Ordini</h3>
                    
                    <!-- Order Filters -->
                    <div class="filter-section">
                        <div class="flex flex-wrap gap-4 items-end">
                            <div class="filter-input-group flex-1 min-w-0">
                                <label>Cerca ordini</label>
                                <input type="text" id="order-search-pharmacy" placeholder="ID ordine, cliente, telefono..." 
                                       class="filter-input w-full"
                                       onkeyup="applyOrderFilters()"
                                       onchange="saveOrderFilters()">
                            </div>
                            
                            <div class="filter-input-group min-w-0">
                                <label>Stato</label>
                                <select id="filter-order-status" 
                                        class="filter-input"
                                        onchange="applyOrderFilters(); saveOrderFilters();">
                                    <option value="">Tutti gli stati</option>
                                    <option value="pending">In Attesa</option>
                                    <option value="accepted">Accettato</option>
                                    <option value="preparing">In Preparazione</option>
                                    <option value="ready">Pronto</option>
                                    <option value="delivered">Consegnato</option>
                                    <option value="cancelled">Cancellato</option>
                                </select>
                            </div>
                            
                            <div class="flex gap-2">
                                <div class="filter-input-group min-w-0">
                                    <label>Totale Min (â‚¬)</label>
                                    <input type="number" id="filter-order-total-min" placeholder="0.00" step="0.01" min="0"
                                           class="filter-input w-20"
                                           onchange="applyOrderFilters(); saveOrderFilters();">
                                </div>
                                <div class="filter-input-group min-w-0">
                                    <label>Totale Max (â‚¬)</label>
                                    <input type="number" id="filter-order-total-max" placeholder="999.99" step="0.01" min="0"
                                           class="filter-input w-20"
                                           onchange="applyOrderFilters(); saveOrderFilters();">
                                </div>
                            </div>
                            
                            <div class="filter-input-group min-w-0">
                                <label>Periodo ordine</label>
                                <select id="filter-order-time-period" 
                                        class="filter-input"
                                        onchange="applyOrderFilters(); saveOrderFilters();">
                                    <option value="">Tutto il periodo</option>
                                    <option value="today">Oggi</option>
                                    <option value="week">Questa settimana</option>
                                    <option value="month">Questo mese</option>
                                    <option value="quarter">Ultimi 3 mesi</option>
                                    <option value="year">Quest'anno</option>
                                </select>
                            </div>
                            
                            <div class="filter-input-group min-w-0">
                                <label>Ordina per</label>
                                <select id="filter-order-sort-by" 
                                        class="filter-input"
                                        onchange="applyOrderFilters(); saveOrderFilters();">
                                    <option value="created-desc">PiÃ¹ recenti</option>
                                    <option value="created">PiÃ¹ vecchi</option>
                                    <option value="total">Totale crescente</option>
                                    <option value="total-desc">Totale decrescente</option>
                                    <option value="status">Stato A-Z</option>
                                    <option value="customer">Cliente A-Z</option>
                                </select>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="clearOrderFilters()" 
                                        class="filter-button secondary">
                                    <i class="fas fa-times"></i>Reset
                                </button>
                                <button onclick="applyOrderFilters()" 
                                        class="filter-button primary">
                                    <i class="fas fa-filter"></i>Applica
                                </button>
                            </div>
                        </div>
                        <div id="order-filter-status" class="filter-status-indicator" style="display: none;">
                            <i class="fas fa-filter"></i>
                            <span>Filtri attivi</span>
                        </div>
                    </div>
                    
                    <div id="pharmacy-orders-list" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-3"></i>
                            <p>Nessun ordine in arrivo</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Products Section -->
        <div id="pharmacy-products" class="pharmacy-section">
            <!-- Product Creation/Editing Form -->
            <div class="mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <span id="product-form-title">Aggiungi Nuovo Prodotto</span>
                    </h3>
                    
                    <form id="pharmacy-product-form" class="space-y-4">
                        <input type="hidden" id="product-edit-id" value="">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Product Name -->
                            <div class="filter-input-group">
                                <label for="product-name">Nome Prodotto *</label>
                                <input type="text" id="product-name" name="name" required
                                       class="filter-input w-full"
                                       placeholder="Es. Paracetamolo 500mg">
                            </div>
                            
                            <!-- Price -->
                            <div class="filter-input-group">
                                <label for="product-price">Prezzo (â‚¬) *</label>
                                <input type="number" id="product-price" name="price" required
                                       class="filter-input w-full" step="0.01" min="0"
                                       placeholder="Es. 4.50">
                            </div>
                            
                            <!-- Stock -->
                            <div class="filter-input-group">
                                <label for="product-stock">QuantitÃ  Stock *</label>
                                <input type="number" id="product-stock" name="stock" required
                                       class="filter-input w-full" min="0"
                                       placeholder="Es. 50">
                            </div>
                            
                            <!-- Category -->
                            <div class="filter-input-group">
                                <label for="product-category">Categoria *</label>
                                <select id="product-category" name="category" required
                                        class="filter-input w-full"
                                        onchange="updateCategoryName()">
                                    <option value="">Seleziona categoria</option>
                                    <option value="analgesici">Analgesici e Antinfiammatori</option>
                                    <option value="antibiotici">Antibiotici</option>
                                    <option value="vitamine">Vitamine e Integratori</option>
                                    <option value="cosmetica">Cosmetica e Igiene</option>
                                    <option value="medicazioni">Medicazioni e Dispositivi</option>
                                </select>
                            </div>
                            
                            <!-- SKU -->
                            <div class="filter-input-group">
                                <label for="product-sku">SKU</label>
                                <input type="text" id="product-sku" name="sku"
                                       class="filter-input w-full"
                                       placeholder="Generato automaticamente">
                            </div>
                            
                            <!-- Manufacturer -->
                            <div class="filter-input-group">
                                <label for="product-manufacturer">Produttore</label>
                                <input type="text" id="product-manufacturer" name="manufacturer"
                                       class="filter-input w-full"
                                       placeholder="Es. Bristol Myers">
                            </div>
                            
                            <!-- Expiry Date -->
                            <div class="filter-input-group">
                                <label for="product-expiry">Data di Scadenza</label>
                                <input type="date" id="product-expiry" name="expiryDate"
                                       class="filter-input w-full">
                            </div>
                            
                            <!-- Batch Number -->
                            <div class="filter-input-group">
                                <label for="product-batch">Numero Lotto</label>
                                <input type="text" id="product-batch" name="batchNumber"
                                       class="filter-input w-full"
                                       placeholder="Es. BX8910">
                            </div>
                            
                            <!-- Image URL -->
                            <div class="filter-input-group">
                                <label for="product-image">URL Immagine</label>
                                <input type="url" id="product-image" name="imageUrl"
                                       class="filter-input w-full"
                                       placeholder="Es. /images/prodotto.jpg">
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div class="filter-input-group">
                            <label for="product-description">Descrizione *</label>
                            <textarea id="product-description" name="description" required
                                      class="filter-input w-full" rows="3"
                                      placeholder="Descrizione dettagliata del prodotto"></textarea>
                        </div>
                        
                        <!-- Requires Prescription -->
                        <div class="filter-input-group">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="product-prescription" name="requiresPrescription"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span>Richiede ricetta medica</span>
                            </label>
                        </div>
                        
                        <!-- Form Buttons -->
                        <div class="flex gap-2 pt-4">
                            <button type="submit" class="filter-button primary">
                                <i class="fas fa-save mr-1"></i>
                                <span id="product-form-submit-text">Aggiungi Prodotto</span>
                            </button>
                            <button type="button" onclick="resetProductForm()" class="filter-button secondary">
                                <i class="fas fa-times mr-1"></i>Reset
                            </button>
                            <button type="button" id="cancel-edit-btn" onclick="cancelProductEdit()" 
                                    class="filter-button secondary hidden">
                                <i class="fas fa-ban mr-1"></i>Annulla Modifica
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- CSV Import/Export -->
            <div class="mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Gestione CSV</h3>
                    <div class="flex gap-4">
                        <button onclick="showProductCsvImportModal()" class="filter-button primary">
                            <i class="fas fa-upload mr-1"></i>Carica da CSV
                        </button>
                        <button onclick="exportProductsToCsv()" class="filter-button secondary">
                            <i class="fas fa-download mr-1"></i>Estrai CSV
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Product Filters and List -->
            <div class="mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">I Miei Prodotti</h3>
                    
                    <!-- Product Filters -->
                    <div class="filter-section">
                        <!-- Search Bar - Separate row on desktop -->
                        <div class="mb-4 lg:mb-6">
                            <div class="filter-input-group">
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Cerca prodotti</label>
                                <input type="text" id="product-search-pharmacy" placeholder="Nome, SKU, produttore..." 
                                       class="filter-input w-full  lg:py-3 lg:px-4"
                                       onkeyup="applyProductFilters()"
                                       onchange="saveProductFilters()">
                            </div>
                        </div>
                        
                        <!-- Other Filters -->
                        <div class="flex flex-wrap gap-4 items-end">
                            <div class="filter-input-group min-w-0">
                                <label>Categorie</label>
                                <select id="filter-product-categories" multiple
                                        class="filter-input"
                                        onchange="applyProductFilters(); saveProductFilters();">
                                    <option value="analgesici">Analgesici e Antinfiammatori</option>
                                    <option value="antibiotici">Antibiotici</option>
                                    <option value="vitamine">Vitamine e Integratori</option>
                                    <option value="cosmetica">Cosmetica e Igiene</option>
                                    <option value="medicazioni">Medicazioni e Dispositivi</option>
                                </select>
                            </div>
                            
                            <div class="flex gap-2">
                                <div class="filter-input-group min-w-0">
                                    <label>Prezzo Min (â‚¬)</label>
                                    <input type="number" id="filter-product-price-min" placeholder="0.00" step="0.01" min="0"
                                           class="filter-input w-20"
                                           onchange="applyProductFilters(); saveProductFilters();">
                                </div>
                                <div class="filter-input-group min-w-0">
                                    <label>Prezzo Max (â‚¬)</label>
                                    <input type="number" id="filter-product-price-max" placeholder="999.99" step="0.01" min="0"
                                           class="filter-input w-20"
                                           onchange="applyProductFilters(); saveProductFilters();">
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <div class="filter-input-group min-w-0">
                                    <label>Stock Min</label>
                                    <input type="number" id="filter-product-stock-min" placeholder="0" min="0"
                                           class="filter-input w-20"
                                           onchange="applyProductFilters(); saveProductFilters();">
                                </div>
                                <div class="filter-input-group min-w-0">
                                    <label>Stock Max</label>
                                    <input type="number" id="filter-product-stock-max" placeholder="999" min="0"
                                           class="filter-input w-20"
                                           onchange="applyProductFilters(); saveProductFilters();">
                                </div>
                            </div>
                            
                            <div class="filter-input-group min-w-0">
                                <label>DisponibilitÃ </label>
                                <select id="filter-product-availability" 
                                        class="filter-input"
                                        onchange="applyProductFilters(); saveProductFilters();">
                                    <option value="">Tutti</option>
                                    <option value="available">Disponibili</option>
                                    <option value="unavailable">Non disponibili</option>
                                    <option value="low-stock">Scorte basse (&lt;10)</option>
                                </select>
                            </div>
                            
                            <div class="filter-input-group min-w-0">
                                <label>Ricetta</label>
                                <select id="filter-product-prescription" 
                                        class="filter-input"
                                        onchange="applyProductFilters(); saveProductFilters();">
                                    <option value="">Tutti</option>
                                    <option value="required">Richiede ricetta</option>
                                    <option value="not-required">Senza ricetta</option>
                                </select>
                            </div>
                            
                            <div class="filter-input-group min-w-0">
                                <label>Stato</label>
                                <select id="filter-product-status" 
                                        class="filter-input"
                                        onchange="applyProductFilters(); saveProductFilters();">
                                    <option value="">Tutti</option>
                                    <option value="active">Attivi</option>
                                    <option value="inactive">Non attivi</option>
                                </select>
                            </div>
                            
                            <div class="filter-input-group min-w-0">
                                <label>Ordina per</label>
                                <select id="filter-product-sort-by" 
                                        class="filter-input"
                                        onchange="applyProductFilters(); saveProductFilters();">
                                    <option value="name">Nome A-Z</option>
                                    <option value="name-desc">Nome Z-A</option>
                                    <option value="price">Prezzo crescente</option>
                                    <option value="price-desc">Prezzo decrescente</option>
                                    <option value="stock">Stock crescente</option>
                                    <option value="stock-desc">Stock decrescente</option>
                                    <option value="created">PiÃ¹ vecchi</option>
                                    <option value="created-desc">PiÃ¹ recenti</option>
                                </select>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="clearProductFilters()" 
                                        class="filter-button secondary">
                                    <i class="fas fa-times"></i>Reset
                                </button>
                                <button onclick="applyProductFilters()" 
                                        class="filter-button primary">
                                    <i class="fas fa-filter"></i>Applica
                                </button>
                            </div>
                        </div>
                        <div id="product-filter-status" class="filter-status-indicator" style="display: none;">
                            <i class="fas fa-filter"></i>
                            <span>Filtri attivi</span>
                        </div>
                    </div>
                    
                    <!-- Products List -->
                    <div id="pharmacy-products-list" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-pills text-4xl mb-3"></i>
                            <p>Nessun prodotto trovato</p>
                        </div>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="product-pagination" class="mt-6 flex justify-center">
                        <!-- Pagination will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer id="footer" class="bg-green-600 text-gray-100 py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12">
                <div>
                    <img src="public/logo_eudora-noback.png" 
                         alt="Eudora Logo" 
                         class="h-16 object-contain mb-4">
                    <p class="mb-4">
                        Consegna di farmaci a domicilio semplice e sicura.
                    </p>
                    <div class="flex space-x-4">
                        <a href="https://www.facebook.com/people/Eudora-Pharma/61553006976233/" target="_blank" rel="noopener noreferrer" class="text-white hover:text-blue-400 text-xl">
                            <i class="fab fa-facebook"></i>
                        </a>
                        <a href="https://www.instagram.com/eudora_pharma?igsh=d2w4NzhqaWJtb3g=" target="_blank" rel="noopener noreferrer" class="text-white hover:text-blue-400 text-xl">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="https://www.linkedin.com/company/eudora-pharma/" target="_blank" rel="noopener noreferrer" class="text-white hover:text-blue-400 text-xl">
                            <i class="fab fa-linkedin"></i>
                        </a>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-bold text-white mb-2">Sede legale</h4>
                        <p class="text-gray-200 text-sm">Via Roma 10 , 87100 - Cosenza (CS)</p>
                    </div>
                </div>

                <div>
                    <h3 class="text-white font-bold text-lg mb-4">Contatti</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-phone-alt mt-1 mr-2 text-sm"></i>
                            <a href="tel:3500378569" class="hover:text-white transition">350 0378569</a>
                        </li>
                        <li class="flex items-start">
                            <i class="fab fa-whatsapp mt-1 mr-2 text-sm"></i>
                            <a href="whatsapp://send?phone=393500378569" onclick="this.href = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'whatsapp://send?phone=393500378569' : 'https://wa.me/393500378569'" target="_blank" rel="noopener noreferrer" class="hover:text-white transition">WhatsApp</a>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-envelope mt-1 mr-2 text-sm"></i>
                            <a href="mailto:Eudorabenessere@gmail.com" class="hover:text-white transition">Eudorabenessere@gmail.com</a>
                        </li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-white font-bold text-lg mb-4">Azienda</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start">
                            <a href="#hero" class="hover:text-white transition">Chi siamo?</a>
                        </li>
                        <li class="flex items-start">
                            <a href="#work-with-us" class="hover:text-white transition">Lavora con noi</a>
                        </li>
                        <li class="flex items-start">
                            <a href="#work-with-us" class="hover:text-white transition">Diventa Partner</a>
                        </li>
                        <li>
                            <a href="#" class="hover:text-white transition">CittÃ  attive</a>
                        </li>
                        <li>
                            <a href="#" class="hover:text-white transition">Missiona Futura</a>
                        </li>
                        <li>
                            <a href="#" class="hover:text-white transition">Progetto Calabria</a>
                        </li>
                    </ul>
                </div>

                

                <div>
                    <h3 class="text-white font-bold text-lg mb-4">Newsletter</h3>
                    <p class="text-gray-200 text-sm mb-4">
                        Iscriviti alla newsletter di Eudora per ricevere aggiornamenti e promozioni sul nostro servizio.
                    </p>
                    <form class="space-y-3" onsubmit="subscribeNewsletter(event)">
                        <div>
                            <input type="email" 
                                   id="newsletter-email"
                                   placeholder="La tua email" 
                                   required
                                   class="w-full px-3 py-2 bg-white text-gray-800 border border-gray-300 rounded-lg focus:outline-none focus:border-green-400 text-sm">
                        </div>
                        <div class="flex items-start space-x-2">
                            <input type="checkbox" 
                                   id="newsletter-consent"
                                   required
                                   class="mt-1 w-4 h-4 text-green-600 bg-white border-gray-300 rounded focus:ring-green-500">
                            <label for="newsletter-consent" class="text-xs text-gray-200 leading-tight">
                                *Presto il consenso al trattamento dei miei dati personali per la finalitÃ  di marketing cosÃ¬ come riportato nell'informativa ex art. 13 GDPR
                            </label>
                        </div>
                        <button type="submit" 
                                class="w-full bg-white text-green-600 py-2 px-4 rounded-lg hover:bg-gray-100 transition duration-300 text-sm font-medium">
                            <i class="fas fa-envelope mr-2"></i>
                            Iscriviti
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="border-t border-green-500 mt-12 pt-8 text-center text-sm">
                <!-- Policy Links -->
                <div class="flex flex-wrap justify-center items-center gap-4 md:gap-6 mb-4">
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Termini e condizioni</a>
                    <span class="text-gray-400">â€¢</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Privacy policy</a>
                    <span class="text-gray-400">â€¢</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Cookie policy</a>
                    <span class="text-gray-400">â€¢</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Aggiorna le tue preferenze di tracciamento</a>
                    <span class="text-gray-400">â€¢</span>
                    <a href="#" class="text-gray-200 hover:text-white transition text-xs md:text-sm">Preferenze pubblicitarie</a>
                </div>
                <p>&copy; 2025 Eudora. Tutti i diritti riservati.</p>
            </div>
        </div>
    </footer>

    <!-- Floating WhatsApp Button -->
    <a href="whatsapp://send?phone=393500378569" onclick="this.href = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'whatsapp://send?phone=393500378569' : 'https://wa.me/393500378569'" target="_blank" rel="noopener noreferrer"
       class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white w-16 h-16 rounded-full flex flex-col items-center justify-center shadow-lg z-50 transition transform hover:scale-110">
        <span class="text-xs font-semibold leading-none">Info</span>
        <i class="fab fa-whatsapp text-2xl mt-1"></i>
    </a>

    <!-- Modals and dynamic content containers -->
    <div id="modal-container"></div>

    <script>
        // Enhanced Notification System - Matching customer dashboard
        class PharmacyNotificationManager {
            constructor() {
                this.container = document.getElementById('notification-container');
                if (!this.container) {
                    console.warn('Notification container not found, creating one...');
                    this.container = document.createElement('div');
                    this.container.id = 'notification-container';
                    this.container.className = 'notification-container';
                    document.body.appendChild(this.container);
                }
            }

            show(type, title, message, duration = 5000, persistent = false) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const iconMap = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };

                notification.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-icon">
                            <i class="${iconMap[type] || iconMap.info} text-lg"></i>
                        </div>
                        <div class="notification-text">
                            <div class="notification-title">${title}</div>
                            <div class="notification-message">${message}</div>
                        </div>
                        <button class="notification-close" onclick="pharmacyNotificationManager.dismiss(this.parentElement.parentElement)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${!persistent ? '<div class="notification-progress"><div class="notification-progress-bar"></div></div>' : ''}
                `;

                this.container.appendChild(notification);
                
                // Trigger animation
                setTimeout(() => notification.classList.add('show'), 10);

                // Auto dismiss if not persistent
                if (!persistent && duration > 0) {
                    const progressBar = notification.querySelector('.notification-progress-bar');
                    if (progressBar) {
                        progressBar.style.transitionDuration = `${duration}ms`;
                        setTimeout(() => progressBar.style.transform = 'translateX(0)', 10);
                    }
                    
                    setTimeout(() => this.dismiss(notification), duration);
                }

                return notification;
            }

            dismiss(notification) {
                if (!notification) return;
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }

            success(title, message, duration = 5000) {
                return this.show('success', title, message, duration);
            }

            error(title, message, duration = 7000) {
                return this.show('error', title, message, duration);
            }

            warning(title, message, duration = 6000) {
                return this.show('warning', title, message, duration);
            }

            info(title, message, duration = 5000) {
                return this.show('info', title, message, duration);
            }
        }

        // Initialize the notification manager for the pharmacy dashboard
        const pharmacyNotificationManager = new PharmacyNotificationManager();
        
        // Make it available globally for compatibility
        window.notificationManager = pharmacyNotificationManager;

        // Loading Screen Manager - Matching customer dashboard
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('loading-overlay');
                this.loadingText = this.overlay.querySelector('.loading-text');
                this.loadingSubtitle = this.overlay.querySelector('.loading-subtitle');
                this.isVisible = true;
            }

            show(text = 'Caricamento...', subtitle = 'Attendere prego...') {
                if (this.loadingText) this.loadingText.textContent = text;
                if (this.loadingSubtitle) this.loadingSubtitle.textContent = subtitle;
                this.overlay.classList.remove('hidden');
                this.isVisible = true;
            }

            hide() {
                this.overlay.classList.add('hidden');
                this.isVisible = false;
            }

            updateText(text, subtitle) {
                if (this.loadingText) this.loadingText.textContent = text;
                if (this.loadingSubtitle) this.loadingSubtitle.textContent = subtitle;
            }
        }

        // Initialize the loading manager
        const loadingManager = new LoadingManager();
        window.loadingManager = loadingManager;

        // Enhanced initialization with proper error handling and loading states
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ¥ Initializing Pharmacy Dashboard...');
            
            // Initialize EudoraApp if not defined
            if (typeof window.EudoraApp === 'undefined') {
                window.EudoraApp = {
                    currentUser: null,
                    version: '2.0.0',
                    debug: true
                };
            }

            // Check for existing user authentication first
            console.log('ðŸ” Checking authentication state...');
            if (!window.EudoraApp.currentUser) {
                // Try to restore user from localStorage
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const userData = JSON.parse(savedUser);
                        window.EudoraApp.currentUser = userData;
                        console.log('âœ… Restored user from localStorage:', userData.email);
                    } catch (error) {
                        console.error('âŒ Error parsing saved user:', error);
                        localStorage.removeItem('currentUser');
                    }
                }
            }

            // Wait for all required modules to load
            let initializationAttempts = 0;
            const maxAttempts = 50; // 5 seconds

            const waitForModules = () => {
                initializationAttempts++;
                
                // Update loading message
                loadingManager.updateText(
                    'Caricamento Moduli...', 
                    `Tentativo ${initializationAttempts}/${maxAttempts} - Caricamento componenti necessari`
                );

                // Check if all required modules are loaded
                const modulesReady = typeof Database !== 'undefined' && 
                                   typeof SampleData !== 'undefined' && 
                                   typeof Auth !== 'undefined';
                                   // Note: Pharmacy module is optional - we'll check for it later

                if (modulesReady) {
                    console.log('âœ… Core modules loaded, proceeding with initialization...');
                    loadingManager.updateText('Inizializzazione...', 'Configurazione dell\'applicazione in corso');
                    setTimeout(() => initializeApp(), 500);
                } else if (initializationAttempts < maxAttempts) {
                    console.log(`â³ Waiting for modules... (${initializationAttempts}/${maxAttempts})`);
                    // Show which modules are missing
                    const missingModules = [];
                    if (typeof Database === 'undefined') missingModules.push('Database');
                    if (typeof SampleData === 'undefined') missingModules.push('SampleData');
                    if (typeof Auth === 'undefined') missingModules.push('Auth');
                    console.log(`Missing modules: ${missingModules.join(', ')}`);
                    setTimeout(waitForModules, 100);
                } else {
                    console.error('âŒ Failed to load core modules within timeout');
                    loadingManager.hide();
                    pharmacyNotificationManager.error(
                        'Errore di Caricamento', 
                        'Alcuni moduli core non sono stati caricati correttamente. Ricarica la pagina.'
                    );
                }
            };

            const initializeApp = () => {
                try {
                    // Initialize database
                    console.log('ðŸ’¾ Initializing Database...');
                    loadingManager.updateText('Inizializzazione Database...', 'Configurazione del sistema di dati');
                    
                    if (typeof Database !== 'undefined' && typeof Database.init === 'function') {
                        Database.init();
                    } else {
                        console.warn('âš ï¸ Database module not available');
                        pharmacyNotificationManager.warning(
                            'Avviso Database', 
                            'Il modulo Database non Ã¨ disponibile. Alcune funzionalitÃ  potrebbero essere limitate.'
                        );
                    }

                    // Always load sample data before displaying orders
                    console.log('ðŸ“Š Loading sample data...');
                    loadingManager.updateText('Caricamento Dati...', 'Preparazione dei dati di test e prodotti');
                    
                    // Check if sample data already exists to prevent duplicate creation
                    let shouldCreateSampleData = true;
                    try {
                        const existingUsers = localStorage.getItem('eudora_users');
                        const existingProducts = localStorage.getItem('eudora_products');
                        
                        if (existingUsers && existingProducts) {
                            const users = JSON.parse(existingUsers);
                            const products = JSON.parse(existingProducts);
                            
                            if (users.length > 5 && products.length > 20) {
                                console.log('ðŸ“Š Sample data already exists, skipping recreation...');
                                shouldCreateSampleData = false;
                            }
                        }
                    } catch (error) {
                        console.warn('âš ï¸ Error checking existing data:', error);
                    }
                    
                    if (shouldCreateSampleData) {
                        // Clear existing data first to prevent localStorage quota issues
                        try {
                            console.log('ðŸ§¹ Clearing existing sample data to prevent quota issues...');
                            if (typeof Database !== 'undefined' && typeof Database.reset === 'function') {
                                Database.reset();
                            } else {
                                // Manual cleanup
                                localStorage.removeItem('eudora_users');
                                localStorage.removeItem('eudora_products');
                                localStorage.removeItem('eudora_orders');
                                localStorage.removeItem('eudora_cart');
                                localStorage.removeItem('eudora_notifications');
                                localStorage.removeItem('eudora_inventory');
                            }
                            console.log('âœ… Existing data cleared');
                        } catch (error) {
                            console.warn('âš ï¸ Error clearing existing data:', error);
                        }
                        
                        if (typeof SampleData !== 'undefined' && typeof SampleData.init === 'function') {
                            SampleData.init();
                            console.log('âœ… Sample data loaded successfully');
                        } else {
                            console.error('âŒ SampleData module not available');
                            loadingManager.hide();
                            pharmacyNotificationManager.error(
                                'Errore Dati', 
                                'Il modulo SampleData non Ã¨ disponibile. Impossibile caricare i dati di test.'
                            );
                            return;
                        }
                    } else {
                        console.log('âœ… Using existing sample data');
                        // Initialize database with existing data
                        if (typeof Database !== 'undefined' && typeof Database.init === 'function') {
                            Database.init();
                        }
                    }

                    // Check if user is logged in and is a pharmacy
                    loadingManager.updateText('Verifica Autenticazione...', 'Controllo delle credenziali utente');
                    
                    let currentUser = null;
                    if (typeof Auth !== 'undefined' && typeof Auth.getCurrentUser === 'function') {
                        currentUser = Auth.getCurrentUser();
                    }

                    if (!currentUser || currentUser.role !== 'pharmacy') {
                        console.log('âŒ No valid pharmacy user found, creating/loading demo user...');
                        
                        // Try to create demo pharmacy user if not exists
                        let demoUser = null;
                        if (typeof Database !== 'undefined' && typeof Database.getUserByEmail === 'function') {
                            demoUser = Database.getUserByEmail('farmacia.centrale@email.com');
                        }
                        
                        if (!demoUser) {
                            console.log('ðŸŽ­ Creating demo pharmacy user...');
                            try {
                                if (typeof Database !== 'undefined' && typeof Database.createUser === 'function') {
                                    const userId = Database.createUser({
                                        email: 'farmacia.centrale@email.com',
                                        password: 'password123',
                                        role: 'pharmacy',
                                        firstName: 'Farmacia',
                                        lastName: 'Centrale',
                                        phone: '+39 06 1234567',
                                        isActive: true,
                                        pharmacyName: 'Farmacia Centrale',
                                        address: 'Via Roma 123, Milano'
                                    });
                                    if (typeof Database.getUserById === 'function') {
                                        demoUser = Database.getUserById(userId);
                                    }
                                }
                            } catch (error) {
                                console.error('âŒ Error creating demo user:', error);
                            }
                        }

                        if (demoUser && demoUser.role === 'pharmacy') {
                            console.log('âœ… Using demo pharmacy user');
                            currentUser = demoUser;
                            window.EudoraApp.currentUser = demoUser;
                            localStorage.setItem('currentUser', JSON.stringify(demoUser));
                            pharmacyNotificationManager.success(
                                'Demo Mode', 
                                'Accesso automatico come farmacia demo: Farmacia Centrale'
                            );
                        } else {
                            pharmacyNotificationManager.error(
                                'Accesso Negato', 
                                'Devi essere loggato come farmacia per accedere a questa pagina'
                            );
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 2000);
                            return;
                        }
                    }

                    // Update user name in header
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement && currentUser) {
                        userNameElement.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                    }

                    // Show test data indicator if using demo user
                    if (currentUser && currentUser.email === 'farmacia.centrale@email.com') {
                        const testDataIndicator = document.getElementById('test-data-indicator');
                        if (testDataIndicator) {
                            testDataIndicator.classList.remove('hidden');
                        }
                    }

                    // Initialize pharmacy module if available
                    loadingManager.updateText('Inizializzazione Farmacia...', 'Configurazione del dashboard farmacia');
                    
                    if (typeof Pharmacy !== 'undefined' && typeof Pharmacy.init === 'function') {
                        console.log('ðŸ¥ Initializing Pharmacy module...');
                        try {
                            Pharmacy.init();
                            console.log('âœ… Pharmacy module initialized successfully');
                        } catch (error) {
                            console.error('âŒ Error initializing Pharmacy module:', error);
                            pharmacyNotificationManager.warning(
                                'Modulo Farmacia', 
                                `Errore nell'inizializzazione del modulo Pharmacy: ${error.message}`
                            );
                        }
                    } else {
                        console.warn('âš ï¸ Pharmacy module not available, using basic functionality');
                        pharmacyNotificationManager.warning(
                            'Modulo Farmacia', 
                            'Il modulo Pharmacy non Ã¨ disponibile. Utilizzando funzionalitÃ  di base.'
                        );
                    }

                    // Hide loading screen and show success message
                    setTimeout(() => {
                        loadingManager.hide();
                        pharmacyNotificationManager.success(
                            'Dashboard Caricata', 
                            'Benvenuto nella dashboard farmacia!'
                        );
                        console.log('âœ… Pharmacy Dashboard initialized successfully');
                        
                        // Load orders and products using our new functions
                        console.log('ðŸ“¦ Loading initial orders and products...');
                        
                        // Run diagnostic to see what's in the database
                        diagnosticCheck();
                        
                        // First, try to fix any missing pharmacy associations
                        fixPharmacyAssociations();
                        
                        // Then load the data immediately
                        setTimeout(() => {
                            // Force show some test products immediately
                            console.log('ðŸ“¦ Creating immediate test products for visibility...');
                            const testProducts = [
                                {
                                    id: 'test-1',
                                    name: 'Paracetamolo 500mg',
                                    description: 'Analgesico e antipiretico per febbre e dolore',
                                    price: 4.50,
                                    stock: 50,
                                    category: 'analgesici',
                                    categoryName: 'Analgesici e Antinfiammatori',
                                    isActive: true,
                                    inStock: true,
                                    requiresPrescription: false,
                                    sku: 'ANAPARAC001',
                                    manufacturer: 'Angelini',
                                    pharmacyId: 'test-pharmacy'
                                },
                                {
                                    id: 'test-2',
                                    name: 'Vitamina C 1000mg',
                                    description: 'Integratore di acido ascorbico',
                                    price: 8.90,
                                    stock: 30,
                                    category: 'vitamine',
                                    categoryName: 'Vitamine e Integratori',
                                    isActive: true,
                                    inStock: true,
                                    requiresPrescription: false,
                                    sku: 'VITC1000',
                                    manufacturer: 'Esi',
                                    pharmacyId: 'test-pharmacy'
                                }
                            ];
                            
                            // Store test products globally
                            window.allPharmacyProductsForManagement = testProducts;
                            
                            // Display them immediately
                            if (typeof updateProductsDisplay === 'function') {
                                updateProductsDisplay(testProducts);
                            } else {
                                console.log('ðŸ“‹ updateProductsDisplay function not available, using basic display');
                                const container = document.getElementById('pharmacy-products-list');
                                if (container) {
                                    container.innerHTML = `
                                        <div class="bg-white rounded-lg shadow p-4 mb-4">
                                            <h4 class="font-semibold text-lg">${testProducts[0].name}</h4>
                                            <p class="text-gray-600">${testProducts[0].description}</p>
                                            <p class="text-xl font-bold text-green-600">â‚¬${testProducts[0].price}</p>
                                        </div>
                                        <div class="bg-white rounded-lg shadow p-4 mb-4">
                                            <h4 class="font-semibold text-lg">${testProducts[1].name}</h4>
                                            <p class="text-gray-600">${testProducts[1].description}</p>
                                            <p class="text-xl font-bold text-green-600">â‚¬${testProducts[1].price}</p>
                                        </div>
                                    `;
                                }
                            }
                            
                            // Load products first since it's the default section
                            try {
                                if (typeof loadPharmacyProductsForManagement === 'function') {
                                    loadPharmacyProductsForManagement();
                                } else if (typeof loadPharmacyProducts === 'function') {
                                    loadPharmacyProducts();
                                }
                                console.log('âœ… Products loaded successfully');
                            } catch (error) {
                                console.error('âŒ Error loading products, using test data:', error);
                            }
                            
                            // Then load orders
                            try {
                                loadPharmacyOrders();
                                console.log('âœ… Orders loaded successfully');
                            } catch (error) {
                                console.error('âŒ Error loading orders:', error);
                            }
                            
                            // Restore saved filters after data is loaded
                            setTimeout(() => {
                                console.log('ðŸ”„ Restoring saved filters...');
                                
                                // Load and apply saved product filters
                                const savedProductFilters = loadProductFilters();
                                if (savedProductFilters) {
                                    console.log('âœ… Restored product filters, applying...');
                                    applyProductFilters();
                                    // Show restored status
                                    const filterCount = getActiveFilterCount();
                                    updateProductFilterStatus(filterCount, true);
                                }
                                
                                // Load and apply saved order filters  
                                const savedOrderFilters = loadOrderFilters();
                                if (savedOrderFilters) {
                                    console.log('âœ… Restored order filters, applying...');
                                    applyOrderFilters();
                                    // Show restored status
                                    const orderFilterCount = getActiveOrderFilterCount();
                                    updateOrderFilterStatus(orderFilterCount, true);
                                }
                                
                                if (savedProductFilters || savedOrderFilters) {
                                    pharmacyNotificationManager.info(
                                        'Filtri Ripristinati', 
                                        'I filtri precedenti sono stati ripristinati automaticamente'
                                    );
                                    
                                    // Remove "restored" indicator after 5 seconds
                                    setTimeout(() => {
                                        if (savedProductFilters) {
                                            const filterCount = getActiveFilterCount();
                                            updateProductFilterStatus(filterCount, false);
                                        }
                                        if (savedOrderFilters) {
                                            const orderFilterCount = getActiveOrderFilterCount();
                                            updateOrderFilterStatus(orderFilterCount, false);
                                        }
                                    }, 5000);
                                }
                                
                                // Force products section as default for testing
                                console.log('ðŸ“¦ Forcing products section as default...');
                                showPharmacySection('products');
                                
                                // FORCE ALL SECTIONS TO BE VISIBLE AND MAKE SURE COMPLETE UI LOADS
                                console.log('ðŸ”§ DEBUG: Ensuring complete product management UI is loaded...');
                                
                                // First, ensure the products section is visible
                                const productsSection = document.getElementById('pharmacy-products');
                                if (productsSection) {
                                    productsSection.classList.remove('hidden');
                                    productsSection.style.display = 'block';
                                    console.log('âœ… Products section made visible');
                                }
                                
                                // Force all product management subsections to be visible
                                const productForm = document.getElementById('pharmacy-product-form');
                                const productFormContainer = productForm?.closest('.mb-8');
                                const csvContainer = productFormContainer?.nextElementSibling;
                                const productsListContainer = csvContainer?.nextElementSibling;
                                
                                if (productFormContainer) {
                                    productFormContainer.style.display = 'block';
                                    productFormContainer.style.visibility = 'visible';
                                    productFormContainer.classList.remove('hidden');
                                    console.log('âœ… Product form container forced visible');
                                }
                                
                                if (csvContainer) {
                                    csvContainer.style.display = 'block';
                                    csvContainer.style.visibility = 'visible';
                                    csvContainer.classList.remove('hidden');
                                    console.log('âœ… CSV container forced visible');
                                }
                                
                                if (productsListContainer) {
                                    productsListContainer.style.display = 'block';
                                    productsListContainer.style.visibility = 'visible';
                                    productsListContainer.classList.remove('hidden');
                                    console.log('âœ… Products list container forced visible');
                                }
                                
                                // Also ensure all form elements are properly initialized
                                const formElements = [
                                    'product-name', 'product-price', 'product-stock',
                                    'product-category', 'product-description'
                                ];
                                
                                formElements.forEach(elementId => {
                                    const element = document.getElementById(elementId);
                                    if (element) {
                                        element.style.display = 'block';
                                        element.disabled = false;
                                    }
                                });
                                
                                // Show success notification
                                pharmacyNotificationManager.success(
                                    'Gestione Prodotti Completa', 
                                    'Form, controlli CSV e lista prodotti caricati correttamente!'
                                );
                                
                                // Initialize product management
                                if (typeof initializeProductManagement === 'function') {
                                    initializeProductManagement();
                                } else {
                                    console.log('âš ï¸ initializeProductManagement function not available');
                                }
                                
                                // Ensure products are always loaded in the pharmacy-products-list container
                                setTimeout(() => {
                                    console.log('ðŸ”„ Final check: ensuring products are loaded WITHOUT overwriting UI...');
                                    const productsContainer = document.getElementById('pharmacy-products-list');
                                    
                                    // IMPORTANT: Only load products if the container is empty or shows loading message
                                    // Don't overwrite the complete interface
                                    if (productsContainer) {
                                        const currentContent = productsContainer.innerHTML;
                                        if (currentContent.includes('Caricamento prodotti in corso...') || 
                                            currentContent.includes('Nessun prodotto') ||
                                            currentContent.trim() === '') {
                                            console.log('ðŸ“¦ Products container needs content, loading products...');
                                            loadPharmacyProducts();
                                        } else {
                                            console.log('âœ… Products container already has content, preserving it');
                                        }
                                    }
                                    
                                    // Final verification that all UI components are visible
                                    setTimeout(() => {
                                        console.log('ðŸ” Final UI verification...');
                                        const form = document.getElementById('pharmacy-product-form');
                                        const csvButtons = document.querySelector('button[onclick="showProductCsvImportModal()"]');
                                        const filterSection = document.querySelector('.filter-section');
                                        
                                        console.log('UI Components Status:');
                                        console.log('- Product Form:', form ? 'âœ… Present' : 'âŒ Missing');
                                        console.log('- CSV Controls:', csvButtons ? 'âœ… Present' : 'âŒ Missing');
                                        console.log('- Filter Section:', filterSection ? 'âœ… Present' : 'âŒ Missing');
                                        
                                        if (form && csvButtons && filterSection) {
                                            pharmacyNotificationManager.success(
                                                'UI Completa', 
                                                'Tutte le funzionalitÃ  di gestione prodotti sono attive!'
                                            );
                                        } else {
                                            console.warn('âš ï¸ Some UI components are missing');
                                        }
                                    }, 500);
                                }, 2000); // Increased delay to ensure UI is stable
                            }, 1000);
                        }, 500);
                        
                        // If Pharmacy module is available, also try to update the orders display (for compatibility)
                        if (typeof Pharmacy !== 'undefined' && typeof Pharmacy.updateOrdersDisplay === 'function') {
                            try {
                                Pharmacy.updateOrdersDisplay();
                            } catch (error) {
                                console.warn('âš ï¸ Error updating orders display with Pharmacy module:', error);
                            }
                        }
                    }, 1000);

                } catch (error) {
                    console.error('âŒ Error during initialization:', error);
                    loadingManager.hide();
                    pharmacyNotificationManager.error(
                        'Errore di Inizializzazione', 
                        `Si Ã¨ verificato un errore durante l'inizializzazione: ${error.message}`
                    );
                }
            };

            // Start the initialization process
            waitForModules();
        });

        // Enhanced logout function with notification and delay - Matching customer dashboard
        function logout() {
            // Show logout notification
            pharmacyNotificationManager.info('Logout', 'Disconnessione in corso...');
            
            // Delay to show notification, then logout and redirect
            setTimeout(() => {
                // Perform logout if Auth module is available
                if (typeof Auth !== 'undefined' && typeof Auth.logout === 'function') {
                    Auth.logout();
                } else {
                    // Fallback: clear localStorage
                    localStorage.removeItem('currentUser');
                    window.EudoraApp.currentUser = null;
                }
                
                // Redirect to login page
                window.location.href = 'login.html';
            }, 1000);
        }

        // Demo products loader function
        function loadDemoProducts() {
            console.log('ðŸŽ­ Loading demo products...');
            
            const demoProducts = [
                {
                    id: 'demo-001',
                    name: 'Tachipirina 500mg',
                    category: 'farmaci',
                    price: 8.50,
                    description: 'Analgesico e antipiretico per il trattamento di dolore e febbre',
                    stock: 50,
                    inStock: true,
                    isActive: true,
                    pharmacyName: 'Farmacia Centrale',
                    pharmacyId: 'demo-pharmacy',
                    sku: 'TAC500',
                    manufacturer: 'Angelini',
                    prescription: false
                },
                {
                    id: 'demo-002', 
                    name: 'Aspirina 100mg',
                    category: 'farmaci',
                    price: 6.20,
                    description: 'Antiaggregante piastrinico per la prevenzione cardiovascolare',
                    stock: 30,
                    inStock: true,
                    isActive: true,
                    pharmacyName: 'Farmacia Centrale',
                    pharmacyId: 'demo-pharmacy',
                    sku: 'ASP100',
                    manufacturer: 'Bayer',
                    prescription: false
                },
                {
                    id: 'demo-003',
                    name: 'Moment 200mg',
                    category: 'farmaci',
                    price: 12.30,
                    description: 'Antinfiammatorio non steroideo per dolori muscolari',
                    stock: 25,
                    inStock: true,
                    isActive: true,
                    pharmacyName: 'Farmacia Centrale',
                    pharmacyId: 'demo-pharmacy',
                    sku: 'MOM200',
                    manufacturer: 'Angelini',
                    prescription: false
                },
                {
                    id: 'demo-004',
                    name: 'Voltaren Gel',
                    category: 'farmaci',
                    price: 15.80,
                    description: 'Gel antinfiammatorio per uso topico',
                    stock: 0,
                    inStock: false,
                    isActive: true,
                    pharmacyName: 'Farmacia Centrale',
                    pharmacyId: 'demo-pharmacy',
                    sku: 'VOL-GEL',
                    manufacturer: 'Novartis',
                    prescription: false
                },
                {
                    id: 'demo-005',
                    name: 'Vitamina D3 1000 UI',
                    category: 'integratori',
                    price: 18.90,
                    description: 'Integratore alimentare di vitamina D3 per il benessere delle ossa',
                    stock: 40,
                    inStock: true,
                    isActive: true,
                    pharmacyName: 'Farmacia Centrale',
                    pharmacyId: 'demo-pharmacy',
                    sku: 'VIT-D3',
                    manufacturer: 'SoloVita',
                    prescription: false
                },
                {
                    id: 'demo-006',
                    name: 'Shampoo Antiforfora',
                    category: 'bellezza',
                    price: 14.50,
                    description: 'Shampoo specifico per il trattamento della forfora',
                    stock: 15,
                    inStock: true,
                    isActive: true,
                    pharmacyName: 'Farmacia Centrale',
                    pharmacyId: 'demo-pharmacy',
                    sku: 'SH-ANT',
                    manufacturer: 'Head & Shoulders',
                    prescription: false
                }
            ];
            
            updatePharmacyProductsDisplay(demoProducts);
            window.allPharmacyProducts = demoProducts;
            pharmacyNotificationManager.success('Demo Prodotti', `Caricati ${demoProducts.length} prodotti di esempio`);
            
            return demoProducts;
        }

        // Pharmacy section navigation
        function showPharmacySection(section) {
            // Hide all sections
            document.querySelectorAll('.pharmacy-section').forEach(s => s.classList.add('hidden'));
            
            // Remove active class from all tabs
            document.querySelectorAll('.pharmacy-tab').forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-blue-600');
                tab.classList.add('text-gray-600', 'border-transparent');
            });
            
            // Show selected section
            const sectionElement = document.getElementById(`pharmacy-${section}`);
            if (sectionElement) {
                sectionElement.classList.remove('hidden');
                // Ensure the management interface is always shown in products section
                if (section === 'products') {
                    sectionElement.style.display = 'block';
                    console.log('ðŸ“¦ Products section made visible with management interface');
                }
            }
            
            // Make selected tab active
            const activeTab = document.getElementById(`pharmacy-tab-${section}`);
            if (activeTab) {
                activeTab.classList.remove('text-gray-600', 'border-transparent');
                activeTab.classList.add('text-blue-600', 'border-blue-600');
            }
            
            // Load section-specific data
            if (section === 'products') {
                console.log('ðŸ“¦ Loading products for "Gestione Prodotti" section...');
                // Show loading indicator for products
                const productsContainer = document.getElementById('pharmacy-products-list');
                if (productsContainer) {
                    productsContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                            <p>Caricamento prodotti...</p>
                        </div>
                    `;
                } else {
                    console.warn('âš ï¸ Products container not found in showPharmacySection - proceeding anyway...');
                }
                // Initialize product management with small delay to ensure section is fully visible
                setTimeout(() => {
                    console.log('ðŸ”§ Forcing product management interface...');
                    try {
                        if (typeof initializeProductManagement === 'function') {
                            initializeProductManagement();
                        } else if (typeof loadPharmacyProductsForManagement === 'function') {
                            loadPharmacyProductsForManagement();
                        } else {
                            console.log('âš ï¸ Management functions not available, falling back to loadPharmacyProducts');
                            loadPharmacyProducts();
                        }
                    } catch (error) {
                        console.error('âŒ Error initializing product management:', error);
                        // If management fails, still try to load basic products
                        if (typeof loadPharmacyProducts === 'function') {
                            loadPharmacyProducts();
                        }
                    }
                }, 200);
            } else if (section === 'orders') {
                console.log('ðŸ“‹ Loading orders for orders section...');
                // Load orders immediately (they're usually cached)
                loadPharmacyOrders();
            }
            
            // Save the active section to localStorage
            try {
                localStorage.setItem('pharmacy_active_section', section);
                console.log('ðŸ’¾ Saved active section:', section);
            } catch (error) {
                console.warn('âš ï¸ Could not save active section:', error);
            }
        }

        // Restore the active section from localStorage
        function restoreActiveSection() {
            try {
                const savedSection = localStorage.getItem('pharmacy_active_section');
                if (savedSection && (savedSection === 'orders' || savedSection === 'products')) {
                    console.log('ðŸ“‚ Restoring active section:', savedSection);
                    showPharmacySection(savedSection);
                    return savedSection;
                }
            } catch (error) {
                console.warn('âš ï¸ Could not restore active section:', error);
            }
            return null;
        }

        // Placeholder functions for product management
        function loadProductsNow() {
            console.log('ðŸš€ Force loading products and switching to products tab...');
            
            // Switch to products tab
            showPharmacySection('products');
            
            // Force reload products with a small delay to ensure tab is switched
            setTimeout(() => {
                loadPharmacyProducts();
                pharmacyNotificationManager.success('Prodotti Caricati', 'I prodotti sono stati caricati con successo');
            }, 200);
        }
        
        // Expose loadProductsNow globally for easy access
        window.loadProductsNow = loadProductsNow;

        // Utility function to safely access DOM elements with retry mechanism
        function safeGetElement(elementId, retries = 3, delay = 100) {
            return new Promise((resolve) => {
                let attempts = 0;
                
                const tryGetElement = () => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        resolve(element);
                        return;
                    }
                    
                    attempts++;
                    if (attempts < retries) {
                        setTimeout(tryGetElement, delay);
                    } else {
                        console.warn(`âš ï¸ Element ${elementId} not found after ${retries} attempts`);
                        resolve(null);
                    }
                };
                
                tryGetElement();
            });
        }

        // Test function to verify DOM elements are accessible
        function testProductsContainerAccess() {
            const container = document.getElementById('pharmacy-products-list');
            const section = document.getElementById('pharmacy-products');
            
            console.log('ðŸ§ª Testing products container access:');
            console.log('  - pharmacy-products-list:', container ? 'âœ… Found' : 'âŒ Not found');
            console.log('  - pharmacy-products:', section ? 'âœ… Found' : 'âŒ Not found');
            console.log('  - section hidden:', section ? section.classList.contains('hidden') : 'N/A');
            
            return container !== null;
        }

        // Make test function globally accessible for debugging
        window.testProductsContainerAccess = testProductsContainerAccess;
        function editPharmacyProduct(id) {
            console.log('Edit product:', id);
            pharmacyNotificationManager.info('Modifica Prodotto', `Modifica del prodotto ID: ${id} non ancora implementata`);
        }

        function deletePharmacyProduct(id) {
            console.log('Delete product:', id);
            pharmacyNotificationManager.warning('Elimina Prodotto', `Eliminazione del prodotto ID: ${id} non ancora implementata`);
        }

        function showPharmacyCsvImportModal() {
            console.log('Show CSV import modal');
            pharmacyNotificationManager.info('Importa CSV', 'FunzionalitÃ  di importazione CSV non ancora implementata');
        }

        function exportPharmacyProductsToCsv() {
            console.log('Export products to CSV');
            pharmacyNotificationManager.info('Esporta CSV', 'FunzionalitÃ  di esportazione CSV non ancora implementata');
        }

        // Load products from "Farmacia Centrale" specifically from database
        function loadPharmacyProducts() {
            console.log('ðŸ¥ Loading Farmacia Centrale products from database...');
            
            try {
                if (typeof Database === 'undefined') {
                    console.error('âŒ Database module not available, using fallback data');
                    pharmacyNotificationManager.warning('Database Error', 'Database module not available - Using demo data');
                    
                    // Provide fallback demo products
                    const fallbackProducts = [
                        {
                            id: 'prod-001',
                            name: 'Tachipirina 500mg',
                            category: 'farmaci',
                            price: 8.50,
                            description: 'Analgesico e antipiretico per il trattamento di dolore e febbre',
                            stock: 50,
                            inStock: true,
                            isActive: true,
                            pharmacyName: 'Farmacia Centrale',
                            pharmacyId: 'demo-pharmacy',
                            sku: 'TAC500',
                            manufacturer: 'Angelini',
                            prescription: false
                        },
                        {
                            id: 'prod-002', 
                            name: 'Aspirina 100mg',
                            category: 'farmaci',
                            price: 6.20,
                            description: 'Antiaggregante piastrinico per la prevenzione cardiovascolare',
                            stock: 30,
                            inStock: true,
                            isActive: true,
                            pharmacyName: 'Farmacia Centrale',
                            pharmacyId: 'demo-pharmacy',
                            sku: 'ASP100',
                            manufacturer: 'Bayer',
                            prescription: false
                        },
                        {
                            id: 'prod-003',
                            name: 'Moment 200mg',
                            category: 'farmaci',
                            price: 12.30,
                            description: 'Antinfiammatorio non steroideo per dolori muscolari',
                            stock: 25,
                            inStock: true,
                            isActive: true,
                            pharmacyName: 'Farmacia Centrale',
                            pharmacyId: 'demo-pharmacy',
                            sku: 'MOM200',
                            manufacturer: 'Angelini',
                            prescription: false
                        },
                        {
                            id: 'prod-004',
                            name: 'Voltaren Gel',
                            category: 'farmaci',
                            price: 15.80,
                            description: 'Gel antinfiammatorio per uso topico',
                            stock: 0,
                            inStock: false,
                            isActive: true,
                            pharmacyName: 'Farmacia Centrale',
                            pharmacyId: 'demo-pharmacy',
                            sku: 'VOL-GEL',
                            manufacturer: 'Novartis',
                            prescription: false
                        },
                        {
                            id: 'prod-005',
                            name: 'Vitamina D3',
                            category: 'integratori',
                            price: 18.90,
                            description: 'Integratore alimentare di vitamina D3',
                            stock: 40,
                            inStock: true,
                            isActive: true,
                            pharmacyName: 'Farmacia Centrale',
                            pharmacyId: 'demo-pharmacy',
                            sku: 'VIT-D3',
                            manufacturer: 'SoloVita',
                            prescription: false
                        }
                    ];
                    
                    updatePharmacyProductsDisplay(fallbackProducts);
                    window.allPharmacyProducts = fallbackProducts;
                    return fallbackProducts;
                }

                // Find Farmacia Centrale user
                const farmacyCentraleUser = Database.getUserByEmail('farmacia.centrale@email.com');
                
                if (!farmacyCentraleUser) {
                    console.error('âŒ Farmacia Centrale user not found');
                    pharmacyNotificationManager.error('Errore', 'Farmacia Centrale non trovata nel database');
                    return [];
                }

                // Load ALL products from Farmacia Centrale only
                const allProducts = Database.getAllProducts();
                const farmacyCentraleProducts = allProducts.filter(product => 
                    product.pharmacyId === farmacyCentraleUser.id
                );
                
                console.log(`ðŸ’Š Loaded ${farmacyCentraleProducts.length} products from Farmacia Centrale`);
                
                // Update the products display with Farmacia Centrale products
                updatePharmacyProductsDisplay(farmacyCentraleProducts);
                
                // Store products for filtering
                window.allPharmacyProducts = farmacyCentraleProducts;
                
                // Also call Pharmacy module's loadProducts method if available
                if (typeof Pharmacy !== 'undefined' && typeof Pharmacy.loadProducts === 'function') {
                    console.log('ðŸ¥ Also calling Pharmacy module loadProducts...');
                    try {
                        Pharmacy.loadProducts();
                    } catch (error) {
                        console.warn('âš ï¸ Error calling Pharmacy.loadProducts:', error);
                    }
                }
                
                return farmacyCentraleProducts;
            } catch (error) {
                console.error('âŒ Error loading pharmacy products:', error);
                pharmacyNotificationManager.error('Errore Caricamento', `Errore nel caricamento prodotti: ${error.message}`);
                return [];
            }
        }

        // Load orders from database for the current pharmacy
        function loadPharmacyOrders() {
            console.log('ðŸ¥ Loading pharmacy orders from database...');
            
            try {
                if (typeof Database === 'undefined') {
                    console.error('âŒ Database module not available');
                    pharmacyNotificationManager.error('Database Error', 'Database module not available');
                    return [];
                }

                const currentUser = window.EudoraApp.currentUser;
                if (!currentUser || currentUser.role !== 'pharmacy') {
                    console.error('âŒ No valid pharmacy user found');
                    return [];
                }

                const pharmacyId = currentUser.pharmacyId || currentUser.id;
                console.log('ðŸ” DEBUG: Current user:', currentUser);
                console.log('ðŸ” DEBUG: Using pharmacy ID for orders:', pharmacyId);
                
                // Debug: Check all orders in database
                const allOrders = Database.getAllOrders();
                console.log('ðŸ” DEBUG: Total orders in database:', allOrders.length);
                console.log('ðŸ” DEBUG: Sample orders:', allOrders.slice(0, 3));
                
                // Load orders for this pharmacy
                const orders = Database.getOrdersByPharmacy(pharmacyId);
                console.log(`ðŸ“¦ Loaded ${orders.length} orders for pharmacy ${pharmacyId}`);
                
                // Debug: Try manual filtering if no orders found
                if (orders.length === 0) {
                    console.log('ðŸ” DEBUG: No orders found with getOrdersByPharmacy, trying manual filter...');
                    const manualFilteredOrders = allOrders.filter(order => 
                        order.pharmacyId === pharmacyId || 
                        order.pharmacyId === currentUser.id ||
                        !order.pharmacyId // Include orders without pharmacy assignment
                    );
                    console.log('ðŸ” DEBUG: Manual filtered orders:', manualFilteredOrders.length);
                    
                    if (manualFilteredOrders.length > 0) {
                        updatePharmacyOrdersDisplay(manualFilteredOrders);
                        updateNotificationBell(manualFilteredOrders);
                        return manualFilteredOrders;
                    }
                }
                
                // Update the orders display
                updatePharmacyOrdersDisplay(orders);
                
                // Update notification bell
                updateNotificationBell(orders);
                
                return orders;
            } catch (error) {
                console.error('âŒ Error loading pharmacy orders:', error);
                pharmacyNotificationManager.error('Errore Caricamento', `Errore nel caricamento ordini: ${error.message}`);
                return [];
            }
        }

        // Update notification bell when orders are created or status changes
        function updateNotificationBell(orders = null) {
            console.log('ðŸ”” Updating notification bell...');
            
            try {
                const currentUser = window.EudoraApp.currentUser;
                if (!currentUser || currentUser.role !== 'pharmacy') {
                    return;
                }

                // Get order-related notifications instead of orders
                const orderNotifications = getOrderNotifications();
                
                // Count unread order notifications
                const unreadOrderNotifications = orderNotifications.filter(notif => !notif.read);
                
                const notificationBadge = document.getElementById('notification-badge');
                const pharmacyOrdersBadge = document.getElementById('pharmacy-orders-badge');
                
                if (unreadOrderNotifications.length > 0) {
                    // Show notification badge with unread order notifications count
                    if (notificationBadge) {
                        notificationBadge.textContent = unreadOrderNotifications.length;
                        notificationBadge.classList.remove('hidden');
                    }
                    
                    // Also update orders tab badge if there are pending orders
                    if (!orders) {
                        if (typeof Database !== 'undefined') {
                            const pharmacyId = currentUser.pharmacyId || currentUser.id;
                            orders = Database.getOrdersByPharmacy(pharmacyId);
                        }
                    }
                    
                    if (orders) {
                        const pendingOrders = orders.filter(order => 
                            order.status === 'pending' || order.status === 'accepted'
                        );
                        
                        if (pharmacyOrdersBadge && pendingOrders.length > 0) {
                            pharmacyOrdersBadge.textContent = pendingOrders.length;
                            pharmacyOrdersBadge.classList.remove('hidden');
                        } else if (pharmacyOrdersBadge) {
                            pharmacyOrdersBadge.classList.add('hidden');
                        }
                    }
                    
                    console.log(`ðŸ”” Notification bell updated: ${unreadOrderNotifications.length} unread order notifications`);
                } else {
                    // Hide notification badges
                    if (notificationBadge) {
                        notificationBadge.classList.add('hidden');
                    }
                    
                    if (pharmacyOrdersBadge) {
                        pharmacyOrdersBadge.classList.add('hidden');
                    }
                    
                    console.log('ðŸ”” No unread order notifications, notification badges hidden');
                }
                
                // Optional: Add visual pulse effect for new order notifications
                const notificationBell = document.getElementById('notification-bell');
                if (notificationBell && unreadOrderNotifications.length > 0) {
                    notificationBell.classList.add('animate-pulse');
                    // Add a more prominent animation for new notifications
                    notificationBell.style.animation = 'pulse 1s infinite, bounce 0.5s ease-in-out 3';
                    setTimeout(() => {
                        notificationBell.classList.remove('animate-pulse');
                        notificationBell.style.animation = '';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('âŒ Error updating notification bell:', error);
            }
        }

        // Helper function to get product status tag
        function getProductStatusTag(product) {
            if (product.isActive === false) {
                return '<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">Inattivo</span>';
            } else if (product.stock === 0) {
                return '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Esaurito</span>';
            } else {
                return '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Attivo</span>';
            }
        }

        // Helper function to get product border color
        function getProductBorderColor(product) {
            if (product.isActive === false) {
                return 'border-gray-400';
            } else if (product.stock === 0) {
                return 'border-red-400';
            } else {
                return 'border-green-400';
            }
        }

        // Helper function to get product status text color
        function getProductStatusTextColor(product) {
            if (product.isActive === false) {
                return 'text-gray-600';
            } else if (product.stock === 0) {
                return 'text-red-600';
            } else {
                return 'text-green-600';
            }
        }

        // Helper function to get product status text
        function getProductStatusText(product) {
            if (product.isActive === false) {
                return 'Inattivo';
            } else if (product.stock === 0) {
                return 'Esaurito';
            } else {
                return `Disponibile${product.stock ? ` (${product.stock})` : ''}`;
            }
        }

        // Helper function to update products display
        function updatePharmacyProductsDisplay(products) {
            const productsContainer = document.getElementById('pharmacy-products-list');
            const totalProductsSpan = document.getElementById('pharmacy-total-products');
            const productsCountSpan = document.getElementById('pharmacy-products-count');
            
            if (!productsContainer) {
                console.warn('âš ï¸ Products container not found');
                return;
            }
            
            if (products.length === 0) {
                productsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-box-open text-4xl mb-3"></i>
                        <p>Nessun prodotto disponibile</p>
                        <p class="text-sm mt-2">Aggiungi prodotti al tuo inventario per iniziare</p>
                    </div>
                `;
                if (totalProductsSpan) totalProductsSpan.textContent = '0';
                if (productsCountSpan) productsCountSpan.textContent = 'Mostrando 0 prodotti';
                return;
            }

            productsContainer.innerHTML = products.map(product => `
                <div class="bg-white rounded-lg shadow-md p-6 mb-4 border-l-4 ${getProductBorderColor(product)}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-gray-800">${product.name}</h3>
                            <p class="text-gray-600 text-sm">${product.category || 'Categoria non specificata'}</p>
                            <p class="text-gray-600 mt-1">${product.description || 'Nessuna descrizione'}</p>
                            ${product.pharmacyName ? `<p class="text-blue-600 text-sm mt-1"><i class="fas fa-clinic-medical mr-1"></i>${product.pharmacyName}</p>` : ''}
                        </div>
                        <div class="text-right ml-4">
                            <div class="text-lg font-bold text-gray-800">â‚¬${product.price.toFixed(2)}</div>
                            <div class="text-sm ${getProductStatusTextColor(product)}">
                                ${getProductStatusText(product)}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Product Details -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                        <div>
                            <span class="text-gray-500 block">Categoria:</span>
                            <span class="font-medium">${product.category || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="text-gray-500 block">SKU:</span>
                            <span class="font-medium">${product.sku || product.id}</span>
                        </div>
                        <div>
                            <span class="text-gray-500 block">Produttore:</span>
                            <span class="font-medium">${product.manufacturer || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="text-gray-500 block">Scadenza:</span>
                            <span class="font-medium">${product.expiryDate ? new Date(product.expiryDate).toLocaleDateString('it-IT') : 'N/A'}</span>
                        </div>
                    </div>
                    
                    <!-- Product Tags -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${product.prescription ? '<span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Ricetta richiesta</span>' : ''}
                        ${getProductStatusTag(product)}
                        ${product.category ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${product.category}</span>` : ''}
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <div class="text-sm text-gray-500">
                            <span>ID: ${product.id}</span>
                            ${product.batchNumber ? ` â€¢ Lotto: ${product.batchNumber}` : ''}
                        </div>
                        <div class="space-x-2">
                            <button onclick="editPharmacyProduct('${product.id}')" 
                                    class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition">
                                <i class="fas fa-edit mr-1"></i> Modifica
                            </button>
                            <button onclick="toggleProductStock('${product.id}')" 
                                    class="bg-${product.stock > 0 ? 'red' : 'green'}-500 text-white px-3 py-1 rounded text-sm hover:bg-${product.stock > 0 ? 'red' : 'green'}-600 transition">
                                <i class="fas fa-${product.stock > 0 ? 'times' : 'check'} mr-1"></i> 
                                ${product.stock > 0 ? 'Disabilita' : 'Abilita'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Update counters
            if (totalProductsSpan) totalProductsSpan.textContent = products.length.toString();
            if (productsCountSpan) {
                const showing = Math.min(products.length, 10); // Assuming we show max 10 per page
                productsCountSpan.textContent = `Mostrando 1-${showing} di ${products.length} prodotti`;
            }
        }

        // Helper function to update orders display - Matching Customer Dashboard Structure
        function updatePharmacyOrdersDisplay(orders) {
            const ordersContainer = document.getElementById('pharmacy-orders-list');
            
            if (!ordersContainer) {
                console.warn('âš ï¸ Orders container not found');
                return;
            }

            if (orders.length === 0) {
                ordersContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>Nessun ordine disponibile</p>
                        <p class="text-sm mt-2">Gli ordini appariranno qui quando verranno creati</p>
                    </div>
                `;
                return;
            }

            // Sort orders by creation date (newest first)
            const sortedOrders = orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            ordersContainer.innerHTML = sortedOrders.map(order => `
                <div class="bg-white rounded-lg shadow-md p-6 mb-4 order-card-${order.status}">
                    <!-- Header dell'ordine -->
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-4">
                        <div class="mb-3 sm:mb-0">
                            <h3 class="text-lg font-semibold text-gray-800">Ordine #${order.id}</h3>
                            <p class="text-sm text-gray-600">${new Date(order.createdAt).toLocaleDateString('it-IT')}</p>
                        </div>
                        <div class="flex justify-between sm:text-right sm:block">
                            <span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${getOrderStatusClasses(order.status)}">
                                ${getOrderStatusText(order.status)}
                            </span>
                            <p class="text-lg font-bold text-gray-800 sm:mt-1">â‚¬${order.total.toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <!-- Prodotti -->
                    <div class="border-t pt-4 mb-4">
                        <h4 class="font-medium text-gray-700 mb-3">Prodotti:</h4>
                        <div class="space-y-2">
                            ${order.items.map(item => `
                                <div class="flex justify-between items-center text-sm">
                                    <div class="flex-1 mr-3">
                                        <span class="block font-medium">${item.name}</span>
                                        <span class="text-gray-500 text-xs">QuantitÃ : ${item.quantity}</span>
                                    </div>
                                    <span class="font-semibold">â‚¬${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Dettagli ordine -->
                    <div class="border-t pt-4">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- Informazioni consegna -->
                            <div class="space-y-3 text-sm">
                                <div class="flex items-start">
                                    <i class="fas fa-user text-gray-400 mr-2 mt-0.5" aria-hidden="true"></i>
                                    <div>
                                        <span class="font-medium text-gray-700">Cliente:</span>
                                        <span class="block text-gray-600">${order.customerName || 'Cliente'}</span>
                                        ${order.customerPhone ? `<span class="block text-gray-500 text-xs">${order.customerPhone}</span>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-map-marker-alt text-gray-400 mr-2 mt-0.5" aria-hidden="true"></i>
                                    <div>
                                        <span class="font-medium text-gray-700">Consegna:</span>
                                        <span class="block text-gray-600">${formatDeliveryAddress(order.deliveryAddress)}</span>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-credit-card text-blue-600 mr-2 mt-0.5" aria-hidden="true"></i>
                                    <div>
                                        <span class="font-medium text-gray-700">Pagamento:</span>
                                        <span class="block text-gray-600">${formatPaymentMethod(order.paymentMethod)}</span>
                                    </div>
                                </div>
                                ${order.notes ? `
                                    <div class="flex items-start">
                                        <i class="fas fa-sticky-note text-gray-400 mr-2 mt-0.5" aria-hidden="true"></i>
                                        <div>
                                            <span class="font-medium text-gray-700">Note:</span>
                                            <span class="block text-gray-600">${order.notes}</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Azioni ordine -->
                            <div class="flex flex-col lg:items-end space-y-2">
                                ${getOrderActionButtons(order)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Helper functions for order display
        function formatDeliveryAddress(deliveryAddress) {
            if (!deliveryAddress) {
                return 'Indirizzo non specificato';
            }
            
            // If it's already a string, return it
            if (typeof deliveryAddress === 'string') {
                return deliveryAddress;
            }
            
            // If it's an object, format it properly
            if (typeof deliveryAddress === 'object') {
                const parts = [];
                if (deliveryAddress.street) parts.push(deliveryAddress.street);
                if (deliveryAddress.city) parts.push(deliveryAddress.city);
                if (deliveryAddress.zipCode) parts.push(deliveryAddress.zipCode);
                
                return parts.length > 0 ? parts.join(', ') : 'Indirizzo non specificato';
            }
            
            return 'Indirizzo non specificato';
        }

        function formatPaymentMethod(paymentMethod) {
            if (!paymentMethod) {
                return 'Carta di Credito/Debito';
            }
            
            // If it's already a string, return it
            if (typeof paymentMethod === 'string') {
                return paymentMethod;
            }
            
            // If it's an object, format it properly
            if (typeof paymentMethod === 'object') {
                // Handle different payment method object structures
                if (paymentMethod.type) {
                    switch (paymentMethod.type.toLowerCase()) {
                        case 'card':
                        case 'credit_card':
                        case 'debit_card':
                            return 'Carta di Credito/Debito';
                        case 'cash':
                        case 'contanti':
                            return 'Contanti';
                        case 'paypal':
                            return 'PayPal';
                        case 'bank_transfer':
                        case 'bonifico':
                            return 'Bonifico Bancario';
                        case 'satispay':
                            return 'Satispay';
                        default:
                            return paymentMethod.type;
                    }
                }
                
                // Handle direct method name
                if (paymentMethod.method) {
                    return formatPaymentMethod(paymentMethod.method);
                }
                
                // Handle name property
                if (paymentMethod.name) {
                    return paymentMethod.name;
                }
                
                // Fallback: try to extract any meaningful string from the object
                const keys = Object.keys(paymentMethod);
                for (const key of keys) {
                    if (typeof paymentMethod[key] === 'string' && paymentMethod[key].length > 0) {
                        return paymentMethod[key];
                    }
                }
            }
            
            return 'Carta di Credito/Debito';
        }

        function getOrderBorderColor(status) {
            const colors = {
                'pending': 'border-yellow-400',
                'accepted': 'border-blue-400',
                'preparing': 'border-blue-400',
                'ready': 'border-green-400',
                'delivered': 'border-gray-400',
                'cancelled': 'border-red-400'
            };
            return colors[status] || 'border-gray-300';
        }

        function getOrderStatusClasses(status) {
            const classes = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'accepted': 'bg-blue-100 text-blue-800',
                'preparing': 'bg-blue-100 text-blue-800',
                'ready': 'bg-green-100 text-green-800',
                'delivered': 'bg-gray-100 text-gray-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function getOrderStatusText(status) {
            const texts = {
                'pending': 'In Attesa',
                'accepted': 'Accettato',
                'preparing': 'In Preparazione',
                'ready': 'Pronto',
                'delivered': 'Consegnato',
                'cancelled': 'Cancellato'
            };
            return texts[status] || status;
        }

        function getOrderActionButtons(order) {
            switch (order.status) {
                case 'pending':
                    return `
                        <button onclick="acceptOrder('${order.id}')" class="w-full lg:w-auto bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 mb-2 lg:mb-0" aria-label="Accetta ordine ${order.id}">
                            <i class="fas fa-check mr-2" aria-hidden="true"></i>Accetta
                        </button>
                        <button onclick="rejectOrder('${order.id}')" class="w-full lg:w-auto bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" aria-label="Rifiuta ordine ${order.id}">
                            <i class="fas fa-times mr-2" aria-hidden="true"></i>Rifiuta
                        </button>
                    `;
                case 'accepted':
                    return `
                        <button onclick="markOrderReady('${order.id}')" class="w-full lg:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" aria-label="Segna come pronto ordine ${order.id}">
                            <i class="fas fa-check-circle mr-2" aria-hidden="true"></i>Segna come Pronto
                        </button>
                    `;
                case 'ready':
                    return `
                        <button onclick="completeOrder('${order.id}')" class="w-full lg:w-auto bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" aria-label="Segna come consegnato ordine ${order.id}">
                            <i class="fas fa-truck mr-2" aria-hidden="true"></i>Segna come Consegnato
                        </button>
                    `;
                default:
                    return '';
            }
        }

        // Functions to interact with Pharmacy module (if available)
        function acceptOrder(orderId) {
            if (typeof Pharmacy !== 'undefined' && typeof Pharmacy.acceptOrder === 'function') {
                Pharmacy.acceptOrder(orderId);
            } else {
                console.warn('âš ï¸ Pharmacy module not available');
                pharmacyNotificationManager.warning('Modulo Non Disponibile', 'Il modulo Pharmacy non Ã¨ caricato');
            }
            // Refresh orders and notification bell
            setTimeout(() => {
                loadPharmacyOrders();
            }, 500);
        }

        function rejectOrder(orderId) {
            if (typeof Pharmacy !== 'undefined' && typeof Pharmacy.showRejectModal === 'function') {
                Pharmacy.showRejectModal(orderId);
            } else {
                console.warn('âš ï¸ Pharmacy module not available');
                pharmacyNotificationManager.warning('Modulo Non Disponibile', 'Il modulo Pharmacy non Ã¨ caricato');
            }
            // Refresh orders and notification bell
            setTimeout(() => {
                loadPharmacyOrders();
            }, 500);
        }

        function markOrderReady(orderId) {
            if (typeof Pharmacy !== 'undefined' && typeof Pharmacy.markOrderReady === 'function') {
                Pharmacy.markOrderReady(orderId);
            } else {
                console.warn('âš ï¸ Pharmacy module not available');
                pharmacyNotificationManager.warning('Modulo Non Disponibile', 'Il modulo Pharmacy non Ã¨ caricato');
            }
            // Refresh orders and notification bell
            setTimeout(() => {
                loadPharmacyOrders();
            }, 500);
        }

        function completeOrder(orderId) {
            if (typeof Pharmacy !== 'undefined' && typeof Pharmacy.completeOrder === 'function') {
                Pharmacy.completeOrder(orderId);
            } else {
                console.warn('âš ï¸ Pharmacy module not available');
                pharmacyNotificationManager.warning('Modulo Non Disponibile', 'Il modulo Pharmacy non Ã¨ caricato');
            }
            // Refresh orders and notification bell
            setTimeout(() => {
                loadPharmacyOrders();
            }, 500);
        }

        function toggleProductStock(productId) {
            if (typeof Pharmacy !== 'undefined' && typeof Pharmacy.toggleProductStock === 'function') {
                Pharmacy.toggleProductStock(productId);
            } else {
                console.warn('âš ï¸ Pharmacy module not available');
                pharmacyNotificationManager.warning('Modulo Non Disponibile', 'Il modulo Pharmacy non Ã¨ caricato');
            }
            // Refresh products
            setTimeout(() => {
                loadPharmacyProducts();
            }, 500);
        }

        // Enhanced auto-refresh functions for real-time updates
        let lastOrderCount = 0;
        let lastNotificationCount = 0;

        function startAutoRefresh() {
            console.log('ðŸ”„ Starting smart auto-refresh system...');
            
            // Check for new orders and notifications every 10 seconds
            setInterval(() => {
                if (window.EudoraApp.currentUser && window.EudoraApp.currentUser.role === 'pharmacy') {
                    checkForNewOrdersAndNotifications();
                }
            }, 10000);

            console.log('ðŸ”„ Smart refresh: Checking every 10 seconds for new orders');

            // Full refresh every 5 minutes (fallback)
            setInterval(() => {
                if (window.EudoraApp.currentUser && window.EudoraApp.currentUser.role === 'pharmacy') {
                    console.log('ðŸ”„ Performing scheduled full refresh...');
                    loadPharmacyOrders();
                }
            }, 300000);
        }

        function checkForNewOrdersAndNotifications() {
            try {
                if (typeof Database === 'undefined') {
                    return;
                }

                const currentUser = window.EudoraApp.currentUser;
                if (!currentUser || currentUser.role !== 'pharmacy') {
                    return;
                }

                const pharmacyId = currentUser.pharmacyId || currentUser.id;
                
                // Get current orders
                const currentOrders = Database.getOrdersByPharmacy(pharmacyId);
                const currentOrderCount = currentOrders.length;
                
                // Check for new orders
                if (lastOrderCount > 0 && currentOrderCount > lastOrderCount) {
                    const newOrdersCount = currentOrderCount - lastOrderCount;
                    console.log(`ðŸ†• ${newOrdersCount} new order(s) detected!`);
                    
                    // Show notification for new orders
                    pharmacyNotificationManager.success(
                        'Nuovo Ordine!', 
                        `${newOrdersCount === 1 ? 'Ãˆ arrivato un nuovo ordine' : `Sono arrivati ${newOrdersCount} nuovi ordini`}`,
                        7000, // Show longer for new orders
                        false
                    );
                    
                    // Play notification sound if available
                    playNotificationSound();
                    
                    // Add special highlighting to new orders
                    highlightNewOrders(currentOrders.slice(-newOrdersCount));
                    
                    // Update only the orders display and notification bell
                    updatePharmacyOrdersDisplay(currentOrders);
                    updateNotificationBell(currentOrders);
                    
                    // If filters are active, reapply them
                    if (typeof applyOrderFilters === 'function') {
                        const orderFilterCount = getActiveOrderFilterCount();
                        if (orderFilterCount > 0) {
                            console.log('ðŸ” Reapplying order filters for new orders...');
                            allPharmacyOrders = currentOrders; // Update the filter source
                            applyOrderFilters();
                        }
                    }
                }
                
                // Check for notifications - only order-related ones
                const orderNotifications = getOrderNotifications();
                const currentOrderNotificationCount = orderNotifications.filter(notif => !notif.read).length;
                
                if (lastNotificationCount > 0 && currentOrderNotificationCount > lastNotificationCount) {
                    const newNotificationsCount = currentOrderNotificationCount - lastNotificationCount;
                    console.log(`ðŸ”” ${newNotificationsCount} new order notification(s) detected!`);
                    
                    // Update notification bell
                    updateNotificationBell();
                    
                    // Play notification sound for new order notifications
                    playNotificationSound();
                }
                
                // Update counts for next check
                lastOrderCount = currentOrderCount;
                lastNotificationCount = currentOrderNotificationCount;
                
            } catch (error) {
                console.error('âŒ Error checking for new orders and notifications:', error);
            }
        }

        function initializeOrderCounts() {
            // Initialize the baseline counts
            try {
                if (typeof Database !== 'undefined' && window.EudoraApp.currentUser) {
                    const currentUser = window.EudoraApp.currentUser;
                    const pharmacyId = currentUser.pharmacyId || currentUser.id;
                    
                    const orders = Database.getOrdersByPharmacy(pharmacyId);
                    const orderNotifications = getOrderNotifications();
                    const unreadOrderNotifications = orderNotifications.filter(notif => !notif.read);
                    
                    lastOrderCount = orders.length;
                    lastNotificationCount = unreadOrderNotifications.length;
                    
                    console.log('ðŸ“Š Initialized order count:', lastOrderCount);
                    console.log('ðŸ“Š Initialized order notification count:', lastNotificationCount);
                }
            } catch (error) {
                console.warn('âš ï¸ Could not initialize order counts:', error);
            }
        }

        // Helper function to play notification sound
        function playNotificationSound() {
            try {
                // Create a simple notification sound using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                
                console.log('ðŸ”Š Notification sound played');
            } catch (error) {
                console.warn('âš ï¸ Could not play notification sound:', error);
            }
        }

        // Helper function to highlight new orders
        function highlightNewOrders(newOrders) {
            if (!newOrders || newOrders.length === 0) return;
            
            setTimeout(() => {
                newOrders.forEach(order => {
                    // Find the order element in the DOM and add highlight effect
                    const orderElements = document.querySelectorAll('[data-order-id]');
                    orderElements.forEach(element => {
                        if (element.dataset.orderId === order.id) {
                            element.classList.add('animate-pulse', 'bg-yellow-50', 'border-yellow-300');
                            setTimeout(() => {
                                element.classList.remove('animate-pulse', 'bg-yellow-50', 'border-yellow-300');
                            }, 5000);
                        }
                    });
                });
            }, 100);
        }

        // Manual function to check for new orders (for testing)
        function checkNow() {
            console.log('ðŸ” Manual check for new orders triggered...');
            checkForNewOrdersAndNotifications();
        }

        // Expose the manual check function globally
        window.checkNow = checkNow;

        // Initialize auto-refresh when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Initial load of data
                loadPharmacyOrders();
                loadPharmacyProducts();
                
                // Initialize baseline counts after data is loaded
                setTimeout(() => {
                    initializeOrderCounts();
                    startAutoRefresh();
                    console.log('âœ… Smart auto-refresh system started');
                }, 1000);
            }, 2000);
        });

        // Helper function to get order-related notifications only
        function getOrderNotifications() {
            try {
                const currentUser = window.EudoraApp.currentUser;
                if (!currentUser) return [];

                // Get all notifications for the current user
                const allNotifications = Database.getNotifications(currentUser.id);
                
                // Filter only order-related notifications (based on type)
                const orderNotifications = allNotifications.filter(notif => 
                    notif.type && (
                        notif.type.includes('order_') || 
                        notif.type === 'new_order' ||
                        notif.relatedId // Notifications with relatedId are typically order-related
                    )
                );

                // Sort by creation date (newest first) and take only last 3
                return orderNotifications
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 3);
                    
            } catch (error) {
                console.error('âŒ Error getting order notifications:', error);
                return [];
            }
        }

        // Helper function to format notification message according to specifications
        function formatNotificationMessage(notification) {
            try {
                const orderId = notification.relatedId || 'N/A';
                
                // Get order details if available
                let order = null;
                if (orderId !== 'N/A' && typeof Database !== 'undefined') {
                    try {
                        order = Database.getOrderById(orderId);
                    } catch (error) {
                        console.warn('âš ï¸ Could not get order details for notification:', error);
                    }
                }

                const userName = order?.customerName || 'Cliente';
                const riderName = order?.riderName || null;
                const status = order?.status || notification.type?.replace('order_', '') || 'unknown';
                
                // Format message based on notification type and status
                let message = '';
                
                switch (notification.type) {
                    case 'new_order':
                    case 'order_pending':
                        message = `Nuovo ordine! da ${userName}`;
                        break;
                    case 'order_accepted':
                        message = `Ordine ${orderId} accettato`;
                        break;
                    case 'order_ready':
                        if (riderName) {
                            message = `Il rider ${riderName} Ã¨ pronto al ritiro dell'ordine ${orderId}`;
                        } else {
                            message = `Ordine ${orderId} pronto per il ritiro`;
                        }
                        break;
                    case 'order_delivered':
                        message = `Ordine ${orderId} consegnato`;
                        break;
                    case 'order_cancelled':
                        message = `Ordine ${orderId} cancellato`;
                        break;
                    default:
                        // Fallback: use original message or create one based on status
                        if (notification.message) {
                            message = notification.message;
                        } else {
                            message = `Aggiornamento ordine ${orderId} - ${status}`;
                        }
                }

                return {
                    message: message,
                    orderId: orderId,
                    userName: userName,
                    riderName: riderName,
                    status: status,
                    timestamp: notification.createdAt
                };
                
            } catch (error) {
                console.error('âŒ Error formatting notification message:', error);
                return {
                    message: notification.message || 'Notifica ordine',
                    orderId: notification.relatedId || 'N/A',
                    userName: 'Cliente',
                    riderName: null,
                    status: 'unknown',
                    timestamp: notification.createdAt
                };
            }
        }

        // Helper function to get time ago string
        function getTimeAgo(timestamp) {
            try {
                const now = new Date();
                const time = new Date(timestamp);
                const diffInMinutes = Math.floor((now - time) / (1000 * 60));
                
                if (diffInMinutes < 1) return 'Ora';
                if (diffInMinutes < 60) return `${diffInMinutes}m fa`;
                
                const diffInHours = Math.floor(diffInMinutes / 60);
                if (diffInHours < 24) return `${diffInHours}h fa`;
                
                const diffInDays = Math.floor(diffInHours / 24);
                if (diffInDays < 7) return `${diffInDays}g fa`;
                
                return time.toLocaleDateString('it-IT');
            } catch (error) {
                return 'N/A';
            }
        }

        // Helper function to get status badge classes
        function getStatusBadgeClasses(status) {
            const classes = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'accepted': 'bg-blue-100 text-blue-800',
                'preparing': 'bg-blue-100 text-blue-800',
                'ready': 'bg-green-100 text-green-800',
                'delivered': 'bg-gray-100 text-gray-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        // Helper function to get status text
        function getStatusText(status) {
            const texts = {
                'pending': 'In Attesa',
                'accepted': 'Accettato',
                'preparing': 'In Preparazione',
                'ready': 'Pronto',
                'delivered': 'Consegnato',
                'cancelled': 'Cancellato'
            };
            return texts[status] || status;
        }

        // Function to switch between notification tabs
        function showNotificationTab(tabName) {
            // Update tab appearance
            const notificationsTab = document.getElementById('notifications-tab');
            const ordersTab = document.getElementById('orders-tab');
            const notificationsContent = document.getElementById('notifications-content');
            const ordersContent = document.getElementById('orders-content');
            const notificationsActions = document.getElementById('notifications-actions');
            const ordersActions = document.getElementById('orders-actions');
            
            if (tabName === 'notifications') {
                // Show notifications tab
                notificationsTab.className = 'flex-1 py-2 px-4 text-center border-b-2 border-blue-500 text-blue-600 font-medium';
                ordersTab.className = 'flex-1 py-2 px-4 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                notificationsContent.classList.remove('hidden');
                ordersContent.classList.add('hidden');
                if (notificationsActions) notificationsActions.classList.remove('hidden');
                if (ordersActions) ordersActions.classList.add('hidden');
            } else if (tabName === 'orders') {
                // Show orders tab
                notificationsTab.className = 'flex-1 py-2 px-4 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                ordersTab.className = 'flex-1 py-2 px-4 text-center border-b-2 border-blue-500 text-blue-600 font-medium';
                notificationsContent.classList.add('hidden');
                ordersContent.classList.remove('hidden');
                if (notificationsActions) notificationsActions.classList.add('hidden');
                if (ordersActions) ordersActions.classList.remove('hidden');
            }
        }

        // Function to accept order from notification center
        function acceptOrderFromNotification(orderId) {
            acceptOrder(orderId);
            // Close notification center and refresh
            setTimeout(() => {
                document.querySelector('.fixed')?.remove();
                updateNotificationBell();
            }, 1000);
        }

        // Function to reject order from notification center
        function rejectOrderFromNotification(orderId) {
            rejectOrder(orderId);
            // Close notification center and refresh
            setTimeout(() => {
                document.querySelector('.fixed')?.remove();
                updateNotificationBell();
            }, 1000);
        }

        // Function to view order details from notification center
        function viewOrderDetails(orderId) {
            // Close notification center
            document.querySelector('.fixed')?.remove();
            // Navigate to orders section
            showPharmacySection('orders');
            // Highlight the specific order
            setTimeout(() => {
                const orderElement = document.querySelector(`[data-order-id="${orderId}"]`);
                if (orderElement) {
                    orderElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    orderElement.classList.add('ring-2', 'ring-blue-500', 'ring-opacity-50');
                    setTimeout(() => {
                        orderElement.classList.remove('ring-2', 'ring-blue-500', 'ring-opacity-50');
                    }, 3000);
                }
            }, 500);
        }

        // Expose the new functions globally
        window.showNotificationTab = showNotificationTab;
        window.acceptOrderFromNotification = acceptOrderFromNotification;
        window.rejectOrderFromNotification = rejectOrderFromNotification;
        window.viewOrderDetails = viewOrderDetails;

        // Mark a single notification as read
        function markNotificationRead(notificationId) {
            if (typeof Database !== 'undefined' && typeof Database.markNotificationAsRead === 'function') {
                Database.markNotificationAsRead(notificationId);
                // Refresh notification center
                document.querySelector('.fixed')?.remove();
                showNotificationCenter();
                // Update notification bell
                updateNotificationBell();
            }
        }

        // Mark all notifications as read
        function markAllNotificationsRead() {
            if (typeof Database !== 'undefined') {
                const currentUser = window.EudoraApp.currentUser;
                if (currentUser) {
                    const notifications = Database.getNotifications(currentUser.id, false);
                    notifications.forEach(notif => {
                        if (!notif.isRead) {
                            Database.markNotificationAsRead(notif.id);
                        }
                    });
                    // Close modal and update bell
                    document.querySelector('.fixed')?.remove();
                    updateNotificationBell();
                    pharmacyNotificationManager.success('Notifiche', 'Tutte le notifiche sono state segnate come lette');
                }
            }
        }

        // Mark all order notifications as read
        function markAllOrderNotificationsRead() {
            if (typeof Database !== 'undefined') {
                const currentUser = window.EudoraApp.currentUser;
                if (currentUser) {
                    const orderNotifications = getOrderNotifications();
                    orderNotifications.forEach(notif => {
                        if (!notif.read) {
                            Database.markNotificationAsRead(notif.id);
                        }
                    });
                    // Close modal and update bell
                    document.querySelector('.fixed')?.remove();
                    updateNotificationBell();
                    pharmacyNotificationManager.success('Notifiche Ordini', 'Tutte le notifiche ordini sono state segnate come lette');
                }
            }
        }

        // Temporary function to fix missing pharmacy associations in sample data
        function fixPharmacyAssociations() {
            console.log('ðŸ”§ Fixing pharmacy associations in sample data...');
            
            try {
                const currentUser = window.EudoraApp.currentUser;
                if (!currentUser || currentUser.role !== 'pharmacy') {
                    console.log('âŒ Current user is not a pharmacy');
                    return;
                }

                const pharmacyId = currentUser.id;
                console.log('ðŸ”§ Fixing associations for pharmacy ID:', pharmacyId);

                // Fix products - assign ALL products to current pharmacy for demo
                const allProducts = Database.getAllProducts();
                console.log('ðŸ”§ Total products found:', allProducts.length);
                
                let fixedProducts = 0;
                allProducts.forEach(product => {
                    // For demo purposes, assign ALL products to current pharmacy
                    if (!product.pharmacyId || product.pharmacyId !== pharmacyId) {
                        console.log('ðŸ”§ Assigning product to current pharmacy:', product.name);
                        try {
                            Database.updateProduct(product.id, { 
                                pharmacyId: pharmacyId,
                                pharmacyName: currentUser.businessName || currentUser.name || `${currentUser.firstName} ${currentUser.lastName}`
                            });
                            fixedProducts++;
                        } catch (error) {
                            console.warn('âš ï¸ Failed to update product:', product.name, error.message);
                        }
                    }
                });

                // Fix orders - assign ALL orders to current pharmacy for demo
                const allOrders = Database.getAllOrders();
                console.log('ðŸ”§ Total orders found:', allOrders.length);
                
                let fixedOrders = 0;
                allOrders.forEach(order => {
                    // For demo purposes, assign ALL orders to current pharmacy
                    if (!order.pharmacyId || order.pharmacyId !== pharmacyId) {
                        console.log('ðŸ”§ Assigning order to current pharmacy:', order.id);
                        try {
                            Database.updateOrder(order.id, { 
                                pharmacyId: pharmacyId,
                                pharmacyName: currentUser.businessName || currentUser.name || `${currentUser.firstName} ${currentUser.lastName}`
                            });
                            fixedOrders++;
                        } catch (error) {
                            console.warn('âš ï¸ Failed to update order:', order.id, error.message);
                        }
                    }
                });

                console.log(`ðŸ”§ Fixed ${fixedProducts} products and ${fixedOrders} orders`);
                
                if (fixedProducts > 0 || fixedOrders > 0) {
                    pharmacyNotificationManager.success(
                        'Dati Riparati', 
                        `Assegnati ${fixedProducts} prodotti e ${fixedOrders} ordini alla farmacia`
                    );
                    
                    // Reload data after a short delay
                    setTimeout(() => {
                        loadPharmacyProducts();
                        loadPharmacyOrders();
                    }, 1000);
                } else {
                    console.log('ðŸ”§ No data needed fixing');
                    
                    // If no data was fixed but we still have 0 products/orders, show all products/orders
                    const currentProducts = Database.getProducts({ pharmacyId: pharmacyId });
                    const currentOrders = Database.getOrdersByPharmacy(pharmacyId);
                    
                    if (currentProducts.length === 0 && allProducts.length > 0) {
                        console.log('ðŸ”§ Forcing display of some products for demo...');
                        // Show the first 10 products regardless of pharmacy
                        updatePharmacyProductsDisplay(allProducts.slice(0, 10));
                    }
                    
                    if (currentOrders.length === 0 && allOrders.length > 0) {
                        console.log('ðŸ”§ Forcing display of some orders for demo...');
                        // Show the first 10 orders regardless of pharmacy
                        updatePharmacyOrdersDisplay(allOrders.slice(0, 10));
                        updateNotificationBell(allOrders.slice(0, 10));
                    }
                }

            } catch (error) {
                console.error('âŒ Error fixing pharmacy associations:', error);
                pharmacyNotificationManager.error('Errore', `Errore nella riparazione dati: ${error.message}`);
            }
        }

        // Expose the fix function globally for manual use
        window.fixPharmacyAssociations = fixPharmacyAssociations;

        // Diagnostic function to show database contents
        function diagnosticCheck() {
            console.log('ðŸ” === DIAGNOSTIC CHECK ===');
            
            const currentUser = window.EudoraApp.currentUser;
            console.log('ðŸ‘¤ Current user:', currentUser);
            
            const allUsers = Database.getAllUsers();
            console.log('ðŸ‘¥ All users:', allUsers.length);
            const pharmacies = allUsers.filter(u => u.role === 'pharmacy');
            console.log('ðŸ‘¥ Pharmacies:', pharmacies);
            console.log('ðŸ‘¥ Pharmacy IDs:', pharmacies.map(p => p.id));
            
            const allProducts = Database.getAllProducts();
            console.log('ðŸ’Š All products:', allProducts.length);
            if (allProducts.length > 0) {
                console.log('ðŸ’Š Sample products with pharmacy info:', allProducts.slice(0, 5).map(p => ({
                    name: p.name,
                    pharmacyId: p.pharmacyId,
                    pharmacyName: p.pharmacyName
                })));
                
                // Show unique pharmacy IDs in products
                const productPharmacyIds = [...new Set(allProducts.map(p => p.pharmacyId).filter(id => id))];
                console.log('ðŸ’Š Unique pharmacy IDs in products:', productPharmacyIds);
            }
            
            const allOrders = Database.getAllOrders();
            console.log('ðŸ“¦ All orders:', allOrders.length);
            if (allOrders.length > 0) {
                console.log('ðŸ“¦ Sample orders with pharmacy info:', allOrders.slice(0, 5).map(o => ({
                    id: o.id,
                    pharmacyId: o.pharmacyId,
                    pharmacyName: o.pharmacyName,
                    status: o.status
                })));
                
                // Show unique pharmacy IDs in orders
                const orderPharmacyIds = [...new Set(allOrders.map(o => o.pharmacyId).filter(id => id))];
                console.log('ðŸ“¦ Unique pharmacy IDs in orders:', orderPharmacyIds);
            }
            
            // Check specific pharmacy data
            if (currentUser) {
                const pharmacyProducts = Database.getProducts({ pharmacyId: currentUser.id });
                const pharmacyOrders = Database.getOrdersByPharmacy(currentUser.id);
                console.log(`ðŸŽ¯ Current pharmacy (${currentUser.id}) products:`, pharmacyProducts.length);
                console.log(`ðŸŽ¯ Current pharmacy (${currentUser.id}) orders:`, pharmacyOrders.length);
                
                // Check if any products/orders exist with matching pharmacy ID
                const productsWithThisPharmacy = allProducts.filter(p => p.pharmacyId === currentUser.id || p.pharmacyId === currentUser.id.toString());
                const ordersWithThisPharmacy = allOrders.filter(o => o.pharmacyId === currentUser.id || o.pharmacyId === currentUser.id.toString());
                console.log(`ðŸ” Products with current pharmacy ID (manual check):`, productsWithThisPharmacy.length);
                console.log(`ðŸ” Orders with current pharmacy ID (manual check):`, ordersWithThisPharmacy.length);
            }
            
            console.log('ðŸ” === END DIAGNOSTIC ===');
        }

        // Expose diagnostic function
        window.diagnosticCheck = diagnosticCheck;

        // Function to clear localStorage and reset data
        function clearAndResetData() {
            console.log('ðŸ§¹ Clearing all localStorage data...');
            
            try {
                // Clear all Eudora data from localStorage
                const keys = [
                    'eudora_users', 'eudora_products', 'eudora_orders', 
                    'eudora_cart', 'eudora_notifications', 'eudora_settings', 
                    'eudora_inventory', 'currentUser'
                ];
                
                keys.forEach(key => {
                    localStorage.removeItem(key);
                    console.log(`ðŸ—‘ï¸ Removed ${key}`);
                });
                
                pharmacyNotificationManager.success('Pulizia Completata', 'Tutti i dati sono stati rimossi. Ricarica la pagina per rigenerare i dati demo.');
                
                // Optionally reload the page after a delay
                setTimeout(() => {
                    if (confirm('Vuoi ricaricare la pagina per rigenerare i dati demo?')) {
                        window.location.reload();
                    }
                }, 2000);
                
            } catch (error) {
                console.error('âŒ Error clearing localStorage:', error);
                pharmacyNotificationManager.error('Errore', `Errore nella pulizia dati: ${error.message}`);
            }
        }

        // Expose the clear function
        window.clearAndResetData = clearAndResetData;

        // Function to check localStorage usage
        function checkStorageUsage() {
            console.log('ðŸ“Š === STORAGE USAGE CHECK ===');
            
            try {
                let totalSize = 0;
                const sizes = {};
                
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        const size = localStorage[key].length;
                        sizes[key] = size;
                        totalSize += size;
                    }
                }
                
                console.log('ðŸ“Š Individual key sizes:', sizes);
                console.log('ðŸ“Š Total localStorage size:', totalSize, 'characters');
                console.log('ðŸ“Š Estimated size:', Math.round(totalSize / 1024), 'KB');
                
                // Check which keys are largest
                const sortedKeys = Object.entries(sizes).sort((a, b) => b[1] - a[1]);
                console.log('ðŸ“Š Largest keys:', sortedKeys.slice(0, 5));
                
                if (totalSize > 5000000) { // ~5MB
                    console.warn('âš ï¸ localStorage is getting full!');
                    pharmacyNotificationManager.warning('Storage Warning', 'Il localStorage sta raggiungendo il limite. Considera di pulire i dati.');
                }
                
            } catch (error) {
                console.error('âŒ Error checking storage:', error);
            }
            
            console.log('ðŸ“Š === END STORAGE CHECK ===');
        }

        // Expose storage check function
        window.checkStorageUsage = checkStorageUsage;

        // Product filtering and sorting functions
        let allPharmacyProducts = []; // Store all products for filtering

        // Save filters to localStorage
        function saveProductFilters() {
            const filters = {
                search: document.getElementById('product-search-pharmacy')?.value || '',
                category: document.getElementById('filter-category-pharmacy')?.value || '',
                priceMin: document.getElementById('filter-price-min')?.value || '',
                priceMax: document.getElementById('filter-price-max')?.value || '',
                timePeriod: document.getElementById('filter-time-period')?.value || '',
                sortBy: document.getElementById('filter-sort-by')?.value || 'name'
            };
            
            try {
                localStorage.setItem('pharmacy_product_filters', JSON.stringify(filters));
                console.log('ðŸ’¾ Product filters saved:', filters);
            } catch (error) {
                console.warn('âš ï¸ Could not save product filters:', error);
            }
        }

        // Load filters from localStorage
        function loadProductFilters() {
            try {
                const savedFilters = localStorage.getItem('pharmacy_product_filters');
                if (savedFilters) {
                    const filters = JSON.parse(savedFilters);
                    console.log('ðŸ“‚ Loading saved product filters:', filters);
                    
                    // Restore filter values
                    const searchInput = document.getElementById('product-search-pharmacy');
                    const categorySelect = document.getElementById('filter-category-pharmacy');
                    const priceMinInput = document.getElementById('filter-price-min');
                    const priceMaxInput = document.getElementById('filter-price-max');
                    const timePeriodSelect = document.getElementById('filter-time-period');
                    const sortBySelect = document.getElementById('filter-sort-by');

                    if (searchInput) searchInput.value = filters.search || '';
                    if (categorySelect) categorySelect.value = filters.category || '';
                    if (priceMinInput) priceMinInput.value = filters.priceMin || '';
                    if (priceMaxInput) priceMaxInput.value = filters.priceMax || '';
                    if (timePeriodSelect) timePeriodSelect.value = filters.timePeriod || '';
                    if (sortBySelect) sortBySelect.value = filters.sortBy || 'name';
                    
                    return filters;
                }
            } catch (error) {
                console.warn('âš ï¸ Could not load product filters:', error);
            }
            return null;
        }

        // Save order filters to localStorage
        function saveOrderFilters() {
            const filters = {
                search: document.getElementById('order-search-pharmacy')?.value || '',
                status: document.getElementById('filter-order-status')?.value || '',
                totalMin: document.getElementById('filter-order-total-min')?.value || '',
                totalMax: document.getElementById('filter-order-total-max')?.value || '',
                timePeriod: document.getElementById('filter-order-time-period')?.value || '',
                sortBy: document.getElementById('filter-order-sort-by')?.value || 'created-desc'
            };
            
            try {
                localStorage.setItem('pharmacy_order_filters', JSON.stringify(filters));
                console.log('ðŸ’¾ Order filters saved:', filters);
            } catch (error) {
                console.warn('âš ï¸ Could not save order filters:', error);
            }
        }

        // Load order filters from localStorage
        function loadOrderFilters() {
            try {
                const savedFilters = localStorage.getItem('pharmacy_order_filters');
                if (savedFilters) {
                    const filters = JSON.parse(savedFilters);
                    console.log('ðŸ“‚ Loading saved order filters:', filters);
                    
                    // Restore filter values
                    const searchInput = document.getElementById('order-search-pharmacy');
                    const statusSelect = document.getElementById('filter-order-status');
                    const totalMinInput = document.getElementById('filter-order-total-min');
                    const totalMaxInput = document.getElementById('filter-order-total-max');
                    const timePeriodSelect = document.getElementById('filter-order-time-period');
                    const sortBySelect = document.getElementById('filter-order-sort-by');

                    if (searchInput) searchInput.value = filters.search || '';
                    if (statusSelect) statusSelect.value = filters.status || '';
                    if (totalMinInput) totalMinInput.value = filters.totalMin || '';
                    if (totalMaxInput) totalMaxInput.value = filters.totalMax || '';
                    if (timePeriodSelect) timePeriodSelect.value = filters.timePeriod || '';
                    if (sortBySelect) sortBySelect.value = filters.sortBy || 'created-desc';
                    
                    return filters;
                }
            } catch (error) {
                console.warn('âš ï¸ Could not load order filters:', error);
            }
            return null;
        }

        function applyProductFilters() {
            console.log('ðŸ” Applying product filters...');
            
            try {
                // Get current filters
                const searchTerm = document.getElementById('product-search-pharmacy')?.value?.toLowerCase() || '';
                const categoryFilter = document.getElementById('filter-category-pharmacy')?.value || '';
                const statusFilter = document.getElementById('filter-status-pharmacy')?.value || '';
                const priceMin = parseFloat(document.getElementById('filter-price-min')?.value) || 0;
                const priceMax = parseFloat(document.getElementById('filter-price-max')?.value) || Infinity;
                const timePeriod = document.getElementById('filter-time-period')?.value || '';
                const sortBy = document.getElementById('filter-sort-by')?.value || 'name';

                console.log('ðŸ” Applied filters:', { searchTerm, categoryFilter, statusFilter, priceMin, priceMax, timePeriod, sortBy });

                // Save current filters to localStorage
                saveProductFilters();

                // Get Farmacia Centrale products stored in window variable
                let filteredProducts = [];
                if (window.allPharmacyProducts && Array.isArray(window.allPharmacyProducts)) {
                    filteredProducts = [...window.allPharmacyProducts];
                } else {
                    console.warn('âš ï¸ No pharmacy products loaded, trying to load from database...');
                    // Fallback: try to load from database
                    const farmacyCentraleUser = Database.getUserByEmail('farmacia.centrale@email.com');
                    if (farmacyCentraleUser) {
                        const allProducts = Database.getAllProducts();
                        filteredProducts = allProducts.filter(product => 
                            product.pharmacyId === farmacyCentraleUser.id
                        );
                        window.allPharmacyProducts = filteredProducts;
                    } else {
                        console.error('âŒ Could not find Farmacia Centrale products');
                        return;
                    }
                }

                console.log('ðŸ“¦ Starting with Farmacia Centrale products:', filteredProducts.length);

                // Apply search filter
                if (searchTerm) {
                    filteredProducts = filteredProducts.filter(product => 
                        product.name.toLowerCase().includes(searchTerm) ||
                        product.description?.toLowerCase().includes(searchTerm) ||
                        product.id.toString().includes(searchTerm) ||
                        product.sku?.toLowerCase().includes(searchTerm) ||
                        product.manufacturer?.toLowerCase().includes(searchTerm)
                    );
                }

                // Apply category filter
                if (categoryFilter) {
                    filteredProducts = filteredProducts.filter(product => 
                        product.category === categoryFilter
                    );
                }

                // Apply status filter
                if (statusFilter) {
                    filteredProducts = filteredProducts.filter(product => {
                        switch (statusFilter) {
                            case 'active':
                                return product.isActive !== false && (product.stock > 0);
                            case 'out-of-stock':
                                return product.isActive !== false && (product.stock === 0);
                            case 'inactive':
                                return product.isActive === false;
                            default:
                                return true;
                        }
                    });
                }

                // Apply price filter
                filteredProducts = filteredProducts.filter(product => 
                    product.price >= priceMin && product.price <= priceMax
                );

                // Apply time period filter
                if (timePeriod) {
                    const now = new Date();
                    let startDate;

                    switch (timePeriod) {
                        case 'today':
                            startDate = new Date(now);
                            startDate.setHours(0, 0, 0, 0);
                            break;
                        case 'week':
                            startDate = new Date(now);
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case 'month':
                            startDate = new Date(now);
                            startDate.setMonth(now.getMonth() - 1);
                            break;
                        case 'quarter':
                            startDate = new Date(now);
                            startDate.setMonth(now.getMonth() - 3);
                            break;
                        case 'year':
                            startDate = new Date(now);
                            startDate.setFullYear(now.getFullYear() - 1);
                            break;
                    }

                    if (startDate) {
                        filteredProducts = filteredProducts.filter(product => {
                            const productDate = new Date(product.createdAt || product.dateAdded || Date.now());
                            return productDate >= startDate;
                        });
                    }
                }

                // Apply sorting
                filteredProducts.sort((a, b) => {
                    switch (sortBy) {
                        case 'name':
                            return a.name.localeCompare(b.name);
                        case 'name-desc':
                            return b.name.localeCompare(a.name);
                        case 'price':
                            return a.price - b.price;
                        case 'price-desc':
                            return b.price - a.price;
                        case 'created':
                            return new Date(a.createdAt || a.dateAdded || 0) - new Date(b.createdAt || b.dateAdded || 0);
                        case 'created-desc':
                            return new Date(b.createdAt || b.dateAdded || 0) - new Date(a.createdAt || a.dateAdded || 0);
                        case 'stock':
                            return (a.stock || 0) - (b.stock || 0);
                        case 'stock-desc':
                            return (b.stock || 0) - (a.stock || 0);
                        default:
                            return 0;
                    }
                });

                console.log(`ðŸ” Filtered from ${allPharmacyProducts.length} to ${filteredProducts.length} products`);

                // Update display
                updatePharmacyProductsDisplay(filteredProducts);
                
                // Show filter status
                const filterCount = getActiveFilterCount();
                updateProductFilterStatus(filterCount);
                if (filterCount > 0) {
                    pharmacyNotificationManager.info(
                        'Filtri Applicati', 
                        `${filteredProducts.length} prodotti trovati con ${filterCount} filtri attivi`
                    );
                }

            } catch (error) {
                console.error('âŒ Error applying filters:', error);
                pharmacyNotificationManager.error('Errore Filtri', `Errore nell'applicazione dei filtri: ${error.message}`);
            }
        }

        function clearProductFilters() {
            console.log('ðŸ§¹ Clearing product filters...');
            
            try {
                // Reset all filter inputs
                const searchInput = document.getElementById('product-search-pharmacy');
                const categorySelect = document.getElementById('filter-category-pharmacy');
                const priceMinInput = document.getElementById('filter-price-min');
                const priceMaxInput = document.getElementById('filter-price-max');
                const timePeriodSelect = document.getElementById('filter-time-period');
                const sortBySelect = document.getElementById('filter-sort-by');

                if (searchInput) searchInput.value = '';
                if (categorySelect) categorySelect.value = '';
                if (priceMinInput) priceMinInput.value = '';
                if (priceMaxInput) priceMaxInput.value = '';
                if (timePeriodSelect) timePeriodSelect.value = '';
                if (sortBySelect) sortBySelect.value = 'name';

                // Clear saved filters from localStorage
                try {
                    localStorage.removeItem('pharmacy_product_filters');
                    console.log('ðŸ—‘ï¸ Cleared saved product filters');
                } catch (error) {
                    console.warn('âš ï¸ Could not clear saved product filters:', error);
                }

                // Reapply filters (which will now show all products)
                applyProductFilters();

                pharmacyNotificationManager.success('Filtri Rimossi', 'Tutti i filtri sono stati rimossi');

            } catch (error) {
                console.error('âŒ Error clearing filters:', error);
                pharmacyNotificationManager.error('Errore', `Errore nella rimozione dei filtri: ${error.message}`);
            }
        }

        function getActiveFilterCount() {
            let count = 0;
            
            const searchTerm = document.getElementById('product-search-pharmacy')?.value || '';
            const categoryFilter = document.getElementById('filter-category-pharmacy')?.value || '';
            const priceMin = document.getElementById('filter-price-min')?.value || '';
            const priceMax = document.getElementById('filter-price-max')?.value || '';
            const timePeriod = document.getElementById('filter-time-period')?.value || '';
            const sortBy = document.getElementById('filter-sort-by')?.value || '';

            if (searchTerm) count++;
            if (categoryFilter) count++;
            if (priceMin) count++;
            if (priceMax) count++;
            if (timePeriod) count++;
            if (sortBy && sortBy !== 'name') count++; // default is 'name', so only count if changed

            return count;
        }

        function updateProductFilterStatus(activeCount, isRestored = false) {
            const statusIndicator = document.getElementById('product-filter-status');
            if (statusIndicator) {
                if (activeCount > 0) {
                    statusIndicator.style.display = 'inline-flex';
                    statusIndicator.classList.add('active');
                    if (isRestored) {
                        statusIndicator.classList.add('restored');
                    } else {
                        statusIndicator.classList.remove('restored');
                    }
                    statusIndicator.innerHTML = `
                        <i class="fas fa-filter"></i>
                        <span>${activeCount} filtri attivi${isRestored ? ' (ripristinati)' : ''}</span>
                        <span class="filter-count-badge">${activeCount}</span>
                    `;
                } else {
                    statusIndicator.style.display = 'none';
                    statusIndicator.classList.remove('active', 'restored');
                }
            }
        }

        // Enhanced loadPharmacyProducts function to store products for filtering
        const originalLoadPharmacyProducts = loadPharmacyProducts;
        loadPharmacyProducts = function() {
            const products = originalLoadPharmacyProducts();
            if (products && products.length > 0) {
                allPharmacyProducts = products;
                console.log(`ðŸ” Stored ${allPharmacyProducts.length} products for filtering`);
            }
            return products;
        };

        // Enhanced updatePharmacyProductsDisplay function to handle filtered results count
        const originalUpdatePharmacyProductsDisplay = updatePharmacyProductsDisplay;
        updatePharmacyProductsDisplay = function(products) {
            originalUpdatePharmacyProductsDisplay(products);
            
            // Update count information for filtered results
            setTimeout(() => {
                const productsCountSpan = document.getElementById('pharmacy-products-count');
                const totalProductsSpan = document.getElementById('pharmacy-total-products');
                
                if (productsCountSpan && products) {
                    const showing = Math.min(products.length, 10); // Assuming we show max 10 per page
                    const total = (window.allPharmacyProducts && window.allPharmacyProducts.length) || products.length;
                    
                    if (products.length === total) {
                        productsCountSpan.textContent = `Mostrando 1-${showing} di ${total} prodotti`;
                    } else {
                        productsCountSpan.textContent = `Mostrando 1-${showing} di ${products.length} prodotti filtrati (${total} totali)`;
                    }
                }
            }, 100); // Small delay to ensure the original function has completed
        };

        // Add keyboard shortcuts for filters
        document.addEventListener('keydown', function(event) {
            // Ctrl/Cmd + F to focus search
            if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
                event.preventDefault();
                const searchInput = document.getElementById('product-search-pharmacy');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }
            
            // Escape to clear filters
            if (event.key === 'Escape') {
                const activeElement = document.activeElement;
                if (activeElement && (
                    activeElement.id === 'product-search-pharmacy' ||
                    activeElement.id === 'filter-category-pharmacy' ||
                    activeElement.id === 'filter-price-min' ||
                    activeElement.id === 'filter-price-max' ||
                    activeElement.id === 'filter-time-period' ||
                    activeElement.id === 'filter-sort-by'
                )) {
                    clearProductFilters();
                }
            }
        });

        // Expose filter functions globally
        window.applyProductFilters = applyProductFilters;
        window.clearProductFilters = clearProductFilters;

        // Order filtering and sorting functions
        let allPharmacyOrders = []; // Store all orders for filtering

        function getActiveOrderFilterCount() {
            let count = 0;
            
            const searchTerm = document.getElementById('order-search-pharmacy')?.value || '';
            const statusFilter = document.getElementById('filter-order-status')?.value || '';
            const totalMin = document.getElementById('filter-order-total-min')?.value || '';
            const totalMax = document.getElementById('filter-order-total-max')?.value || '';
            const timePeriod = document.getElementById('filter-order-time-period')?.value || '';
            const sortBy = document.getElementById('filter-order-sort-by')?.value || '';

            if (searchTerm) count++;
            if (statusFilter) count++;
            if (totalMin) count++;
            if (totalMax) count++;
            if (timePeriod) count++;
            if (sortBy && sortBy !== 'created-desc') count++; // default is 'created-desc'

            return count;
        }

        function applyOrderFilters() {
            console.log('ðŸ” Applying order filters...');
            
            try {
                // Get current filters
                const searchTerm = document.getElementById('order-search-pharmacy')?.value?.toLowerCase() || '';
                const statusFilter = document.getElementById('filter-order-status')?.value || '';
                const totalMin = parseFloat(document.getElementById('filter-order-total-min')?.value) || 0;
                const totalMax = parseFloat(document.getElementById('filter-order-total-max')?.value) || Infinity;
                const timePeriod = document.getElementById('filter-order-time-period')?.value || '';
                const sortBy = document.getElementById('filter-order-sort-by')?.value || 'created-desc';

                console.log('ðŸ” Applied order filters:', { searchTerm, statusFilter, totalMin, totalMax, timePeriod, sortBy });

                // Save current filters to localStorage
                saveOrderFilters();

                // Start with all pharmacy orders
                let filteredOrders = [...allPharmacyOrders];

                // Apply search filter
                if (searchTerm) {
                    filteredOrders = filteredOrders.filter(order => 
                        order.id.toString().includes(searchTerm) ||
                        (order.customerName && order.customerName.toLowerCase().includes(searchTerm)) ||
                        (order.customerPhone && order.customerPhone.includes(searchTerm)) ||
                        (formatDeliveryAddress(order.deliveryAddress).toLowerCase().includes(searchTerm)) ||
                        (order.notes && order.notes.toLowerCase().includes(searchTerm))
                    );
                }

                // Apply status filter
                if (statusFilter) {
                    filteredOrders = filteredOrders.filter(order => 
                        order.status === statusFilter
                    );
                }

                // Apply total filter
                filteredOrders = filteredOrders.filter(order => 
                    order.total >= totalMin && order.total <= totalMax
                );

                // Apply time period filter
                if (timePeriod) {
                    const now = new Date();
                    let startDate;

                    switch (timePeriod) {
                        case 'today':
                            startDate = new Date(now);
                            startDate.setHours(0, 0, 0, 0);
                            break;
                        case 'week':
                            startDate = new Date(now);
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case 'month':
                            startDate = new Date(now);
                            startDate.setMonth(now.getMonth() - 1);
                            break;
                        case 'quarter':
                            startDate = new Date(now);
                            startDate.setMonth(now.getMonth() - 3);
                            break;
                        case 'year':
                            startDate = new Date(now);
                            startDate.setFullYear(now.getFullYear() - 1);
                            break;
                    }

                    if (startDate) {
                        filteredOrders = filteredOrders.filter(order => {
                            const orderDate = new Date(order.createdAt);
                            return orderDate >= startDate;
                        });
                    }
                }

                // Apply sorting
                filteredOrders.sort((a, b) => {
                    switch (sortBy) {
                        case 'created':
                            return new Date(a.createdAt) - new Date(b.createdAt);
                        case 'created-desc':
                            return new Date(b.createdAt) - new Date(a.createdAt);
                        case 'total':
                            return a.total - b.total;
                        case 'total-desc':
                            return b.total - a.total;
                        case 'status':
                            return a.status.localeCompare(b.status);
                        case 'customer':
                            return (a.customerName || '').localeCompare(b.customerName || '');
                        default:
                            return 0;
                    }
                });

                console.log(`ðŸ” Filtered from ${allPharmacyOrders.length} to ${filteredOrders.length} orders`);

                // Update display
                updatePharmacyOrdersDisplay(filteredOrders);
                
                // Update notification bell with filtered orders
                updateNotificationBell(filteredOrders);
                
                // Show filter status
                const filterCount = getActiveOrderFilterCount();
                updateOrderFilterStatus(filterCount);
                if (filterCount > 0) {
                    pharmacyNotificationManager.info(
                        'Filtri Applicati', 
                        `${filteredOrders.length} ordini trovati con ${filterCount} filtri attivi`
                    );
                }

            } catch (error) {
                console.error('âŒ Error applying order filters:', error);
                pharmacyNotificationManager.error('Errore Filtri', `Errore nell'applicazione dei filtri ordini: ${error.message}`);
            }
        }

        function clearOrderFilters() {
            console.log('ðŸ§¹ Clearing order filters...');
            
            try {
                // Reset all filter inputs
                const searchInput = document.getElementById('order-search-pharmacy');
                const statusSelect = document.getElementById('filter-order-status');
                const totalMinInput = document.getElementById('filter-order-total-min');
                const totalMaxInput = document.getElementById('filter-order-total-max');
                const timePeriodSelect = document.getElementById('filter-order-time-period');
                const sortBySelect = document.getElementById('filter-order-sort-by');

                if (searchInput) searchInput.value = '';
                if (statusSelect) statusSelect.value = '';
                if (totalMinInput) totalMinInput.value = '';
                if (totalMaxInput) totalMaxInput.value = '';
                if (timePeriodSelect) timePeriodSelect.value = '';
                if (sortBySelect) sortBySelect.value = 'created-desc';

                // Clear saved filters from localStorage
                try {
                    localStorage.removeItem('pharmacy_order_filters');
                    console.log('ðŸ—‘ï¸ Cleared saved order filters');
                } catch (error) {
                    console.warn('âš ï¸ Could not clear saved order filters:', error);
                }

                // Reapply filters (which will now show all orders)
                applyOrderFilters();

                pharmacyNotificationManager.success('Filtri Rimossi', 'Tutti i filtri ordini sono stati rimossi');

            } catch (error) {
                console.error('âŒ Error clearing order filters:', error);
                pharmacyNotificationManager.error('Errore', `Errore nella rimozione dei filtri ordini: ${error.message}`);
            }
        }

        function getActiveOrderFilterCount() {
            let count = 0;
            
            const searchTerm = document.getElementById('order-search-pharmacy')?.value || '';
            const statusFilter = document.getElementById('filter-order-status')?.value || '';
            const totalMin = document.getElementById('filter-order-total-min')?.value || '';
            const totalMax = document.getElementById('filter-order-total-max')?.value || '';
            const timePeriod = document.getElementById('filter-order-time-period')?.value || '';
            const sortBy = document.getElementById('filter-order-sort-by')?.value || '';

            if (searchTerm) count++;
            if (statusFilter) count++;
            if (totalMin) count++;
            if (totalMax) count++;
            if (timePeriod) count++;
            if (sortBy && sortBy !== 'created-desc') count++; // default is 'created-desc'

            return count;
        }

        function updateOrderFilterStatus(activeCount, isRestored = false) {
            const statusIndicator = document.getElementById('order-filter-status');
            if (statusIndicator) {
                if (activeCount > 0) {
                    statusIndicator.style.display = 'inline-flex';
                    statusIndicator.classList.add('active');
                    if (isRestored) {
                        statusIndicator.classList.add('restored');
                    } else {
                        statusIndicator.classList.remove('restored');
                    }
                    statusIndicator.innerHTML = `
                        <i class="fas fa-filter"></i>
                        <span>${activeCount} filtri attivi${isRestored ? ' (ripristinati)' : ''}</span>
                        <span class="filter-count-badge">${activeCount}</span>
                    `;
                } else {
                    statusIndicator.style.display = 'none';
                    statusIndicator.classList.remove('active', 'restored');
                }
            }
        }

        // Enhanced loadPharmacyOrders function to store orders for filtering
        const originalLoadPharmacyOrders = loadPharmacyOrders;
        loadPharmacyOrders = function() {
            const orders = originalLoadPharmacyOrders();
            if (orders && orders.length > 0) {
                allPharmacyOrders = orders;
                console.log(`ðŸ” Stored ${allPharmacyOrders.length} orders for filtering`);
            }
            return orders;
        };

        // Enhanced updatePharmacyOrdersDisplay function to handle filtered results
        const originalUpdatePharmacyOrdersDisplay = updatePharmacyOrdersDisplay;
        updatePharmacyOrdersDisplay = function(orders) {
            originalUpdatePharmacyOrdersDisplay(orders);
            
            // Show filtered count in console
            if (orders && allPharmacyOrders.length > 0) {
                const total = allPharmacyOrders.length;
                if (orders.length !== total) {
                    console.log(`ðŸ“Š Showing ${orders.length} of ${total} orders (filtered)`);
                }
            }
        };

        // Expose order filter functions globally
        window.applyOrderFilters = applyOrderFilters;
        window.clearOrderFilters = clearOrderFilters;

        // ===== PRODUCT MANAGEMENT FUNCTIONS =====

        // Global variables for product management
        let allPharmacyProductsForManagement = []; // Store all products for filtering
        let currentProductPage = 1;
        const productsPerPage = 20;
        let isEditingProduct = false;

        // Product form submission handler
        document.addEventListener('DOMContentLoaded', function() {
            const productForm = document.getElementById('pharmacy-product-form');
            if (productForm) {
                productForm.addEventListener('submit', handleProductFormSubmit);
            }
        });

        function handleProductFormSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const productData = {};
            
            // Convert FormData to object
            for (let [key, value] of formData.entries()) {
                if (key === 'requiresPrescription') {
                    productData[key] = document.getElementById('product-prescription').checked;
                } else if (key === 'price' || key === 'stock') {
                    productData[key] = parseFloat(value) || 0;
                } else {
                    productData[key] = value;
                }
            }
            
            // Validate required fields
            if (!productData.name || !productData.description || !productData.category) {
                showProductNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            // Auto-generate SKU if not provided
            if (!productData.sku) {
                productData.sku = Pharmacy.generateProductSku(productData.category, productData.name);
            }
            
            // Set default values
            productData.isActive = true;
            
            try {
                const editId = document.getElementById('product-edit-id').value;
                const submitButtonText = document.getElementById('product-form-submit-text').textContent;
                
                console.log('ðŸ” Form submission debug:', {
                    editId: editId,
                    isEditingProduct: isEditingProduct,
                    hasEditId: !!editId,
                    editIdType: typeof editId,
                    editIdLength: editId ? editId.length : 0,
                    submitButtonText: submitButtonText,
                    formTitle: document.getElementById('product-form-title').textContent
                });
                
                // Check if we're in edit mode - use multiple indicators
                const isEditing = (editId && editId.trim() !== '' && isEditingProduct) || 
                                 submitButtonText.includes('Salva Modifiche') ||
                                 document.getElementById('product-form-title').textContent.includes('Modifica');
                
                if (isEditing) {
                    console.log('âœï¸ Updating existing product:', editId);
                    
                    if (!editId || editId.trim() === '') {
                        throw new Error('ID prodotto non valido per l\'aggiornamento');
                    }
                    
                    // Update existing product using Pharmacy module
                    const updatedProduct = Pharmacy.updateProduct(editId, productData);
                    showProductNotification(`Prodotto "${updatedProduct.name}" aggiornato con successo`, 'success');
                    cancelProductEdit();
                } else {
                    console.log('âž• Creating new product');
                    // Create new product using Pharmacy module
                    const newProduct = Pharmacy.createProduct(productData);
                    showProductNotification(`Prodotto "${newProduct.name}" creato con successo`, 'success');
                    // Reset form after successful creation
                    resetProductForm();
                }
                
                // Reload products list
                loadPharmacyProductsForManagement();
                
            } catch (error) {
                console.error('Error saving product:', error);
                showProductNotification('Errore durante il salvataggio del prodotto: ' + error.message, 'error');
            }
        }

        // Reset product form
        function resetProductForm() {
            const form = document.getElementById('pharmacy-product-form');
            if (form) {
                form.reset();
                document.getElementById('product-edit-id').value = '';
                document.getElementById('product-form-title').textContent = 'Aggiungi Nuovo Prodotto';
                document.getElementById('product-form-submit-text').textContent = 'Aggiungi Prodotto';
                document.getElementById('cancel-edit-btn').classList.add('hidden');
                isEditingProduct = false;
                
                // Remove editing styling
                const formContainer = form.closest('.bg-white');
                if (formContainer) {
                    formContainer.classList.remove('product-form-container', 'editing');
                }
            }
        }

        // Edit product - pre-fill form
        function editProduct(productId) {
            console.log('âœï¸ Starting edit for product:', productId);
            
            const product = Database.getProductById(productId);
            if (!product || !product.isActive) {
                showProductNotification('Prodotto non trovato o non attivo', 'error');
                return;
            }
            
            console.log('ðŸ“ Product found for editing:', product);
            
            // Fill form fields
            document.getElementById('product-name').value = product.name || '';
            document.getElementById('product-price').value = product.price || '';
            document.getElementById('product-stock').value = product.stock || '';
            document.getElementById('product-category').value = product.category || '';
            document.getElementById('product-sku').value = product.sku || '';
            document.getElementById('product-manufacturer').value = product.manufacturer || '';
            document.getElementById('product-expiry').value = product.expiryDate || '';
            document.getElementById('product-batch').value = product.batchNumber || '';
            document.getElementById('product-image').value = product.imageUrl || '';
            document.getElementById('product-description').value = product.description || '';
            document.getElementById('product-prescription').checked = product.requiresPrescription || false;
            
            // Set edit mode
            document.getElementById('product-edit-id').value = productId;
            document.getElementById('product-form-title').textContent = `Modifica Prodotto: ${product.name}`;
            document.getElementById('product-form-submit-text').textContent = 'Salva Modifiche';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            isEditingProduct = true;
            
            console.log('âœ… Edit mode set:', {
                editId: document.getElementById('product-edit-id').value,
                isEditingProduct: isEditingProduct,
                submitButtonText: document.getElementById('product-form-submit-text').textContent
            });
            
            // Add editing styling
            const form = document.getElementById('pharmacy-product-form');
            const formContainer = form.closest('.bg-white');
            if (formContainer) {
                formContainer.classList.add('product-form-container', 'editing');
            }
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            showProductNotification(`Modifica del prodotto "${product.name}" in corso`, 'info');
        }

        // Cancel product edit
        function cancelProductEdit() {
            resetProductForm();
            showProductNotification('Modifica annullata', 'info');
        }

        // Delete product (soft delete)
        function deleteProduct(productId) {
            const product = Database.getProductById(productId);
            if (!product) {
                showProductNotification('Prodotto non trovato', 'error');
                return;
            }
            
            if (confirm(`Sei sicuro di voler eliminare il prodotto "${product.name}"?`)) {
                try {
                    Database.updateProduct(productId, { isActive: false });
                    showProductNotification(`Prodotto "${product.name}" eliminato con successo`, 'success');
                    loadPharmacyProductsForManagement();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showProductNotification('Errore durante l\'eliminazione del prodotto', 'error');
                }
            }
        }

        // Toggle product stock status
        function toggleProductStock(productId) {
            const product = Database.getProductById(productId);
            if (!product) {
                showProductNotification('Prodotto non trovato', 'error');
                return;
            }
            
            const currentlyAvailable = product.stock > 0;
            const newStock = currentlyAvailable ? 0 : 1;
            
            try {
                Database.updateProduct(productId, { 
                    stock: newStock
                });
                
                const statusText = newStock > 0 ? 'abilitato' : 'disabilitato';
                showProductNotification(`Prodotto "${product.name}" ${statusText}`, 'success');
                loadPharmacyProductsForManagement();
            } catch (error) {
                console.error('Error toggling product stock:', error);
                showProductNotification('Errore durante l\'aggiornamento del prodotto', 'error');
            }
        }

        // Load products for management (enhanced version of loadPharmacyProducts)
        function loadPharmacyProductsForManagement() {
            console.log('ðŸ’Š Loading products for management...');
            
            // Check if user is pharmacy or if we're in demo mode
            if (!EudoraApp.currentUser) {
                console.log('âŒ No user found, checking for demo mode...');
                // Try to load demo data for management interface
                if (typeof Database !== 'undefined') {
                    const allProducts = Database.getAllProductsIncludingInactive() || [];
                    allPharmacyProductsForManagement = allProducts;
                    console.log(`ðŸ’Š Loaded ${allPharmacyProductsForManagement.length} demo products for management (including inactive)`);
                    applyProductFilters();
                    return;
                } else {
                    console.log('âŒ No Database module available');
                    return;
                }
            }
            
            if (EudoraApp.currentUser.role !== 'pharmacy') {
                console.log('âŒ User is not a pharmacy, role:', EudoraApp.currentUser.role);
                // Still allow management interface with all products for demo purposes
                try {
                    if (typeof Database !== 'undefined') {
                        const allProducts = Database.getAllProducts() || [];
                        allPharmacyProductsForManagement = allProducts;
                        console.log(`ðŸ’Š Loaded ${allPharmacyProductsForManagement.length} products for management (demo mode)`);
                        applyProductFilters();
                        return;
                    }
                } catch (error) {
                    console.warn('âš ï¸ Error loading demo products:', error);
                }
                return;
            }
            
            const pharmacyId = EudoraApp.currentUser.pharmacyId || EudoraApp.currentUser.id;
            
            try {
                // Get all products for this pharmacy (including inactive ones for management)
                const allProducts = Database.getAllProductsIncludingInactive() || [];
                allPharmacyProductsForManagement = allProducts.filter(product => 
                    product.pharmacyId === pharmacyId || product.pharmacyId === EudoraApp.currentUser.id
                );
                
                console.log(`ðŸ’Š Loaded ${allPharmacyProductsForManagement.length} products for management (including inactive)`);
                
                // Update products count badge
                updateProductsCountBadge(allPharmacyProductsForManagement.filter(p => p.isActive).length);
                
                // Apply current filters
                applyProductFilters();
                
            } catch (error) {
                console.warn('âš ï¸ Error loading products for management:', error.message);
                allPharmacyProductsForManagement = [];
                updateProductsDisplay([]);
            }
        }

        // Update products count badge
        function updateProductsCountBadge(count) {
            const badge = document.getElementById('pharmacy-products-count');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // Apply product filters
        function applyProductFilters() {
            let filteredProducts = [...allPharmacyProductsForManagement];
            
            // Search filter
            const searchTerm = document.getElementById('product-search-pharmacy')?.value.toLowerCase().trim();
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.sku?.toLowerCase().includes(searchTerm) ||
                    product.manufacturer?.toLowerCase().includes(searchTerm) ||
                    product.description?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Category filter (multi-select)
            const categorySelect = document.getElementById('filter-product-categories');
            if (categorySelect) {
                const selectedCategories = Array.from(categorySelect.selectedOptions).map(option => option.value);
                if (selectedCategories.length > 0) {
                    filteredProducts = filteredProducts.filter(product => 
                        selectedCategories.includes(product.category)
                    );
                }
            }
            
            // Price filters
            const minPrice = parseFloat(document.getElementById('filter-product-price-min')?.value) || 0;
            const maxPrice = parseFloat(document.getElementById('filter-product-price-max')?.value) || Infinity;
            filteredProducts = filteredProducts.filter(product => 
                product.price >= minPrice && product.price <= maxPrice
            );
            
            // Stock filters
            const minStock = parseInt(document.getElementById('filter-product-stock-min')?.value) || 0;
            const maxStock = parseInt(document.getElementById('filter-product-stock-max')?.value) || Infinity;
            filteredProducts = filteredProducts.filter(product => 
                product.stock >= minStock && product.stock <= maxStock
            );
            
            // Availability filter
            const availability = document.getElementById('filter-product-availability')?.value;
            if (availability) {
                switch (availability) {
                    case 'available':
                        filteredProducts = filteredProducts.filter(product => window.Pharmacy?.getProductAvailability(product) || (product.isActive && product.stock > 0));
                        break;
                    case 'unavailable':
                        filteredProducts = filteredProducts.filter(product => !(window.Pharmacy?.getProductAvailability(product) || (product.isActive && product.stock > 0)));
                        break;
                    case 'low-stock':
                        filteredProducts = filteredProducts.filter(product => product.isActive && product.stock > 0 && product.stock < 10);
                        break;
                }
            }
            
            // Prescription filter
            const prescription = document.getElementById('filter-product-prescription')?.value;
            if (prescription) {
                const requiresPrescription = prescription === 'required';
                filteredProducts = filteredProducts.filter(product => 
                    product.requiresPrescription === requiresPrescription
                );
            }
            
            // Status filter (active/inactive)
            const status = document.getElementById('filter-product-status')?.value;
            if (status) {
                switch (status) {
                    case 'active':
                        filteredProducts = filteredProducts.filter(product => product.isActive);
                        break;
                    case 'inactive':
                        filteredProducts = filteredProducts.filter(product => !product.isActive);
                        break;
                }
            }
            
            // Sort products
            const sortBy = document.getElementById('filter-product-sort-by')?.value || 'name';
            filteredProducts.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'price':
                        return a.price - b.price;
                    case 'price-desc':
                        return b.price - a.price;
                    case 'stock':
                        return a.stock - b.stock;
                    case 'stock-desc':
                        return b.stock - a.stock;
                    case 'created':
                        return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
                    case 'created-desc':
                        return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                    default:
                        return 0;
                }
            });
            
            // Reset to first page when applying filters
            currentProductPage = 1;
            
            // Update display with pagination
            updateProductsDisplayWithPagination(filteredProducts);
            
            // Update filter status
            updateProductFilterStatus();
        }
            
            // Category filter (multi-select)
            const categorySelect = document.getElementById('filter-product-categories');
            if (categorySelect) {
                const selectedCategories = Array.from(categorySelect.selectedOptions).map(option => option.value);
                if (selectedCategories.length > 0) {
                    filteredProducts = filteredProducts.filter(product => 
                        selectedCategories.includes(product.category)
                    );
                }
            }
            
            // Price filters
            const minPrice = parseFloat(document.getElementById('filter-product-price-min')?.value) || 0;
            const maxPrice = parseFloat(document.getElementById('filter-product-price-max')?.value) || Infinity;
            filteredProducts = filteredProducts.filter(product => 
                product.price >= minPrice && product.price <= maxPrice
            );
            
            // Stock filters
            const minStock = parseInt(document.getElementById('filter-product-stock-min')?.value) || 0;
            const maxStock = parseInt(document.getElementById('filter-product-stock-max')?.value) || Infinity;
            filteredProducts = filteredProducts.filter(product => 
                product.stock >= minStock && product.stock <= maxStock
            );
            
            // Availability filter
            const availability = document.getElementById('filter-product-availability')?.value;
            if (availability) {
                switch (availability) {
                    case 'available':
                        filteredProducts = filteredProducts.filter(product => product.stock > 0);
                        break;
                    case 'unavailable':
                        filteredProducts = filteredProducts.filter(product => product.stock === 0);
                        break;
                    case 'low-stock':
                        filteredProducts = filteredProducts.filter(product => product.stock > 0 && product.stock < 10);
                        break;
                }
            }
            
            // Prescription filter
            const prescription = document.getElementById('filter-product-prescription')?.value;
            if (prescription) {
                const requiresPrescription = prescription === 'required';
                filteredProducts = filteredProducts.filter(product => 
                    product.requiresPrescription === requiresPrescription
                );
            }
            
            // Status filter (active/inactive)
            const status = document.getElementById('filter-product-status')?.value;
            if (status) {
                switch (status) {
                    case 'active':
                        filteredProducts = filteredProducts.filter(product => product.isActive);
                        break;
                    case 'inactive':
                        filteredProducts = filteredProducts.filter(product => !product.isActive);
                        break;
                }
            }
            
            // Sort products
            const sortBy = document.getElementById('filter-product-sort-by')?.value || 'name';
            filteredProducts.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'price':
                        return a.price - b.price;
                    case 'price-desc':
                        return b.price - a.price;
                    case 'stock':
                        return a.stock - b.stock;
                    case 'stock-desc':
                        return b.stock - a.stock;
                    case 'created':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'created-desc':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    default:
                        return 0;
                }
            });
            
            // Reset to first page when applying filters
            currentProductPage = 1;
            
            // Update display with pagination
            updateProductsDisplayWithPagination(filteredProducts);
            
            // Update filter status
            updateProductFilterStatus();
        

        // Update products display with pagination
        function updateProductsDisplayWithPagination(products) {
            const startIndex = (currentProductPage - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            const paginatedProducts = products.slice(startIndex, endIndex);
            
            updateProductsDisplay(paginatedProducts);
            updateProductPagination(products.length);
        }

        // Update products display
        function updateProductsDisplay(products) {
            const container = document.getElementById('pharmacy-products-list');
            if (!container) return;
            
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-pills text-4xl mb-3"></i>
                        <p>Nessun prodotto trovato</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = products.map(product => createProductCard(product)).join('');
        }

        // Create product card HTML
        function createProductCard(product) {
            const stockStatus = getProductStockStatus(product);
            const cardClass = getProductCardClass(product);
            
            return `
                <div class="product-card ${cardClass}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="font-semibold text-lg text-gray-800">${product.name}</h4>
                            <p class="text-gray-600 text-sm">${product.description}</p>
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${createProductTags(product)}
                            </div>
                        </div>
                        <div class="text-right ml-4">
                            <div class="text-xl font-bold text-gray-800">â‚¬${product.price.toFixed(2)}</div>
                            <div class="text-sm ${stockStatus.color}">${stockStatus.text}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4 bg-gray-50 p-3 rounded">
                        <div>
                            <span class="text-gray-500 block">SKU:</span>
                            <span class="font-medium">${product.sku || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="text-gray-500 block">Stock:</span>
                            <span class="font-medium">${product.stock} pz</span>
                        </div>
                        <div>
                            <span class="text-gray-500 block">Produttore:</span>
                            <span class="font-medium">${product.manufacturer || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="text-gray-500 block">Scadenza:</span>
                            <span class="font-medium">${product.expiryDate ? new Date(product.expiryDate).toLocaleDateString('it-IT') : 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-gray-500">
                            ID: ${product.id}${product.batchNumber ? ` â€¢ Lotto: ${product.batchNumber}` : ''}
                        </div>
                        <div class="product-actions">
                            ${product.isActive ? `
                                <button onclick="editProduct('${product.id}')" class="product-action-btn product-action-edit">
                                    <i class="fas fa-edit"></i>Modifica
                                </button>
                                <button onclick="toggleProductStock('${product.id}')" class="product-action-btn product-action-toggle">
                                    <i class="fas fa-${product.stock > 0 ? 'eye-slash' : 'eye'}"></i>
                                    ${product.stock > 0 ? 'Disabilita' : 'Abilita'}
                                </button>
                                <button onclick="deleteProduct('${product.id}')" class="product-action-btn product-action-delete">
                                    <i class="fas fa-trash"></i>Elimina
                                </button>
                            ` : `
                                <span class="text-red-500 text-sm italic">Prodotto eliminato</span>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        // Get product stock status
        function getProductStockStatus(product) {
            if (!product.isActive) {
                return { text: 'Eliminato', color: 'text-red-600' };
            } else if (product.stock === 0) {
                return { text: 'Non disponibile', color: 'text-red-600' };
            } else if (product.stock < 10) {
                return { text: 'Scorte basse', color: 'text-yellow-600' };
            } else {
                return { text: 'Disponibile', color: 'text-green-600' };
            }
        }

        // Get product card class
        function getProductCardClass(product) {
            if (!product.isActive) {
                return 'product-card-inactive';
            } else if (product.stock === 0) {
                return 'product-card-inactive';
            } else if (product.stock < 10) {
                return 'product-card-low-stock';
            } else {
                return 'product-card-active';
            }
        }

        // Create product tags
        function createProductTags(product) {
            const tags = [];
            
            // Category tag
            if (product.categoryName) {
                tags.push(`<span class="product-tag product-tag-category">${product.categoryName}</span>`);
            }
            
            // Prescription tag
            if (product.requiresPrescription) {
                tags.push(`<span class="product-tag product-tag-prescription">Ricetta richiesta</span>`);
            } else {
                tags.push(`<span class="product-tag product-tag-no-prescription">Senza ricetta</span>`);
            }
            
            // Stock tag
            if (product.isActive) {
                if (product.stock === 0) {
                    tags.push(`<span class="product-tag product-tag-stock-out">Esaurito</span>`);
                } else if (product.stock < 10) {
                    tags.push(`<span class="product-tag product-tag-stock-low">Scorte basse</span>`);
                } else {
                    tags.push(`<span class="product-tag product-tag-stock-ok">Disponibile</span>`);
                }
            }
            
            return tags.join('');
        }

        // Update product pagination
        function updateProductPagination(totalProducts) {
            const container = document.getElementById('product-pagination');
            if (!container) return;
            
            const totalPages = Math.ceil(totalProducts / productsPerPage);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let paginationHTML = `
                <button onclick="goToProductPage(${currentProductPage - 1})" 
                        class="pagination-btn ${currentProductPage === 1 ? 'disabled' : ''}"
                        ${currentProductPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Page numbers
            const startPage = Math.max(1, currentProductPage - 2);
            const endPage = Math.min(totalPages, currentProductPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button onclick="goToProductPage(1)" class="pagination-btn">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="pagination-info">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button onclick="goToProductPage(${i})" 
                            class="pagination-btn ${i === currentProductPage ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="pagination-info">...</span>`;
                }
                paginationHTML += `<button onclick="goToProductPage(${totalPages})" class="pagination-btn">${totalPages}</button>`;
            }
            
            paginationHTML += `
                <button onclick="goToProductPage(${currentProductPage + 1})" 
                        class="pagination-btn ${currentProductPage === totalPages ? 'disabled' : ''}"
                        ${currentProductPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            const startItem = (currentProductPage - 1) * productsPerPage + 1;
            const endItem = Math.min(currentProductPage * productsPerPage, totalProducts);
            
            paginationHTML += `<span class="pagination-info">Mostra ${startItem}-${endItem} di ${totalProducts}</span>`;
            
            container.innerHTML = paginationHTML;
        }

        // Go to specific product page
        function goToProductPage(page) {
            const totalPages = Math.ceil(allPharmacyProductsForManagement.length / productsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentProductPage = page;
            applyProductFilters();
        }

        // Clear product filters
        function clearProductFilters() {
            document.getElementById('product-search-pharmacy').value = '';
            document.getElementById('filter-product-categories').selectedIndex = -1;
            document.getElementById('filter-product-price-min').value = '';
            document.getElementById('filter-product-price-max').value = '';
            document.getElementById('filter-product-stock-min').value = '';
            document.getElementById('filter-product-stock-max').value = '';
            document.getElementById('filter-product-availability').value = '';
            document.getElementById('filter-product-prescription').value = '';
            document.getElementById('filter-product-status').value = '';
            document.getElementById('filter-product-sort-by').value = 'name';
            
            currentProductPage = 1;
            applyProductFilters();
            saveProductFilters();
        }

        // Save product filters to localStorage
        function saveProductFilters() {
            const filters = {
                search: document.getElementById('product-search-pharmacy')?.value || '',
                categories: Array.from(document.getElementById('filter-product-categories')?.selectedOptions || []).map(o => o.value),
                priceMin: document.getElementById('filter-product-price-min')?.value || '',
                priceMax: document.getElementById('filter-product-price-max')?.value || '',
                stockMin: document.getElementById('filter-product-stock-min')?.value || '',
                stockMax: document.getElementById('filter-product-stock-max')?.value || '',
                availability: document.getElementById('filter-product-availability')?.value || '',
                prescription: document.getElementById('filter-product-prescription')?.value || '',
                status: document.getElementById('filter-product-status')?.value || '',
                sortBy: document.getElementById('filter-product-sort-by')?.value || 'name'
            };
            
            try {
                localStorage.setItem('pharmacy_product_filters', JSON.stringify(filters));
            } catch (error) {
                console.warn('Could not save product filters:', error);
            }
        }

        // Load product filters from localStorage
        function loadProductFilters() {
            try {
                const saved = localStorage.getItem('pharmacy_product_filters');
                if (saved) {
                    const filters = JSON.parse(saved);
                    
                    // Safely set values with null checks
                    const searchInput = document.getElementById('product-search-pharmacy');
                    if (searchInput) searchInput.value = filters.search || '';
                    
                    const categorySelect = document.getElementById('filter-product-categories');
                    if (categorySelect && filters.categories) {
                        Array.from(categorySelect.options).forEach(option => {
                            option.selected = filters.categories.includes(option.value);
                        });
                    }
                    
                    const priceMinInput = document.getElementById('filter-product-price-min');
                    if (priceMinInput) priceMinInput.value = filters.priceMin || '';
                    
                    const priceMaxInput = document.getElementById('filter-product-price-max');
                    if (priceMaxInput) priceMaxInput.value = filters.priceMax || '';
                    
                    const stockMinInput = document.getElementById('filter-product-stock-min');
                    if (stockMinInput) stockMinInput.value = filters.stockMin || '';
                    
                    const stockMaxInput = document.getElementById('filter-product-stock-max');
                    if (stockMaxInput) stockMaxInput.value = filters.stockMax || '';
                    
                    const availabilitySelect = document.getElementById('filter-product-availability');
                    if (availabilitySelect) availabilitySelect.value = filters.availability || '';
                    
                    const prescriptionSelect = document.getElementById('filter-product-prescription');
                    if (prescriptionSelect) prescriptionSelect.value = filters.prescription || '';
                    
                    const statusSelect = document.getElementById('filter-product-status');
                    if (statusSelect) statusSelect.value = filters.status || '';
                    
                    const sortBySelect = document.getElementById('filter-product-sort-by');
                    if (sortBySelect) sortBySelect.value = filters.sortBy || 'name';
                    
                    return true;
                }
            } catch (error) {
                console.warn('Could not load product filters:', error);
            }
            return false;
        }

        // Update product filter status
        function updateProductFilterStatus() {
            const statusElement = document.getElementById('product-filter-status');
            if (!statusElement) return;
            
            const activeFilters = getActiveProductFilterCount();
            
            if (activeFilters > 0) {
                statusElement.style.display = 'inline-flex';
                statusElement.querySelector('span').textContent = `${activeFilters} filtri attivi`;
            } else {
                statusElement.style.display = 'none';
            }
        }

        // Get active product filter count
        function getActiveProductFilterCount() {
            let count = 0;
            
            if (document.getElementById('product-search-pharmacy')?.value.trim()) count++;
            if (document.getElementById('filter-product-categories')?.selectedOptions.length > 0) count++;
            if (document.getElementById('filter-product-price-min')?.value) count++;
            if (document.getElementById('filter-product-price-max')?.value) count++;
            if (document.getElementById('filter-product-stock-min')?.value) count++;
            if (document.getElementById('filter-product-stock-max')?.value) count++;
            if (document.getElementById('filter-product-availability')?.value) count++;
            if (document.getElementById('filter-product-prescription')?.value) count++;
            if (document.getElementById('filter-product-status')?.value) count++;
            
            return count;
        }

        // CSV Import/Export Functions
        function showProductCsvImportModal() {
            const modal = document.createElement('div');
            modal.className = 'csv-modal';
            modal.innerHTML = `
                <div class="csv-modal-content">
                    <h3 class="text-lg font-semibold mb-4">Importa Prodotti da CSV</h3>
                    
                    <div class="csv-upload-area" onclick="document.getElementById('csv-file-input').click()">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 mb-2">Clicca per selezionare un file CSV o trascinalo qui</p>
                        <p class="text-sm text-gray-500">Formato: name,price,description,requiresPrescription,stock,imageUrl,category,categoryName,sku,manufacturer,expiryDate,batchNumber</p>
                    </div>
                    
                    <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
                    
                    <div id="csv-preview" style="display: none;" class="mt-4">
                        <h4 class="font-medium mb-2">Anteprima dati:</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table id="csv-preview-table" class="csv-preview-table">
                                <thead id="csv-preview-header"></thead>
                                <tbody id="csv-preview-body"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        <button onclick="this.closest('.csv-modal').remove()" class="filter-button secondary flex-1">
                            Annulla
                        </button>
                        <button id="import-csv-btn" onclick="importProductsFromCsv()" class="filter-button primary flex-1" disabled>
                            <i class="fas fa-upload mr-1"></i>Importa Prodotti
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Setup file input handler
            const fileInput = document.getElementById('csv-file-input');
            fileInput.addEventListener('change', handleCsvFileSelect);
            
            // Setup drag and drop
            const uploadArea = modal.querySelector('.csv-upload-area');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'text/csv') {
                    handleCsvFile(files[0]);
                }
            });
        }

        let csvData = null;

        function handleCsvFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                handleCsvFile(file);
            } else {
                showProductNotification('Seleziona un file CSV valido', 'error');
            }
        }

        function handleCsvFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                csvData = parseCsv(csv);
                displayCsvPreview(csvData);
                document.getElementById('import-csv-btn').disabled = false;
            };
            reader.readAsText(file);
        }

        function parseCsv(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            if (lines.length < 2) return null;
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    data.push(row);
                }
            }
            
            return { headers, data };
        }

        function displayCsvPreview(csvData) {
            if (!csvData) return;
            
            const preview = document.getElementById('csv-preview');
            const header = document.getElementById('csv-preview-header');
            const body = document.getElementById('csv-preview-body');
            
            // Show preview
            preview.style.display = 'block';
            
            // Create header
            header.innerHTML = `<tr>${csvData.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            
            // Create body (show only first 5 rows)
            const previewRows = csvData.data.slice(0, 5);
            body.innerHTML = previewRows.map(row => 
                `<tr>${csvData.headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`
            ).join('');
        }

        function importProductsFromCsv() {
            if (!csvData || !csvData.data) {
                showProductNotification('Nessun dato da importare', 'error');
                return;
            }
            
            let imported = 0;
            let errors = 0;
            
            csvData.data.forEach((row, index) => {
                try {
                    const productData = {
                        name: row.name || `Prodotto ${index + 1}`,
                        price: parseFloat(row.price) || 0,
                        description: row.description || '',
                        requiresPrescription: row.requiresPrescription === 'true' || row.requiresPrescription === '1',
                        stock: parseInt(row.stock) || 0,
                        imageUrl: row.imageUrl || '',
                        category: row.category || 'analgesici',
                        categoryName: row.categoryName || getCategoryName(row.category || 'analgesici'),
                        sku: row.sku || generateProductSku(row.category || 'analgesici', row.name || `Prodotto ${index + 1}`),
                        manufacturer: row.manufacturer || '',
                        expiryDate: row.expiryDate || '',
                        batchNumber: row.batchNumber || '',
                        pharmacyId: EudoraApp.currentUser.pharmacyId || EudoraApp.currentUser.id,
                        pharmacyName: EudoraApp.currentUser.businessName || EudoraApp.currentUser.firstName + ' ' + EudoraApp.currentUser.lastName,
                        isActive: row.isActive !== 'false' && row.isActive !== '0'
                    };
                    
                    Database.createProduct(productData);
                    imported++;
                } catch (error) {
                    console.error(`Error importing row ${index + 1}:`, error);
                    errors++;
                }
            });
            
            // Close modal
            document.querySelector('.csv-modal').remove();
            
            // Show result
            if (errors === 0) {
                showProductNotification(`${imported} prodotti importati con successo`, 'success');
            } else {
                showProductNotification(`${imported} prodotti importati, ${errors} errori`, 'warning');
            }
            
            // Reload products
            loadPharmacyProductsForManagement();
        }

        function exportProductsToCsv() {
            if (!allPharmacyProductsForManagement || allPharmacyProductsForManagement.length === 0) {
                showProductNotification('Nessun prodotto da esportare', 'warning');
                return;
            }
            
            // CSV headers
            const headers = [
                'name', 'price', 'description', 'requiresPrescription', 'stock', 
                'imageUrl', 'category', 'categoryName', 'sku', 'manufacturer', 
                'expiryDate', 'batchNumber', 'isActive', 'id', 'createdAt'
            ];
            
            // CSV content
            let csvContent = headers.join(',') + '\n';
            
            allPharmacyProductsForManagement.forEach(product => {
                const row = headers.map(header => {
                    let value = product[header] || '';
                    // Escape commas and quotes
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvContent += row.join(',') + '\n';
            });
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `prodotti_farmacia_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showProductNotification(`${allPharmacyProductsForManagement.length} prodotti esportati`, 'success');
        }

        // Product notification function
        function showProductNotification(message, type = 'info') {
            if (typeof pharmacyNotificationManager !== 'undefined') {
                pharmacyNotificationManager.show(message, type);
            } else {
                console.log(`${type.toUpperCase()}: ${message}`);
                alert(message);
            }
        }

        // Initialize product management when products section is shown
        function initializeProductManagement() {
            console.log('ðŸ’Š Initializing product management...');
            
            // Load saved filters safely
            try {
                loadProductFilters();
            } catch (error) {
                console.warn('âš ï¸ Error loading product filters:', error);
            }
            
            // Load products for management
            try {
                loadPharmacyProductsForManagement();
            } catch (error) {
                console.warn('âš ï¸ Error loading products for management:', error);
                // Fallback to basic product loading
                loadPharmacyProducts();
            }
            
            console.log('ðŸ’Š Product management initialized');
        }

        // Product form functions
        function resetProductForm() {
            const form = document.getElementById('pharmacy-product-form');
            if (form) {
                form.reset();
                document.getElementById('product-edit-id').value = '';
                document.getElementById('product-form-title').textContent = 'Aggiungi Nuovo Prodotto';
                document.getElementById('product-form-submit-text').textContent = 'Aggiungi Prodotto';
                document.getElementById('cancel-edit-btn').classList.add('hidden');
            }
        }

        function editProduct(productId) {
            console.log('âœï¸ Editing product:', productId);
            
            // Find product in current data
            const product = window.allPharmacyProductsForManagement?.find(p => p.id === productId);
            if (!product) {
                pharmacyNotificationManager.error('Errore', 'Prodotto non trovato');
                return;
            }
            
            // Populate form
            document.getElementById('product-edit-id').value = product.id;
            document.getElementById('product-name').value = product.name || '';
            document.getElementById('product-price').value = product.price || '';
            document.getElementById('product-stock').value = product.stock || '';
            document.getElementById('product-category').value = product.category || '';
            document.getElementById('product-sku').value = product.sku || '';
            document.getElementById('product-manufacturer').value = product.manufacturer || '';
            document.getElementById('product-expiry').value = product.expiryDate || '';
            document.getElementById('product-batch').value = product.batchNumber || '';
            document.getElementById('product-image').value = product.imageUrl || '';
            document.getElementById('product-description').value = product.description || '';
            document.getElementById('product-prescription').checked = product.requiresPrescription || false;
            
            // Update form UI
            document.getElementById('product-form-title').textContent = 'Modifica Prodotto';
            document.getElementById('product-form-submit-text').textContent = 'Salva Modifiche';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            // Scroll to form
            document.getElementById('pharmacy-product-form').scrollIntoView({ behavior: 'smooth' });
            
            pharmacyNotificationManager.info('Modifica Prodotto', `Stai modificando: ${product.name}`);
        }

        function cancelProductEdit() {
            resetProductForm();
            pharmacyNotificationManager.info('Modifica Annullata', 'Le modifiche sono state annullate');
        }

        function deleteProduct(productId) {
            if (!confirm('Sei sicuro di voler eliminare questo prodotto?')) {
                return;
            }
            
            console.log('ðŸ—‘ï¸ Deleting product:', productId);
            
            if (typeof Database !== 'undefined' && typeof Database.deleteProduct === 'function') {
                try {
                    Database.deleteProduct(productId);
                    pharmacyNotificationManager.success('Prodotto Eliminato', 'Il prodotto Ã¨ stato eliminato con successo');
                    loadPharmacyProductsForManagement();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    pharmacyNotificationManager.error('Errore', 'Errore durante l\'eliminazione del prodotto');
                }
            } else {
                pharmacyNotificationManager.warning('Funzione Non Disponibile', 'La funzione di eliminazione non Ã¨ disponibile');
            }
        }

        function toggleProductStock(productId) {
            console.log('ðŸ“¦ Toggling stock for product:', productId);
            
            const product = window.allPharmacyProductsForManagement?.find(p => p.id === productId);
            if (!product) {
                pharmacyNotificationManager.error('Errore', 'Prodotto non trovato');
                return;
            }
            
            if (typeof Database !== 'undefined' && typeof Database.updateProduct === 'function') {
                try {
                    const newActiveStatus = !product.isActive;
                    Database.updateProduct(productId, { isActive: newActiveStatus });
                    
                    const statusText = newActiveStatus ? 'attivato' : 'disattivato';
                    pharmacyNotificationManager.success('Stato Prodotto', `Prodotto ${statusText} con successo`);
                    loadPharmacyProductsForManagement();
                } catch (error) {
                    console.error('Error toggling product stock:', error);
                    pharmacyNotificationManager.error('Errore', 'Errore durante la modifica dello stato');
                }
            } else {
                pharmacyNotificationManager.warning('Funzione Non Disponibile', 'La funzione di modifica stato non Ã¨ disponibile');
            }
        }

        // Load products specifically for management interface
        function loadPharmacyProductsForManagement() {
            console.log('ðŸ’Š Loading products for management...');
            
            if (typeof Database === 'undefined') {
                console.warn('âš ï¸ Database not available, using fallback');
                const fallbackProducts = [
                    {
                        id: 'fallback-1',
                        name: 'Paracetamolo 500mg',
                        price: 4.50,
                        stock: 50,
                        category: 'analgesici',
                        categoryName: 'Analgesici e Antinfiammatori',
                        isActive: true,
                        requiresPrescription: false,
                        description: 'Analgesico e antipiretico'
                    }
                ];
                window.allPharmacyProductsForManagement = fallbackProducts;
                updateProductsDisplay(fallbackProducts);
                return fallbackProducts;
            }
            
            try {
                const currentUser = window.EudoraApp.currentUser;
                const pharmacyId = currentUser?.pharmacyId || currentUser?.id || 'demo-pharmacy';
                
                // Use getAllProductsIncludingInactive to show both active and inactive products for management
                const allProducts = Database.getAllProductsIncludingInactive ? 
                    Database.getAllProductsIncludingInactive() : 
                    Database.getAllProducts();
                    
                const pharmacyProducts = allProducts.filter(product => 
                    product.pharmacyId === pharmacyId || 
                    product.pharmacyName === 'Farmacia Centrale'
                );
                
                console.log(`ðŸ’Š Loaded ${pharmacyProducts.length} products for management (including inactive)`);
                
                window.allPharmacyProductsForManagement = pharmacyProducts;
                updateProductsDisplay(pharmacyProducts);
                return pharmacyProducts;
            } catch (error) {
                console.error('Error loading products for management:', error);
                return [];
            }
        }

        // Apply product filters
        function applyProductFilters() {
            if (!window.allPharmacyProductsForManagement) {
                console.warn('âš ï¸ No products data available for filtering');
                return;
            }
            
            let filteredProducts = [...window.allPharmacyProductsForManagement];
            
            // Apply search filter
            const searchTerm = document.getElementById('product-search-pharmacy')?.value?.toLowerCase() || '';
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => 
                    product.name?.toLowerCase().includes(searchTerm) ||
                    product.sku?.toLowerCase().includes(searchTerm) ||
                    product.manufacturer?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply category filter
            const selectedCategories = Array.from(document.getElementById('filter-product-categories')?.selectedOptions || [])
                .map(option => option.value);
            if (selectedCategories.length > 0) {
                filteredProducts = filteredProducts.filter(product => 
                    selectedCategories.includes(product.category)
                );
            }
            
            // Apply price filters
            const priceMin = parseFloat(document.getElementById('filter-product-price-min')?.value) || 0;
            const priceMax = parseFloat(document.getElementById('filter-product-price-max')?.value) || Infinity;
            filteredProducts = filteredProducts.filter(product => 
                product.price >= priceMin && product.price <= priceMax
            );
            
            // Apply stock filters
            const stockMin = parseInt(document.getElementById('filter-product-stock-min')?.value) || 0;
            const stockMax = parseInt(document.getElementById('filter-product-stock-max')?.value) || Infinity;
            filteredProducts = filteredProducts.filter(product => 
                product.stock >= stockMin && product.stock <= stockMax
            );
            
            // Apply availability filter
            const availability = document.getElementById('filter-product-availability')?.value || '';
            if (availability) {
                filteredProducts = filteredProducts.filter(product => {
                    switch (availability) {
                        case 'available': return window.Pharmacy?.getProductAvailability(product) || (product.isActive && product.stock > 0);
                        case 'unavailable': return !(window.Pharmacy?.getProductAvailability(product) || (product.isActive && product.stock > 0));
                        case 'low-stock': return product.stock < 10;
                        default: return true;
                    }
                });
            }
            
            // Apply prescription filter
            const prescription = document.getElementById('filter-product-prescription')?.value || '';
            if (prescription) {
                filteredProducts = filteredProducts.filter(product => {
                    switch (prescription) {
                        case 'required': return product.requiresPrescription;
                        case 'not-required': return !product.requiresPrescription;
                        default: return true;
                    }
                });
            }
            
            // Apply sorting
            const sortBy = document.getElementById('filter-product-sort-by')?.value || 'name';
            filteredProducts.sort((a, b) => {
                switch (sortBy) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'name-desc': return b.name.localeCompare(a.name);
                    case 'price': return a.price - b.price;
                    case 'price-desc': return b.price - a.price;
                    case 'stock': return a.stock - b.stock;
                    case 'stock-desc': return b.stock - a.stock;
                    case 'created': return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'created-desc': return new Date(b.createdAt) - new Date(a.createdAt);
                    default: return 0;
                }
            });
            
            updateProductsDisplay(filteredProducts);
            updateProductFilterStatus();
            saveProductFilters();
        }

        // Clear product filters
        function clearProductFilters() {
            // Clear form inputs
            const elements = [
                'product-search-pharmacy',
                'filter-product-price-min',
                'filter-product-price-max', 
                'filter-product-stock-min',
                'filter-product-stock-max'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            // Clear selects
            const selects = [
                'filter-product-categories',
                'filter-product-availability', 
                'filter-product-prescription',
                'filter-product-status',
                'filter-product-sort-by'
            ];
            
            selects.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (element.multiple) {
                        Array.from(element.options).forEach(option => option.selected = false);
                    } else {
                        element.value = '';
                    }
                }
            });
            
            // Clear from localStorage
            localStorage.removeItem('pharmacy_product_filters');
            
            // Reload all products
            if (window.allPharmacyProductsForManagement) {
                updateProductsDisplay(window.allPharmacyProductsForManagement);
            }
            
            updateProductFilterStatus();
            pharmacyNotificationManager.info('Filtri Ripristinati', 'Tutti i filtri sono stati rimossi');
        }

        // Update products display with enhanced product cards
        function updateProductsDisplay(products) {
            const productsContainer = document.getElementById('pharmacy-products-list');
            if (!productsContainer) {
                console.warn('âš ï¸ Products container not found');
                return;
            }
            
            if (!products || products.length === 0) {
                productsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-pills text-4xl mb-3"></i>
                        <p>Nessun prodotto trovato</p>
                        <p class="text-sm mt-2">Prova a modificare i filtri o aggiungi nuovi prodotti</p>
                    </div>
                `;
                return;
            }
            
            productsContainer.innerHTML = products.map(product => `
                <div class="product-card ${product.isActive ? 'product-card-active' : 'product-card-inactive'} ${product.stock < 10 && product.isActive ? 'product-card-low-stock' : ''}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold ${product.isActive ? 'text-gray-800' : 'text-gray-500'}">${product.name || 'Prodotto senza nome'}</h4>
                            <p class="text-gray-600 text-sm mb-2">${product.description || 'Nessuna descrizione disponibile'}</p>
                            
                            <div class="flex flex-wrap gap-2 mb-2">
                                ${product.requiresPrescription ? '<span class="product-tag product-tag-prescription">Ricetta richiesta</span>' : '<span class="product-tag product-tag-no-prescription">Senza ricetta</span>'}
                                ${product.category ? `<span class="product-tag product-tag-category">${product.categoryName || product.category}</span>` : ''}
                                ${getStockStatusTag(product)}
                            </div>
                        </div>
                        
                        <div class="text-right ml-4">
                            <p class="text-2xl font-bold ${product.isActive ? 'text-green-600' : 'text-gray-400'}">â‚¬${(product.price || 0).toFixed(2)}</p>
                            <p class="text-sm ${product.isActive ? 'text-gray-500' : 'text-gray-400'}">${getStockStatusText(product)}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm ${product.isActive ? 'text-gray-600' : 'text-gray-400'} mb-4">
                        <div><strong>SKU:</strong> ${product.sku || 'N/A'}</div>
                        <div><strong>Stock:</strong> ${product.stock || 0} pz</div>
                        <div><strong>Produttore:</strong> ${product.manufacturer || 'N/A'}</div>
                        <div><strong>Scadenza:</strong> ${product.expiryDate ? new Date(product.expiryDate).toLocaleDateString('it-IT') : 'N/A'}</div>
                    </div>
                    
                    <div class="product-actions">
                        <button onclick="editProduct('${product.id}')" class="product-action-btn product-action-edit ${!product.isActive ? 'opacity-50' : ''}">
                            <i class="fas fa-edit"></i> Modifica
                        </button>
                        <button onclick="toggleProductStock('${product.id}')" class="product-action-btn ${product.isActive ? 'product-action-disable' : 'product-action-enable'}">
                            <i class="fas fa-toggle-${product.isActive ? 'on' : 'off'}"></i> ${product.isActive ? 'Disattiva' : 'Attiva'}
                        </button>
                        <button onclick="deleteProduct('${product.id}')" class="product-action-btn product-action-delete ${!product.isActive ? 'opacity-50' : ''}">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </div>
                    
                    <div class="text-xs ${product.isActive ? 'text-gray-400' : 'text-gray-300'} mt-3 pt-3 border-t">
                        ID: ${product.id}${product.batchNumber ? ` â€¢ Lotto: ${product.batchNumber}` : ''} â€¢ Pharmacy ID: ${product.pharmacyId || 'N/A'}
                        ${!product.isActive ? ' â€¢ PRODOTTO DISATTIVATO' : ''}
                    </div>
                </div>
            `).join('');
        }

        // Helper functions for product display
        function getStockStatusTag(product) {
            if (!product.isActive) {
                return '<span class="product-tag product-tag-inactive">DISATTIVATO</span>';
            } else if (product.stock === 0) {
                return '<span class="product-tag product-tag-stock-out">Esaurito</span>';
            } else if (product.stock < 10) {
                return '<span class="product-tag product-tag-stock-low">Scorte basse</span>';
            } else {
                return '<span class="product-tag product-tag-stock-ok">Disponibile</span>';
            }
        }

        function getStockStatusText(product) {
            if (!product.isActive) {
                return 'Prodotto disattivato';
            } else if (product.stock === 0) {
                return 'Non disponibile';
            } else if (product.stock < 10) {
                return `Scorte basse (${product.stock} rimasti)`;
            } else {
                return `${product.stock} disponibili`;
            }
        }

        function goToProductPage(page) {
            currentProductPage = page;
            applyProductFilters(); // This will re-render with pagination
        }

        // Category name update function
        function updateCategoryName() {
            const categorySelect = document.getElementById('product-category');
            const categoryName = categorySelect.selectedOptions[0]?.text || '';
            console.log('Category updated:', categoryName);
        }

        // Product form submission handler
        document.addEventListener('DOMContentLoaded', function() {
            const productForm = document.getElementById('pharmacy-product-form');
            if (productForm) {
                productForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get form data
                    const formData = new FormData(productForm);
                    const productData = {
                        name: formData.get('name'),
                        price: parseFloat(formData.get('price')),
                        stock: parseInt(formData.get('stock')),
                        category: formData.get('category'),
                        description: formData.get('description'),
                        requiresPrescription: formData.has('requiresPrescription'),
                        sku: formData.get('sku'),
                        manufacturer: formData.get('manufacturer'),
                        expiryDate: formData.get('expiryDate'),
                        batchNumber: formData.get('batchNumber'),
                        imageUrl: formData.get('imageUrl')
                    };
                    
                    // Validate required fields
                    if (!productData.name || !productData.description || productData.price <= 0 || productData.stock < 0) {
                        pharmacyNotificationManager.error('Errore Validazione', 'Compila tutti i campi obbligatori correttamente');
                        return;
                    }
                    
                    const editId = document.getElementById('product-edit-id').value;
                    
                    if (editId) {
                        // Update existing product
                        if (typeof Database !== 'undefined' && typeof Database.updateProduct === 'function') {
                            try {
                                Database.updateProduct(editId, productData);
                                pharmacyNotificationManager.success('Prodotto Aggiornato', 'Le modifiche sono state salvate con successo');
                                resetProductForm();
                                loadPharmacyProductsForManagement();
                            } catch (error) {
                                console.error('Error updating product:', error);
                                pharmacyNotificationManager.error('Errore', 'Errore durante l\'aggiornamento del prodotto');
                            }
                        } else {
                            pharmacyNotificationManager.warning('Funzione Non Disponibile', 'La funzione di aggiornamento non Ã¨ disponibile');
                        }
                    } else {
                        // Create new product
                        if (typeof Database !== 'undefined' && typeof Database.createProduct === 'function') {
                            try {
                                // Add additional fields
                                productData.pharmacyId = window.EudoraApp.currentUser?.pharmacyId || window.EudoraApp.currentUser?.id || 'demo-pharmacy';
                                productData.pharmacyName = window.EudoraApp.currentUser?.businessName || 'Farmacia Centrale';
                                productData.isActive = true;
                                productData.inStock = productData.stock > 0;
                                productData.categoryName = document.getElementById('product-category').selectedOptions[0]?.text || productData.category;
                                
                                // Generate SKU if not provided
                                if (!productData.sku) {
                                    productData.sku = generateProductSku(productData.category, productData.name);
                                }
                                
                                Database.createProduct(productData);
                                pharmacyNotificationManager.success('Prodotto Creato', 'Il nuovo prodotto Ã¨ stato aggiunto con successo');
                                resetProductForm();
                                loadPharmacyProductsForManagement();
                            } catch (error) {
                                console.error('Error creating product:', error);
                                pharmacyNotificationManager.error('Errore', 'Errore durante la creazione del prodotto');
                            }
                        } else {
                            pharmacyNotificationManager.warning('Funzione Non Disponibile', 'La funzione di creazione non Ã¨ disponibile');
                        }
                    }
                });
            }
        });

        // Helper function to generate SKU
        function generateProductSku(category, name) {
            const categoryCode = {
                'analgesici': 'ANA',
                'antibiotici': 'ANT', 
                'vitamine': 'VIT',
                'cosmetica': 'COS',
                'medicazioni': 'MED'
            }[category] || 'GEN';
            
            const nameCode = name.substring(0, 6).toUpperCase().replace(/[^A-Z]/g, '');
            const randomNumber = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            return `${categoryCode}${nameCode}${randomNumber}`;
        }

        // Expose product management functions globally
        window.updateCategoryName = updateCategoryName;
        window.resetProductForm = resetProductForm;
        window.editProduct = editProduct;
        window.cancelProductEdit = cancelProductEdit;
        window.deleteProduct = deleteProduct;
        window.toggleProductStock = toggleProductStock;
        window.loadPharmacyProductsForManagement = loadPharmacyProductsForManagement;
        window.applyProductFilters = applyProductFilters;
        window.clearProductFilters = clearProductFilters;
        window.goToProductPage = goToProductPage;
        window.showProductCsvImportModal = showProductCsvImportModal;
        window.exportProductsToCsv = exportProductsToCsv;
        window.importProductsFromCsv = importProductsFromCsv;
        window.initializeProductManagement = initializeProductManagement;
    </script>
</body>
</html>
